<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Reader with All Features (Single File SW)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mozilla/readability@0.5.0/Readability.min.js"></script>
    <style>
        /* ... ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§æ‡§∞‡•Ä CSS ‡§Ø‡§π‡§æ‡§Å ... */
        :root {
            --bg-color: #f4f7f6; --text-color: #333; --container-bg: #ffffff;
            --primary-color: #007bff; --secondary-color: #17a2b8;
            --border-color: #ddd; --danger-color: #dc3545; --success-color: #28a745;
            --font-size-base: 16px; --line-height-base: 1.6;
        }
        .dark-mode {
            --bg-color: #121212; --text-color: #e0e0e0; --container-bg: #1e1e1e;
            --primary-color: #4dabf7; --secondary-color: #4dd0e1;
            --border-color: #444; --danger-color: #e57373; --success-color: #66bb6a;
        }
        .sepia-mode {
            --bg-color: #f4e8c1; --text-color: #5b4636; --container-bg: #fbf0d9;
            --primary-color: #795548; --secondary-color: #8d6e63;
            --border-color: #d7ccc8; --danger-color: #a1887f; --success-color: #7cb342;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            line-height: var(--line-height-base); transition: background-color 0.3s, color 0.3s;
            margin: 0; padding-top: 5px;
        }
        #progress-bar { position: fixed; top: 0; left: 0; height: 5px; background: var(--primary-color); width: 0%; z-index: 9999; transition: width 0.1s; }
        .main-container { max-width: 800px; margin: 20px auto; padding: 20px; background-color: var(--container-bg); border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1, h2, h3 { color: var(--primary-color); }
        .tabs { border-bottom: 2px solid var(--border-color); overflow: hidden; margin-bottom: 20px; display: flex; flex-wrap: wrap; }
        .tab-link { background: transparent; border: none; cursor: pointer; padding: 14px 16px; font-size: 17px; color: var(--text-color); border-bottom: 3px solid transparent; }
        .tab-link.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: bold; }
        input[type="url"], input[type="search"], input[type="text"], select { background-color: var(--container-bg); color: var(--text-color); border: 1px solid var(--border-color); width: 100%; padding: 12px; box-sizing: border-box; border-radius: 6px; font-size: 16px; margin-top: 10px; }
        button.tool-btn, .tool-btn-secondary { background-color: var(--primary-color); color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 15px; }
        .tool-btn-secondary { background-color: var(--secondary-color); margin-left: 10px; }
        #clearUrlBtn { height: 46.4px; margin-top: 10px; font-size: 1.2em; background-color: var(--danger-color); color:white; border-radius:6px; border:none; cursor:pointer; padding: 0 12px;}

        .result-box { background-color: var(--bg-color); margin-top: 15px; padding: 15px; border-radius: 6px; font-size: var(--font-size-base); }
        .single-story { border-bottom: 2px dashed var(--border-color); padding-bottom: 20px; margin-bottom: 20px; }
        .single-story img { max-width: 100%; height: auto; display: block; margin: 15px auto; border-radius: 8px; }
        .story-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
        .header-buttons { display: flex; gap: 8px; flex-wrap: wrap; align-items: center;}
        .header-buttons button { background-color: var(--secondary-color); color: white; border: none; border-radius: 5px; padding: 6px 12px; font-size: 14px; cursor: pointer; }
        .header-buttons .save-btn.saved { background-color: var(--danger-color); }
        .theme-toggle-container { position: fixed; top: 15px; right: 20px; z-index: 1000; display:flex; gap: 5px;}
        .theme-toggle { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; display: flex; justify-content: center; align-items: center; }
        #ae_loading { margin-top: 15px; color: var(--primary-color); font-style: italic; text-align: center; }
        .library-item, .bookmark-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .library-item .item-title, .bookmark-item .item-title { flex-grow: 1; cursor: pointer; }
        .library-item.selected, .bookmark-item.selected { background-color: var(--border-color); }
        .library-item .delete-btn, .bookmark-item .delete-btn { background-color: var(--danger-color); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left:10px; }
        .library-controls, .bookmark-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;}
        .library-controls input[type="search"], .bookmark-controls input[type="search"] { width: auto; flex-grow: 1; margin-top:0;}
        .library-controls select, .bookmark-controls select { width: auto; margin-top:0;}

        /* Toast Notification */
        .toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--primary-color); color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10001; font-size: 16px; opacity: 0; transition: opacity 0.5s, bottom 0.5s; }
        .toast-notification.show { opacity: 1; bottom: 30px; }
        .toast-notification.error { background-color: var(--danger-color); }
        .toast-notification.success { background-color: var(--success-color); }
        .toast-notification.warning { background-color: #ffc107; color: #333; }


        /* Back to Top Button */
        #backToTopBtn { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 999; background-color: var(--secondary-color); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* Article Settings Panel */
        .article-settings { background-color: var(--container-bg); padding: 10px; margin-bottom: 15px; border-radius: 6px; border: 1px solid var(--border-color); display: flex; flex-wrap: wrap; align-items: center; gap: 15px;}
        .article-settings label { font-size: 0.9em; }
        .article-settings button, .article-settings select { padding: 6px 10px; font-size: 0.9em; background-color: var(--bg-color); color: var(--text-color); border:1px solid var(--border-color); border-radius:4px; cursor:pointer; }
        .article-settings .tts-speed-control { display: flex; align-items: center; gap: 5px; }
        #voiceSelectorContainer { margin-left: 10px; }
        
        /* Internal Navigation History */
        #internalNavHistoryContainer {
            margin-top: 10px;
            padding: 5px 0;
        }
        #internalNavHistoryContainer button {
            font-size: 0.9em;
            padding: 5px 10px;
            margin-right: 5px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #internalNavHistoryContainer button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        /* Bookmark form styling */
        #bookmarkForm div {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        #bookmarkForm input[type="text"], #bookmarkForm input[type="url"], #bookmarkForm select {
            flex-grow: 1;
            margin-top: 0; 
        }
        #bookmarkForm button {
            margin-top: 0; 
        }
        #library-content-wrapper {
            display: flex;
            flex-wrap: wrap; 
            gap: 20px;
        }
        #library-list-container {
            flex: 1; 
            min-width: 250px; 
            max-height: 60vh; 
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            padding-right: 15px;
        }
        #library-article-view {
            flex: 2; 
            min-width: 300px;
        }
        #lib-article-text-content {
            white-space: pre-wrap; 
            background-color: var(--bg-color); 
            padding: 15px; 
            border-radius: 6px; 
            max-height: 50vh; 
            overflow-y: auto;
            border: 1px solid var(--border-color);
            line-height: 1.7;
        }
        #lib-article-current-tags .tag-item {
            background-color: var(--secondary-color); color: white;
            padding: 3px 8px; border-radius: 4px;
            margin-right: 5px; margin-bottom: 5px; font-size: 0.9em;
            display: inline-block;
        }
        #lib-article-current-tags .tag-remove-btn {
            margin-left: 4px; border: none; background: transparent;
            color: white; cursor: pointer; font-weight: bold;
        }

         /* Fallback Share Modal */
        .fallback-share-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: var(--container-bg); color: var(--text-color);
            padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10002; width: 90%; max-width: 500px; border: 1px solid var(--border-color);
        }
        .fallback-share-modal h4 { margin-top: 0; color: var(--primary-color); }
        .fallback-share-modal textarea { 
            width: 100%; height: 150px; margin-bottom: 10px; font-size: 0.9em; 
            padding: 5px; box-sizing: border-box; background-color: var(--bg-color); 
            color: var(--text-color); border: 1px solid var(--border-color);
        }
        .fallback-share-modal button, .fallback-share-modal a {
            margin-right: 10px; margin-bottom: 5px; padding: 8px 12px; 
            border-radius: 4px; text-decoration: none; font-size: 0.9em;
        }
        .fallback-share-modal button.primary { background-color: var(--primary-color); color: white; border: none; }
        .fallback-share-modal button.danger { background-color: var(--danger-color); color: white; border: none; float: right; }
        .fallback-share-modal a { background-color: var(--secondary-color); color: white; display: inline-block; }
    </style>
</head>
<body>
    <!-- ... ‡§Ü‡§™‡§ï‡§æ ‡§∏‡§æ‡§∞‡§æ HTML ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§Ø‡§π‡§æ‡§Å ... -->
    <div id="progress-bar"></div>
    <div class="theme-toggle-container">
        <button class="theme-toggle" onclick="toggleTheme('light')" title="‡§≤‡§æ‡§á‡§ü ‡§Æ‡•ã‡§°">‚òÄÔ∏è</button>
        <button class="theme-toggle" onclick="toggleTheme('dark')" title="‡§°‡§æ‡§∞‡•ç‡§ï ‡§Æ‡•ã‡§°">üåì</button>
        <button class="theme-toggle" onclick="toggleTheme('sepia')" title="‡§∏‡•á‡§™‡§ø‡§Ø‡§æ ‡§Æ‡•ã‡§°">üìú</button>
    </div>
    <div class="main-container">
        <h1>‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∞‡•Ä‡§°‡§∞</h1>

        <div id="googleSearchContainer" style="margin-bottom: 15px; display: flex; gap: 5px;">
            <input type="search" id="googleSearchQuery" placeholder="‡§ó‡•Ç‡§ó‡§≤ ‡§™‡§∞ ‡§ñ‡•ã‡§ú‡•á‡§Ç..." style="flex-grow: 1; margin-top:0;">
            <button onclick="performGoogleSearch()" class="tool-btn" style="margin-top:0; padding: 12px 15px;" title="‡§ñ‡•ã‡§ú‡•á‡§Ç">üîç</button>
        </div>

        <div id="internalNavHistoryContainer" style="display: none;">
            <button id="historyBackBtn" onclick="navigateHistory(-1)" disabled>‚¨ÖÔ∏è ‡§™‡§ø‡§õ‡§≤‡§æ</button>
            <button id="historyForwardBtn" onclick="navigateHistory(1)" disabled>‚û°Ô∏è ‡§Ö‡§ó‡§≤‡§æ</button>
        </div>
        <div class="tabs">
            <button class="tab-link active" onclick="openTool(event, 'ArticleExtractor')">‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç</button>
            <button class="tab-link" onclick="openTool(event, 'MyLibrary')">‡§Æ‡•á‡§∞‡•Ä ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä <span id="library-count">(0)</span></button>
            <button class="tab-link" onclick="openTool(event, 'Bookmarks')">‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï <span id="bookmark-count">(0)</span></button>
        </div>

        <div id="ArticleExtractor" class="tool-content" style="display:block;">
             <p>‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡§æ ‡§≤‡§ø‡§Ç‡§ï, ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§™‡•á‡§ú ‡§Ø‡§æ ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§ï‡§æ ‡§π‡•ã‡§Æ‡§™‡•á‡§ú ‡§≤‡§ø‡§Ç‡§ï ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç‡•§</p>
             <div style="display: flex; align-items: center; gap: 5px;">
                <input type="url" id="articleUrl" placeholder="https://example.com/" style="flex-grow: 1; margin-top:0;">
                <button id="clearUrlBtn" onclick="clearUrlInput()" title="URL ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç">‚úó</button>
            </div>
             
             <div style="margin-top: 10px; margin-bottom: 5px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px;">
                 <div>
                    <input type="checkbox" id="crawlSiteToggle" name="crawlSiteToggle" checked onchange="toggleDepthSelector()">
                    <label for="crawlSiteToggle" style="font-size: 0.9em; cursor:pointer;">‡§á‡§∏ URL ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á ‡§Ö‡§®‡•ç‡§Ø ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§≠‡•Ä ‡§ñ‡•ã‡§ú‡•á‡§Ç</label>
                 </div>
                 <div id="depthSelectorContainer" style="display: inline-block;">
                    <label for="crawlDepth" style="font-size: 0.9em;">‡§ñ‡•ã‡§ú ‡§ï‡•Ä ‡§ó‡§π‡§∞‡§æ‡§à:</label>
                    <select id="crawlDepth" name="crawlDepth" style="font-size: 0.9em; padding: 5px;">
                        <option value="0">‡§ï‡•á‡§µ‡§≤ ‡§Ø‡§π ‡§™‡•á‡§ú (‡§Ø‡§æ ‡§á‡§∏ ‡§™‡•á‡§ú ‡§ï‡•á ‡§≤‡§ø‡§Ç‡§ï)</option>
                        <option value="1" selected>1 ‡§∏‡•ç‡§§‡§∞ ‡§ó‡§π‡§∞‡§æ</option>
                        <option value="2">2 ‡§∏‡•ç‡§§‡§∞ ‡§ó‡§π‡§∞‡§æ</option>
                        <option value="3">3 ‡§∏‡•ç‡§§‡§∞ ‡§ó‡§π‡§∞‡§æ (‡§ß‡•Ä‡§Æ‡§æ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à)</option>
                    </select>
                 </div>
             </div>
             <div style="margin-top: 15px; margin-bottom: 5px;">
                 <input type="search" id="extractorSearch" placeholder="‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§ú‡•á‡§Ç..." oninput="filterExtractedArticles()" style="width: calc(100% - 145px); margin-right: 10px; margin-top:0;">
                 <button onclick="clearExtractorSearch()" class="tool-btn-secondary" style="padding: 10px 15px; margin-top: 0; font-size:0.9em;">‡§ñ‡•ã‡§ú ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button>
             </div>


             <button class="tool-btn" onclick="ae_startExtraction()">‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç</button>
             <button id="toggleCrawlBtn" class="tool-btn-secondary" onclick="toggleCrawling()" style="display: none;">‚èπÔ∏è ‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•á‡§Ç</button>
             <button class="tool-btn-secondary" onclick="clearResults()">‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button>
             
             <div id="article-settings-panel" style="display:none; margin-top: 20px;">
                <div class="article-settings">
                    <div>
                        <label for="fontSize">‡§´‡§º‡•â‡§®‡•ç‡§ü ‡§Ü‡§ï‡§æ‡§∞: </label>
                        <button onclick="changeFontSize(-1)" title="‡§´‡§º‡•â‡§®‡•ç‡§ü ‡§ò‡§ü‡§æ‡§è‡§Ç">A-</button>
                        <button onclick="changeFontSize(1)" title="‡§´‡§º‡•â‡§®‡•ç‡§ü ‡§¨‡§¢‡§º‡§æ‡§è‡§Ç">A+</button>
                    </div>
                    <div class="tts-speed-control">
                        <label for="ttsSpeed">‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•Ä ‡§ó‡§§‡§ø: </label>
                        <select id="ttsSpeed" onchange="setSpeechRate(this.value)" title="‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•Ä ‡§ó‡§§‡§ø ‡§¨‡§¶‡§≤‡•á‡§Ç">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1x (‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø)</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                        </select>
                    </div>
                    <div id="voiceSelectorContainer" style="display:none;">
                        <label for="voiceSelector">‡§Ü‡§µ‡§æ‡§ú‡§º ‡§ö‡•Å‡§®‡•á‡§Ç: </label>
                        <select id="voiceSelector" onchange="setSpeechVoice(this.options[this.selectedIndex].getAttribute('data-name'))" title="‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§¨‡§¶‡§≤‡•á‡§Ç"></select>
                    </div>
                     <div>
                        <label for="displayMode">‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§Æ‡•ã‡§°:</label>
                        <select id="displayMode" onchange="setDisplayMode(this.value)" title="‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§Æ‡•ã‡§° ‡§¨‡§¶‡§≤‡•á‡§Ç">
                            <option value="image-text" selected>‡§á‡§Æ‡•á‡§ú ‡§î‡§∞ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü</option>
                            <option value="text-only">‡§ï‡•á‡§µ‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü</option>
                        </select>
                    </div>
                </div>
             </div>

             <div id="ae_loading" style="display:none;"></div>
             <div class="result-box" id="ae_result"></div>
        </div>

        <div id="MyLibrary" class="tool-content">
            <h2>‡§∏‡•á‡§µ ‡§ï‡§ø‡§è ‡§ó‡§è ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤</h2>
            <div class="library-controls">
                <input type="search" id="librarySearch" placeholder="‡§ü‡§æ‡§á‡§ü‡§≤ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç..." oninput="filterLibrary()">
                <select id="librarySort" onchange="loadLibrary()">
                    <option value="date_desc">‡§∏‡§¨‡§∏‡•á ‡§®‡§Ø‡§æ ‡§™‡§π‡§≤‡•á</option>
                    <option value="date_asc">‡§∏‡§¨‡§∏‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§™‡§π‡§≤‡•á</option>
                    <option value="title_asc">‡§ü‡§æ‡§á‡§ü‡§≤ (A-Z)</option>
                    <option value="title_desc">‡§ü‡§æ‡§á‡§ü‡§≤ (Z-A)</option>
                </select>
                <div id="libraryTagFilterContainer" style="display:inline-block; margin-left:10px;">
                    <label for="libraryTagFilter" style="font-size:0.9em;">‡§ü‡•à‡§ó ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞:</label>
                    <select id="libraryTagFilter" onchange="loadLibrary()" style="font-size:0.9em; padding:5px; width:auto; margin-top:0;">
                        <option value="">‡§∏‡§≠‡•Ä ‡§ü‡•à‡§ó</option>
                    </select>
                </div>
            </div>
             <div class="library-controls" style="margin-top:5px;">
                <button onclick="exportLibrary()" class="tool-btn-secondary" style="margin-top:0; margin-left:0; font-size:0.9em; padding:8px 12px;">‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
                <input type="file" id="importLibraryFile" accept=".json" onchange="importLibraryHandler(event)" style="display:none;">
                <button onclick="document.getElementById('importLibraryFile').click()" class="tool-btn-secondary" style="margin-top:0; font-size:0.9em; padding:8px 12px;">‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
            </div>

            <div id="library-content-wrapper">
                <div id="library-list-container">
                    <div id="library-list"></div>
                </div>
                <div id="library-article-view" style="display: none;">
                    <h3 id="lib-article-title"></h3>
                    <p style="margin-top:0; margin-bottom: 5px;"><small>‡§Æ‡•Ç‡§≤ URL: <a id="lib-article-original-url" href="#" target="_blank" rel="noopener noreferrer"></a></small></p>
                    <div style="margin-bottom:15px; margin-top:5px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <button onclick="copyLibraryArticleText()" class="tool-btn-secondary" style="padding: 8px 12px; font-size: 0.9em; margin-left:0;">‡§™‡•Ç‡§∞‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç</button>
                        <button id="shareLibArticleBtn" class="tool-btn-secondary" style="padding: 8px 12px; font-size: 0.9em; background-color: var(--success-color);">‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
                        
                        <div style="margin-left:auto;"> 
                            <label for="libFontSize" style="font-size:0.9em;">‡§´‡§º‡•â‡§®‡•ç‡§ü: </label>
                            <button onclick="changeLibraryFontSize(-1)" title="‡§´‡§º‡•â‡§®‡•ç‡§ü ‡§ò‡§ü‡§æ‡§è‡§Ç" style="padding:5px 8px; font-size:0.8em;">A-</button>
                            <button onclick="changeLibraryFontSize(1)" title="‡§´‡§º‡•â‡§®‡•ç‡§ü ‡§¨‡§¢‡§º‡§æ‡§è‡§Ç" style="padding:5px 8px; font-size:0.8em;">A+</button>
                        </div>
                    </div>
                    <div id="lib-article-text-content"></div>
                     <div id="lib-article-tags-container" style="margin-top: 15px;">
                        <h4>‡§ü‡•à‡§ó‡•ç‡§∏:</h4>
                        <div id="lib-article-current-tags" style="margin-bottom:10px;"></div>
                        <div style="display: flex; gap: 5px; align-items:center;">
                            <input type="text" id="lib-new-tag-input" placeholder="‡§®‡§Ø‡§æ ‡§ü‡•à‡§ó ‡§ú‡•ã‡§°‡§º‡•á‡§Ç" style="flex-grow:1; margin-top:0; font-size:0.9em; padding:8px;">
                            <button onclick="addTagToCurrentLibraryArticle()" class="tool-btn-secondary" style="margin-top:0;padding: 8px 12px; font-size: 0.9em;">‡§ü‡•à‡§ó ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="Bookmarks" class="tool-content" style="display:none;">
            <h2>‡§Æ‡•á‡§∞‡•á ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï</h2>
            <div id="bookmarkFolderManagement" style="margin-bottom:15px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                <input type="text" id="newBookmarkFolderName" placeholder="‡§®‡§Ø‡§æ ‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ ‡§®‡§æ‡§Æ" style="width:auto; margin-top:0; flex-grow:1; min-width:150px;">
                <button onclick="createBookmarkFolder()" class="tool-btn-secondary" style="margin-top:0; padding:10px 15px;">‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ ‡§¨‡§®‡§æ‡§è‡§Ç</button>
                <div style="flex-basis:100%; height:0; display:none;" class="folder-break"></div> <!-- Flexbox wrap helper -->
                <label for="bookmarkFolderFilter" style="font-size:0.9em;">‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞:</label>
                <select id="bookmarkFolderFilter" onchange="loadBookmarks()" style="width:auto; margin-top:0; padding:10px; flex-grow:1; min-width:150px;">
                    <option value="">‡§∏‡§≠‡•Ä ‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞</option>
                </select>
            </div>
            <div id="bookmarkForm">
                 <div>
                    <input type="text" id="bookmarkName" placeholder="‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)">
                    <input type="url" id="bookmarkUrl" placeholder="‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§ï‡§æ URL">
                 </div>
                 <div style="align-items:center;">
                    <label for="bookmarkAssignFolder" style="font-size:0.9em; margin-right:5px;">‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç:</label>
                    <select id="bookmarkAssignFolder" style="flex-grow:1; padding:10px;">
                        <option value="Default">‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞</option>
                    </select>
                 </div>
                <button class="tool-btn" onclick="addBookmark()">‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
            </div>
            <div style="margin-top:15px; margin-bottom:15px; display:flex; gap:10px;">
                <button onclick="exportBookmarks()" class="tool-btn-secondary" style="margin-top:0; margin-left:0; font-size:0.9em; padding:8px 12px;">‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
                <input type="file" id="importBookmarksFile" accept=".json" onchange="importBookmarksHandler(event)" style="display:none;">
                <button onclick="document.getElementById('importBookmarksFile').click()" class="tool-btn-secondary" style="margin-top:0; font-size:0.9em; padding:8px 12px;">‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
            <div id="bookmark-list" style="margin-top: 20px;"></div>
        </div>
    </div>
    <button id="backToTopBtn" onclick="scrollToTop()" title="‡§ä‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç">‚¨ÜÔ∏è</button>
    <div id="toast-container"></div>
    
    <script>
    // --- Embedded Service Worker Code ---
    // ‡§Ø‡§π ‡§ï‡•ã‡§° ‡§è‡§ï ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ç‡§ó ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§π‡•à ‡§ú‡§ø‡§∏‡•á ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç Blob ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§
    // ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£: ‡§á‡§∏ ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ç‡§ó ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§¨‡•à‡§ï-‡§ü‡§ø‡§ï‡•ç‡§∏ (`) ‡§Ø‡§æ ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ç‡§ó ‡§ü‡§∞‡•ç‡§Æ‡§ø‡§®‡•á‡§ü‡§∞ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡•Ä ‡§∏‡•á ‡§ï‡§∞‡•á‡§Ç‡•§
    // ‡§Ø‡§¶‡§ø ‡§Ü‡§™‡§ï‡•ã ‡§á‡§∏ ‡§ï‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§¨‡•à‡§ï-‡§ü‡§ø‡§ï‡•ç‡§∏ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡§æ ‡§π‡•à, ‡§§‡•ã ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§è‡§∏‡•ç‡§ï‡•á‡§™ ‡§ï‡§∞‡•á‡§Ç: \`
    const serviceWorkerCode = `
        const STATIC_CACHE_NAME = 'article-reader-static-v3';
        const ARTICLE_CACHE_NAME = 'article-reader-articles-v3';
        const PROXY_DOMAIN = 'article-proxyy.rockysmail69.workers.dev'; // ‡§™‡•ç‡§∞‡•â‡§ï‡•ç‡§∏‡•Ä ‡§°‡•ã‡§Æ‡•á‡§® ‡§Ø‡§π‡§æ‡§Å ‡§∞‡§ñ‡•á‡§Ç

        // ‡§ê‡§™ ‡§∂‡•á‡§≤ ‡§ï‡•Ä ‡§´‡§º‡§æ‡§á‡§≤‡•á‡§Ç - ‡§Ø‡§π ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§π‡•à ‡§ï‡§ø ‡§Ø‡§π ‡§Æ‡•Å‡§ñ‡•ç‡§Ø HTML ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡•ã ‡§á‡§Ç‡§ó‡§ø‡§§ ‡§ï‡§∞‡•á
        // Blob URL ‡§ï‡•á ‡§∏‡§æ‡§•, APP_SHELL_FILES ‡§ï‡§æ ‡§ï‡•à‡§∂‡§ø‡§Ç‡§ó ‡§•‡•ã‡§°‡§º‡§æ ‡§Ö‡§≤‡§ó ‡§§‡§∞‡•Ä‡§ï‡•á ‡§∏‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§
        // ‡§Æ‡•Å‡§ñ‡•ç‡§Ø HTML ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡•ã 'fetch' ‡§á‡§µ‡•á‡§Ç‡§ü ‡§Æ‡•á‡§Ç ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï-‡§´‡§∞‡•ç‡§∏‡•ç‡§ü ‡§Ø‡§æ ‡§ï‡•à‡§∂-‡§´‡§∞‡•ç‡§∏‡•ç‡§ü ‡§∞‡§£‡§®‡•Ä‡§§‡§ø ‡§∏‡•á ‡§π‡•à‡§Ç‡§°‡§≤ ‡§ï‡§∞‡§®‡§æ ‡§¨‡•á‡§π‡§§‡§∞ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§
        // ‡§Ö‡§≠‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§π‡§Æ ‡§á‡§∏‡•á ‡§ñ‡§æ‡§≤‡•Ä ‡§õ‡•ã‡§°‡§º ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§Ø‡§æ ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§ï‡§æ URL (‡§Ø‡§¶‡§ø ‡§™‡§§‡§æ ‡§π‡•ã) ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§
        // ‡§ö‡•Ç‡§Ç‡§ï‡§ø ‡§π‡§Æ ‡§è‡§ï ‡§π‡•Ä ‡§´‡§º‡§æ‡§á‡§≤ ‡§Æ‡•á‡§Ç ‡§π‡•à‡§Ç, APP_SHELL_FILES ‡§ï‡•Ä ‡§™‡§æ‡§∞‡§Ç‡§™‡§∞‡§ø‡§ï ‡§Ö‡§µ‡§ß‡§æ‡§∞‡§£‡§æ ‡§•‡•ã‡§°‡§º‡•Ä ‡§¨‡§¶‡§≤ ‡§ú‡§æ‡§§‡•Ä ‡§π‡•à‡•§
        // ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§µ‡§∞‡•ç‡§ï‡§∞ ‡§ï‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§´‡•ã‡§ï‡§∏ ARTICLE_CACHE ‡§™‡§∞ ‡§π‡•ã‡§ó‡§æ‡•§
        const APP_SHELL_FILES = [
            // './', // ‡§Ø‡§π Blob URL ‡§ï‡•á ‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠ ‡§Æ‡•á‡§Ç ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡•á‡§ó‡§æ
            // './code-254.html' // ‡§Ø‡§π ‡§≠‡•Ä ‡§∏‡•Ä‡§ß‡•á ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡•á‡§ó‡§æ
        ]; // ‡§π‡§Æ ‡§á‡§∏‡•á fetch ‡§Æ‡•á‡§Ç ‡§π‡•à‡§Ç‡§°‡§≤ ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á

        self.addEventListener('install', event => {
            console.log('[SW] Install event. Caches: S:', STATIC_CACHE_NAME, 'A:', ARTICLE_CACHE_NAME);
            event.waitUntil(
                Promise.all([
                    caches.open(STATIC_CACHE_NAME), // ‡§∏‡•ç‡§ü‡•à‡§ü‡§ø‡§ï ‡§ï‡•à‡§∂ ‡§¨‡§®‡§æ‡§è‡§Ç ‡§≠‡§≤‡•á ‡§π‡•Ä ‡§π‡§Æ ‡§á‡§∏‡•á ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§® ‡§ï‡§∞‡•á‡§Ç
                    caches.open(ARTICLE_CACHE_NAME)  // ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡•à‡§∂ ‡§¨‡§®‡§æ‡§è‡§Ç
                ]).then(() => {
                    console.log('[SW] Caches opened during install.');
                    // ‡§Ø‡§¶‡§ø APP_SHELL_FILES ‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§õ ‡§π‡•ã‡§§‡§æ, ‡§§‡•ã ‡§π‡§Æ ‡§â‡§∏‡•á ‡§Ø‡§π‡§æ‡§Å ‡§ï‡•à‡§∂ ‡§ï‡§∞‡§§‡•á:
                    // caches.open(STATIC_CACHE_NAME).then(cache => cache.addAll(APP_SHELL_FILES));
                }).catch(error => {
                    console.error('[SW] App shell caching/cache opening failed:', error);
                })
            );
            self.skipWaiting(); // ‡§®‡§è SW ‡§ï‡•ã ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§ï‡§∞‡•á‡§Ç
        });

        self.addEventListener('activate', event => {
            console.log('[SW] Activate event');
            event.waitUntil(
                caches.keys().then(cacheNames => {
                    return Promise.all(
                        cacheNames.map(cacheName => {
                            if (cacheName !== STATIC_CACHE_NAME && cacheName !== ARTICLE_CACHE_NAME) {
                                console.log('[SW] Deleting old cache:', cacheName);
                                return caches.delete(cacheName);
                            }
                        })
                    );
                }).then(() => {
                    console.log('[SW] Claiming clients.');
                    return self.clients.claim();
                })
            );
        });

        self.addEventListener('fetch', event => {
            const requestUrl = new URL(event.request.url);

            if (event.request.method !== 'GET') {
                // console.log('[SW] Non-GET request, skipping:', event.request.method, requestUrl.pathname);
                return;
            }

            // ‡§™‡•ç‡§∞‡•â‡§ï‡•ç‡§∏‡•Ä ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß‡•ã‡§Ç ‡§ï‡•ã ‡§∏‡•Ä‡§ß‡•á ‡§ú‡§æ‡§®‡•á ‡§¶‡•á‡§Ç
            if (requestUrl.host === PROXY_DOMAIN || requestUrl.pathname.includes(PROXY_DOMAIN)) {
                // console.log('[SW] Proxy request, fetching from network:', requestUrl.href);
                return fetch(event.request);
            }
            
            // CDN ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß‡•ã‡§Ç (‡§ú‡•à‡§∏‡•á Readability) ‡§ï‡•ã ‡§∏‡•Ä‡§ß‡•á ‡§ú‡§æ‡§®‡•á ‡§¶‡•á‡§Ç
            if (requestUrl.host === 'cdn.jsdelivr.net') {
                // console.log('[SW] CDN request, fetching from network:', requestUrl.href);
                return fetch(event.request);
            }


            // ‡§Æ‡•Å‡§ñ‡•ç‡§Ø HTML ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§ï‡•á ‡§≤‡§ø‡§è (‡§Ø‡§¶‡§ø ‡§π‡§Æ ‡§∏‡•ç‡§ï‡•ã‡§™ '/' ‡§∏‡•á‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç)
            // ‡§Ø‡§π ‡§ú‡§ü‡§ø‡§≤ ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø Blob URL ‡§ï‡§æ origin ‡§Ö‡§≤‡§ó ‡§π‡•ã‡§§‡§æ ‡§π‡•à‡•§
            // ‡§á‡§∏‡•á ‡§∏‡§∞‡§≤ ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§π‡§Æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø HTML ‡§ï‡•ã ‡§ï‡•à‡§∂ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á, ‡§ï‡•á‡§µ‡§≤ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤‡•§
            // ‡§Ø‡§¶‡§ø requestUrl.pathname === self.registration.scope (‡§Ø‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø HTML ‡§ï‡§æ ‡§™‡§æ‡§•)
            // ‡§§‡•ã ‡§Ü‡§™ ‡§á‡§∏‡•á STATIC_CACHE ‡§∏‡•á ‡§∏‡§∞‡•ç‡§µ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

            // ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è (JSON ‡§∞‡§ø‡§∏‡•ç‡§™‡•â‡§®‡•ç‡§∏ ‡§ï‡•Ä ‡§â‡§Æ‡•ç‡§Æ‡•Ä‡§¶)
            // ‡§π‡§Æ ‡§Æ‡§æ‡§® ‡§∞‡§π‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡§æ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§â‡§∏‡§ï‡•á ‡§Æ‡•Ç‡§≤ URL ‡§∏‡•á ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§
            event.respondWith(
                caches.open(ARTICLE_CACHE_NAME).then(articleCache => {
                    return articleCache.match(event.request).then(cachedResponse => {
                        if (cachedResponse) {
                            console.log('[SW] Serving from ARTICLE cache:', event.request.url);
                            return cachedResponse;
                        }
                        
                        // ‡§Ø‡§¶‡§ø ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡•à‡§∂ ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç
                        // ‡§Ø‡§π ‡§™‡•ç‡§∞‡•â‡§ï‡•ç‡§∏‡•Ä ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§®‡§π‡•Ä‡§Ç ‡§ú‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è, ‡§Ø‡§π ‡§Æ‡•Ç‡§≤ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ URL ‡§π‡•à
                        console.log('[SW] Article not in cache, fetching from network (expecting this to fail if offline):', event.request.url);
                        return fetch(event.request).catch(err => {
                             console.warn('[SW] Network fetch failed for article (or non-article resource):', event.request.url, err);
                             // ‡§Ø‡§¶‡§ø ‡§Ø‡§π ‡§è‡§ï ‡§®‡•á‡§µ‡§ø‡§ó‡•á‡§∂‡§® ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§π‡•à ‡§î‡§∞ ‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§π‡•à, ‡§§‡•ã ‡§è‡§ï ‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§™‡•á‡§ú ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç (‡§Ö‡§≠‡•Ä ‡§≤‡§æ‡§ó‡•Ç ‡§®‡§π‡•Ä‡§Ç)
                             // if (event.request.mode === 'navigate') {
                             // return caches.match('/offline.html'); // ‡§è‡§ï ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§™‡•á‡§ú
                             // }
                             // ‡§ó‡•à‡§∞-‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§¨‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§¶‡•á‡§Ç
                             throw err; 
                        });
                    });
                })
            );
        });

        self.addEventListener('message', event => {
            if (event.data && event.data.action === 'cache-article' && event.data.url && event.data.article) {
                console.log('[SW] Message: cache-article:', event.data.url);
                const articleData = event.data.article; 
                const requestToCache = new Request(event.data.url); // ‡§Æ‡•Ç‡§≤ URL ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ï‡§∞‡•á‡§Ç
                const responseToCache = new Response(JSON.stringify(articleData), {
                    headers: { 'Content-Type': 'application/json' }
                });

                caches.open(ARTICLE_CACHE_NAME).then(cache => {
                    cache.put(requestToCache, responseToCache)
                        .then(() => console.log('[SW] Article cached:', event.data.url))
                        .catch(err => console.error('[SW] Error caching article:', err));
                }).catch(err => console.error('[SW] Error opening ARTICLE_CACHE for caching:', err));
            } else if (event.data && event.data.action === 'delete-article-from-cache' && event.data.url) {
                console.log('[SW] Message: delete-article-from-cache:', event.data.url);
                const requestToDelete = new Request(event.data.url);
                caches.open(ARTICLE_CACHE_NAME).then(cache => {
                    cache.delete(requestToDelete)
                        .then(wasDeleted => {
                            if (wasDeleted) console.log('[SW] Article deleted from cache:', event.data.url);
                            else console.log('[SW] Article not found in cache to delete:', event.data.url);
                        })
                        .catch(err => console.error('[SW] Error deleting article from cache:', err));
                }).catch(err => console.error('[SW] Error opening ARTICLE_CACHE for deletion:', err));
            } else {
                console.log('[SW] Received unhandled message:', event.data);
            }
        });
    `; // ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§µ‡§∞‡•ç‡§ï‡§∞ ‡§ï‡•ã‡§° ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ç‡§ó ‡§ï‡§æ ‡§Ö‡§Ç‡§§


    // --- Global Variables & Setup (‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ê‡§™) ---
    const MY_PRIVATE_PROXY = 'https://article-proxyy.rockysmail69.workers.dev'; 
    // ... ‡§¨‡§æ‡§ï‡•Ä ‡§∏‡§≠‡•Ä ‡§ó‡•ç‡§≤‡•ã‡§¨‡§≤ ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤‡•ç‡§∏ ‡§Ø‡§π‡§æ‡§Å ...
    let allStoryLinks = []; let currentLinkIndex = 0; let isLoadingNext = false;
    const speechApiSupported = 'speechSynthesis' in window;
    let speechSynth, utterance;

    const MAX_TOTAL_ARTICLES_TO_QUEUE = 50; 
    const MAX_FETCH_FAILURES_IN_ROW = 5;

    let navigationHistory = [];
    let currentHistoryIndex = -1;
    let isNavigatingHistory = false;
    let currentDisplayMode = 'image-text'; 
    let isCrawlingPaused = false;

    const STORAGE_KEY_THEME = 'articleReaderTheme_s1';
    const STORAGE_KEY_LIBRARY = 'articleReaderLibrary_s3'; // Version bump
    const STORAGE_KEY_FONT_SIZE = 'articleReaderFontSize_s1';
    const STORAGE_KEY_LIBRARY_FONT_SIZE = 'articleReaderLibraryFontSize_s1';
    const STORAGE_KEY_SPEECH_RATE = 'articleReaderSpeechRate_s1';
    const STORAGE_KEY_VOICE_NAME = 'articleReaderVoiceName_s1';
    const STORAGE_KEY_DISPLAY_MODE = 'articleReaderDisplayMode_s1';
    const STORAGE_KEY_BOOKMARKS = 'articleReaderBookmarks_s3'; // Version bump
    const STORAGE_KEY_OFFLINE_ARTICLE = 'articleReaderOfflineArticle_s1';
    
    if (speechApiSupported) {
        speechSynth = window.speechSynthesis;
        utterance = new SpeechSynthesisUtterance();
        utterance.rate = 1; 
    }


    // --- ‡§¨‡§æ‡§ï‡•Ä ‡§∏‡§≠‡•Ä ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§ê‡§™ ‡§ú‡§æ‡§µ‡§æ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§Ø‡§π‡§æ‡§Å ---
    // toggleTheme, applySavedTheme, openTool, fetchWithProxy, createStoryElement,
    // document.addEventListener('click', ...), downloadTextAsMp3, loadNextArticleIfIdle,
    // loadNextArticle, toggleDepthSelector, toggleCrawling, ae_startExtraction,
    // clearResults, clearUrlInput, filterExtractedArticles, clearExtractorSearch,
    // getLibrary, saveLibrary, isSaved, toggleSaveArticle, loadLibrary, filterLibrary,
    // showSavedArticle, populateTagFilter, displayArticleTags, addTagToCurrentLibraryArticle,
    // removeTagFromCurrentLibraryArticle, copyLibraryArticleText, shareLibraryArticle,
    // displayFallbackShareOptions, updateLibraryCount, getBookmarks, saveBookmarks,
    // addBookmark, loadBookmarks, getBookmarkFolders, populateBookmarkFolderSelectors,
    // createBookmarkFolder, updateBookmarkCount, changeFontSize, applySavedFontSize,
    // changeLibraryFontSize, applySavedLibraryFontSize, setSpeechRate, applySavedSpeechRate,
    // setDisplayMode, applySavedDisplayMode, populateVoiceList, setSpeechVoice,
    // showToast, scrollToTop, addToHistory, updateHistoryButtons, navigateHistory,
    // displayOfflineArticle, exportData, exportLibrary, exportBookmarks, importData,
    // importLibraryHandler, importBookmarksHandler, window.onscroll, performGoogleSearch

    // ... (‡§Ø‡§π‡§æ‡§Å ‡§Ü‡§™‡§ï‡•á ‡§™‡§ø‡§õ‡§≤‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•á ‡§∏‡§≠‡•Ä JS ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§® ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç, `DOMContentLoaded` ‡§∏‡•á ‡§†‡•Ä‡§ï ‡§™‡§π‡§≤‡•á ‡§§‡§ï) ...
    // --- Global Variables & Setup ---
    // ... (‡§Ü‡§™‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§ó‡•ç‡§≤‡•ã‡§¨‡§≤ ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤‡•ç‡§∏ ‡§Ø‡§π‡§æ‡§Å) ...

    // --- Core Functions ---
    function toggleTheme(themeName) {
        document.body.classList.remove('dark-mode', 'sepia-mode', 'light-mode');
        if (themeName === 'dark') document.body.classList.add('dark-mode');
        else if (themeName === 'sepia') document.body.classList.add('sepia-mode');
        else document.body.classList.add('light-mode'); 
        localStorage.setItem(STORAGE_KEY_THEME, themeName);
    }

    function applySavedTheme() {
        const savedTheme = localStorage.getItem(STORAGE_KEY_THEME) || 'light';
        toggleTheme(savedTheme);
    }

    function openTool(evt, toolName) {
        document.querySelectorAll('.tool-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
        const toolElement = document.getElementById(toolName);
        if (toolElement) toolElement.style.display = 'block';
        
        if (evt && evt.currentTarget) {
           evt.currentTarget.classList.add('active');
        } else if (toolName === 'ArticleExtractor') { 
            const extractorTab = document.querySelector('.tab-link[onclick*="ArticleExtractor"]');
            if (extractorTab) extractorTab.classList.add('active');
        }

        const historyContainer = document.getElementById('internalNavHistoryContainer');
        const toggleCrawlBtn = document.getElementById('toggleCrawlBtn');
        const libArticleView = document.getElementById('library-article-view'); 


        if (toolName === 'MyLibrary' || toolName === 'Bookmarks') {
            if(toolName === 'MyLibrary') { loadLibrary(); populateTagFilter(); }
            if(toolName === 'Bookmarks') { loadBookmarks(); /* populateBookmarkFolderSelectors is called within loadBookmarks */ }
            if(historyContainer) historyContainer.style.display = 'none';
            if(toggleCrawlBtn) toggleCrawlBtn.style.display = 'none';
            if(libArticleView && toolName === 'MyLibrary' && libArticleView.dataset.hasContent !== 'true') { 
                 libArticleView.style.display = 'none';
            }
        } else if (toolName === 'ArticleExtractor') {
            if(historyContainer) updateHistoryButtons(); 
        }
        
        const articleSettingsPanel = document.getElementById('article-settings-panel');
        const resultBox = document.getElementById('ae_result');
        if (articleSettingsPanel && resultBox) {
            articleSettingsPanel.style.display = (toolName === 'ArticleExtractor' && resultBox.innerHTML.trim() !== '') ? 'flex' : 'none';
        }
    }
    
    async function fetchWithProxy(url) {
        const proxyUrl = `${MY_PRIVATE_PROXY}/?url=${encodeURIComponent(url)}`;
        try {
            const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(20000) }); // 20s timeout
            if (!response.ok) throw new Error(`‡§™‡•ç‡§∞‡•â‡§ï‡•ç‡§∏‡•Ä ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§ú‡§µ‡§æ‡§¨ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ (‡§∏‡•ç‡§ü‡•á‡§ü‡§∏: ${response.status})`);
            return await response.text();
        } catch (error) {
            if (error.name === 'AbortError' || error.name === 'TimeoutError') { // DOMException for timeout
                throw new Error('‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§Æ‡•á‡§Ç ‡§¨‡§π‡•Å‡§§ ‡§Ö‡§ß‡§ø‡§ï ‡§∏‡§Æ‡§Ø ‡§≤‡§ó‡§æ (‡§ü‡§æ‡§á‡§Æ‡§Ü‡§â‡§ü)‡•§');
            }
            throw error;
        }
    }

    function createStoryElement(article, sourceUrl) {
        const storyId = btoa(encodeURIComponent(sourceUrl));
        const storyDiv = document.createElement('div');
        storyDiv.className = 'single-story';
        storyDiv.id = `story-${storyId}`;
        storyDiv.dataset.textContentForSearch = (article.textContent || "").toLowerCase();
        
        const headerDiv = document.createElement('div'); headerDiv.className = 'story-header';
        const titleH3 = document.createElement('h3'); 
        titleH3.textContent = article.title || "‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç";
        const headerButtons = document.createElement('div'); headerButtons.className = 'header-buttons';

        if (speechApiSupported) {
            const listenBtn = document.createElement('button');
            listenBtn.textContent = '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç';
            listenBtn.title = '‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∏‡•Å‡§®‡•á‡§Ç';
            listenBtn.setAttribute('data-playing', 'false');
            listenBtn.onclick = () => {
                if (!utterance || !article.textContent) {
                    showToast("‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•Ä ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error");
                    return;
                }
                const isPlaying = listenBtn.getAttribute('data-playing') === 'true';
                document.querySelectorAll('.single-story .header-buttons button[data-playing="true"]').forEach(btn => {
                    if (btn !== listenBtn) { // Stop other playing articles
                         btn.textContent = '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç';
                         btn.setAttribute('data-playing', 'false');
                    }
                });

                if (speechSynth.speaking && isPlaying) {
                    speechSynth.pause();
                    listenBtn.textContent = '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç';
                    listenBtn.setAttribute('data-playing', 'false');
                } else if (speechSynth.paused && !isPlaying && utterance.text.startsWith(article.title || "")) { // Resume only if it's the same article
                    speechSynth.resume();
                    listenBtn.textContent = '‚è∏Ô∏è ‡§™‡•â‡§ú‡§º ‡§ï‡§∞‡•á‡§Ç';
                    listenBtn.setAttribute('data-playing', 'true');
                } else {
                    speechSynth.cancel(); // Stop any previous speech
                    utterance.text = (article.title || "") + ". " + article.textContent;
                    speechSynth.speak(utterance);
                    listenBtn.textContent = '‚è∏Ô∏è ‡§™‡•â‡§ú‡§º ‡§ï‡§∞‡•á‡§Ç';
                    listenBtn.setAttribute('data-playing', 'true');
                }
            };
            utterance.onend = () => { 
                listenBtn.textContent = '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç'; 
                listenBtn.setAttribute('data-playing', 'false');
            };
            utterance.onerror = (event) => {
                console.error("SpeechSynthesisUtterance.onerror - Error Type:", event.error);
                let errorMsg = `‡§¨‡•ã‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${event.error}`;
                if (event.error === 'synthesis-failed') {
                    errorMsg = `‡§¨‡•ã‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø (Synthesis Failed): ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§Ü‡§™‡§ï‡•á ‡§°‡§ø‡§µ‡§æ‡§á‡§∏ ‡§™‡§∞ ‡§π‡§ø‡§Ç‡§¶‡•Ä TTS ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§î‡§∞ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§π‡•à‡•§ ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§`;
                } else if (event.error === 'voice-unavailable') {
                     errorMsg = `‡§ö‡•Å‡§®‡•Ä ‡§ó‡§à ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¶‡•Ç‡§∏‡§∞‡•Ä ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§ö‡•Å‡§®‡•á‡§Ç ‡§Ø‡§æ ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§`;
                }
                showToast(errorMsg, 'error', 7000);
                listenBtn.textContent = '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç'; 
                listenBtn.setAttribute('data-playing', 'false');
            };
            headerButtons.appendChild(listenBtn);
        }

        const downloadMp3Btn = document.createElement('button');
        downloadMp3Btn.innerHTML = 'üó£Ô∏è MP3';
        downloadMp3Btn.title = 'MP3 ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç';
        downloadMp3Btn.onclick = (e) => {
            if (!article.textContent) {
                showToast("MP3 ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error"); return;
            }
            downloadTextAsMp3(article.textContent, article.title || "audio", e.currentTarget);
        };
        headerButtons.appendChild(downloadMp3Btn);
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'save-btn';
        saveBtn.innerHTML = isSaved(sourceUrl) ? '‚ù§Ô∏è ‡§∏‡•á‡§µ ‡§π‡•à' : 'ü§ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç';
        saveBtn.title = isSaved(sourceUrl) ? '‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§∏‡•á ‡§π‡§ü‡§æ‡§è‡§Ç' : '‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç';
        if (isSaved(sourceUrl)) saveBtn.classList.add('saved');
        saveBtn.onclick = () => toggleSaveArticle(article, sourceUrl, saveBtn);
        headerButtons.appendChild(saveBtn);

        const copyBtn = document.createElement('button');
        copyBtn.innerHTML = 'üìã ‡§ï‡•â‡§™‡•Ä';
        copyBtn.title = '‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç';
        copyBtn.onclick = async (event) => { 
            if (!article.textContent) {
                showToast("‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error"); return;
            }
             try {
                document.body.focus(); 
                await new Promise(resolve => setTimeout(resolve, 100));
                const textToCopy = `${article.title || ""}\n\n${article.textContent}`;
                await navigator.clipboard.writeText(textToCopy);
                showToast('‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ!', 'success');
                event.currentTarget.innerHTML = '‚úÖ ‡§ï‡•â‡§™‡•Ä ‡§π‡•Å‡§Ü';
                setTimeout(() => { event.currentTarget.innerHTML = 'üìã ‡§ï‡•â‡§™‡•Ä'; }, 2000);
            } catch (err) {
                console.error('‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤ (navigator):', err);
                const textToCopyFallback = `${article.title || ""}\n\n${article.textContent}`;
                const textArea = document.createElement("textarea");
                textArea.value = textToCopyFallback;
                textArea.style.position = "fixed"; textArea.style.top = "-9999px"; textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                let successFallback = false;
                try {
                    textArea.focus(); textArea.select(); textArea.setSelectionRange(0, 99999); 
                    successFallback = document.execCommand('copy');
                } catch (errFallback) { console.error('Fallback copy execCommand failed:', errFallback); }
                document.body.removeChild(textArea);

                if (successFallback) {
                    showToast('‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü (‡§´‡•â‡§≤‡§¨‡•à‡§ï) ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ!', 'success');
                    event.currentTarget.innerHTML = '‚úÖ ‡§ï‡•â‡§™‡•Ä ‡§π‡•Å‡§Ü';
                    setTimeout(() => { event.currentTarget.innerHTML = 'üìã ‡§ï‡•â‡§™‡•Ä'; }, 2000);
                } else {
                    showToast(`‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${err.name} - ${err.message}`, 'error', 7000);
                }
            }
        };
        headerButtons.appendChild(copyBtn);
        
        const shareUrlBtn = document.createElement('button');
        shareUrlBtn.innerHTML = 'üîó URL ‡§∂‡•á‡§Ø‡§∞'; 
        shareUrlBtn.title = '‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§î‡§∞ URL ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç';
        shareUrlBtn.onclick = () => {
             const shareData = {
                title: article.title || "‡§è‡§ï ‡§â‡§™‡§Ø‡•ã‡§ó‡•Ä ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤",
                text: `‡§Ø‡§π ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç: ${article.title || ""}`,
                url: sourceUrl,
            };
            if (navigator.share) {
                navigator.share(shareData).catch(err => {
                    if (err.name !== 'AbortError') console.error("URL ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", err);
                });
            } else { 
                displayFallbackShareOptions(shareData);
            }
        };
        headerButtons.appendChild(shareUrlBtn);

        const shareFullTextBtn = document.createElement('button');
        shareFullTextBtn.innerHTML = 'üìú ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§∂‡•á‡§Ø‡§∞';
        shareFullTextBtn.title = '‡§™‡•Ç‡§∞‡§æ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç';
        shareFullTextBtn.style.backgroundColor = 'var(--success-color)'; 
        shareFullTextBtn.onclick = async () => {
            if (!article.title || !article.textContent || !sourceUrl) {
                showToast("‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error");
                return;
            }
            let shareText = `‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï: ${article.title}\n`;
            shareText += `‡§Æ‡•Ç‡§≤ URL: ${sourceUrl}\n\n`;
            shareText += `‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü:\n${article.textContent}`;
            const MAX_SHARE_TEXT_LENGTH = 2000; 
            if (shareText.length > MAX_SHARE_TEXT_LENGTH) {
                shareText = shareText.substring(0, MAX_SHARE_TEXT_LENGTH) + "\n\n... (‡§î‡§∞ ‡§≠‡•Ä ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü)";
                showToast("‡§™‡•Ç‡§∞‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§π‡•Å‡§§ ‡§≤‡§Ç‡§¨‡§æ ‡§π‡•à, ‡§á‡§∏‡•á ‡§õ‡•ã‡§ü‡§æ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§", "warning", 4000);
            }
            const shareData = { title: article.title, text: shareText, url: sourceUrl, };
            if (navigator.share) {
                try { await navigator.share(shareData); showToast('‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!', 'success'); } 
                catch (err) { console.error('‡§™‡•Ç‡§∞‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', err); if (err.name !== 'AbortError') { showToast(`‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${err.message}`, 'error');}}
            } else { displayFallbackShareOptions(shareData); }
        };
        headerButtons.appendChild(shareFullTextBtn);

        headerDiv.append(titleH3, headerButtons);
        
        const wordCount = article.textContent ? article.textContent.split(/\s+/).filter(Boolean).length : 0;
        const readingTime = Math.ceil(wordCount / 200);
        const authorP = document.createElement('p');
        authorP.innerHTML = `<em style="font-size: 0.9em;">‡§≤‡•á‡§ñ‡§ï: ${article.byline || '‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç'} | ‡§™‡§¢‡§º‡§®‡•á ‡§ï‡§æ ‡§∏‡§Æ‡§Ø: ~${readingTime} ‡§Æ‡§ø‡§®‡§ü</em>`;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'article-body-content'; 

        if (article.content) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = (typeof article.content === 'string') ? article.content : "<p><em>‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</em></p>";
            
            if (currentDisplayMode === 'image-text') {
                const images = tempDiv.querySelectorAll('img');
                images.forEach(img => {
                    const originalSrc = img.getAttribute('src') || img.dataset.src;
                    if (originalSrc) {
                        try {
                            const absoluteSrc = new URL(originalSrc, sourceUrl).href;
                            img.setAttribute('src', absoluteSrc);
                        } catch (e) {
                            console.warn("‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§á‡§Æ‡•á‡§ú URL:", originalSrc, "‡§™‡•á‡§ú ‡§™‡§∞:", sourceUrl);
                        }
                    }
                    img.removeAttribute('loading'); // Use explicit lazy loading or none
                    img.loading = 'lazy'; // Add explicit lazy loading
                });
            } else { 
                tempDiv.querySelectorAll('img, figure, picture').forEach(el => el.remove());
            }

            const linksInArticle = tempDiv.querySelectorAll('a[href]'); 
            linksInArticle.forEach(linkElement => { 
                const originalHref = linkElement.getAttribute('href');
                if (originalHref && originalHref.trim() !== '' && !originalHref.startsWith('#')) {
                    let absoluteUrl;
                    try {
                        absoluteUrl = new URL(originalHref, sourceUrl).href;
                    } catch (e) {
                        console.warn("‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø href, ‡§®‡§è ‡§ü‡•à‡§¨ ‡§Æ‡•á‡§Ç ‡§ñ‡•Å‡§≤‡•á‡§ó‡§æ:", originalHref, e);
                        linkElement.target = '_blank';
                        linkElement.rel = 'noopener noreferrer';
                        return; 
                    }
                        
                    if (absoluteUrl.startsWith('http:') || absoluteUrl.startsWith('https:')) {
                        linkElement.style.color = 'var(--primary-color)'; 
                        linkElement.style.textDecoration = 'underline';
                        linkElement.style.cursor = 'pointer'; 
                        linkElement.title = `‡§∞‡•Ä‡§°‡§∞ ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§≤‡•á‡§Ç: ${absoluteUrl.substring(0,70)}...`;
                        linkElement.setAttribute('data-reader-target-url', absoluteUrl);
                        linkElement.setAttribute('href', 'javascript:void(0);'); 
                        linkElement.removeAttribute('target');
                    } else {
                        linkElement.href = absoluteUrl; 
                        linkElement.target = '_blank';   
                        linkElement.rel = 'noopener noreferrer'; 
                    }
                } else if (originalHref && originalHref.startsWith('#')) {
                    linkElement.href = originalHref;
                }
            });
            contentDiv.innerHTML = tempDiv.innerHTML; 
        } else {
            contentDiv.innerHTML = "<p><em>‡§á‡§∏ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡§æ ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§</em></p>";
        }
        
        storyDiv.append(headerDiv, authorP, document.createElement('hr'), contentDiv);
        return storyDiv;
    }

    document.addEventListener('click', function(event) { 
        let targetElement = event.target;
        while (targetElement && targetElement !== document.body && targetElement.tagName !== 'A') {
            targetElement = targetElement.parentNode;
        }

        if (targetElement && targetElement.tagName === 'A' && targetElement.hasAttribute('data-reader-target-url')) {
            const resultBox = document.getElementById('ae_result');
            if (!resultBox || !resultBox.contains(targetElement)) {
                return; 
            }

            event.preventDefault();
            event.stopPropagation();

            const urlToLoadInReader = targetElement.getAttribute('data-reader-target-url');
            
            if (!urlToLoadInReader) {
                console.error("‡§∞‡•Ä‡§°‡§∞ ‡§Æ‡•á‡§Ç ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è URL ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§");
                return;
            }
            
            showToast(`‡§Ü‡§Ç‡§§‡§∞‡§ø‡§ï ‡§≤‡§ø‡§Ç‡§ï ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à: ${urlToLoadInReader.substring(0,50)}...`, 'info');
            
            const resultDivEl = document.getElementById('ae_result');
            if(resultDivEl) resultDivEl.innerHTML = ''; 
            
            const articleUrlInput = document.getElementById('articleUrl');
            if (articleUrlInput) articleUrlInput.value = urlToLoadInReader; 
            
            const crawlCheckbox = document.getElementById('crawlSiteToggle');
            if(crawlCheckbox) crawlCheckbox.checked = false; 
            
            if (!isNavigatingHistory) {
                addToHistory(urlToLoadInReader);
            }

            ae_startExtraction(true).then(() => {}).catch(err => {
                console.error("‡§Ü‡§Ç‡§§‡§∞‡§ø‡§ï ‡§≤‡§ø‡§Ç‡§ï ‡§è‡§ï‡•ç‡§∏‡§ü‡•ç‡§∞‡•à‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", err);
                showToast("‡§Ü‡§Ç‡§§‡§∞‡§ø‡§ï ‡§≤‡§ø‡§Ç‡§ï ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§", "error");
            }); 
            window.scrollTo(0,0); 
        }
    });


    async function downloadTextAsMp3(text, filename, btn) { 
        const originalText = btn.innerHTML;
        btn.innerHTML = '‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó...'; btn.disabled = true;
        showToast('MP3 ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...', 'info');

        const cleanedText = text.replace(/\s+/g, ' ').trim();
        if (!cleanedText) {
            showToast('MP3 ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§', 'error');
            btn.innerHTML = originalText; btn.disabled = false;
            return;
        }

        const chunks = cleanedText.match(/.{1,150}/g) || [];
        if (chunks.length === 0 && cleanedText.length > 0) { chunks.push(cleanedText); }
        if (chunks.length === 0) {
            showToast('MP3 ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ö‡§Ç‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§', 'error');
            btn.innerHTML = originalText; btn.disabled = false; return;
        }
        
        const audioBlobs = [];
        try {
            for (let i = 0; i < chunks.length; i++) {
                const chunkText = chunks[i];
                btn.innerHTML = `‡§≠‡§æ‡§ó ${i+1}/${chunks.length}...`;
                const ttsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(chunkText)}&tl=hi&client=tw-ob&prev=input`;
                const audioResponse = await fetch(`${MY_PRIVATE_PROXY}/?url=${encodeURIComponent(ttsUrl)}`, { signal: AbortSignal.timeout(20000) });
                if (!audioResponse.ok) throw new Error(`TTS API ‡§∏‡•á ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ (‡§∏‡•ç‡§ü‡•á‡§ü‡§∏: ${audioResponse.status}) ‡§ö‡§Ç‡§ï ${i+1} ‡§ï‡•á ‡§≤‡§ø‡§è‡•§`);
                const blob = await audioResponse.blob();
                if (blob.size === 0 || !blob.type.startsWith('audio/')) {
                    let errorDetail = '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø';
                    if (blob.type.startsWith('text/')) {
                        const errorText = await blob.text();
                        console.error("TTS API returned non-audio content:", errorText.substring(0, 500));
                        errorDetail = 'TTS ‡§®‡•á ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§ï‡•á ‡§¨‡§ú‡§æ‡§Ø ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§≤‡•å‡§ü‡§æ‡§Ø‡§æ‡•§';
                    }
                    throw new Error(`TTS API ‡§∏‡•á ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§≤‡§æ (‡§ö‡§Ç‡§ï ${i+1})‡•§ ${errorDetail}`);
                }
                audioBlobs.push(blob);
            }

            if (audioBlobs.length === 0) throw new Error('‡§ï‡•ã‡§à ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§°‡•á‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü‡•§');
            const combinedBlob = new Blob(audioBlobs, { type: 'audio/mpeg' });
            if (combinedBlob.size === 0) throw new Error('‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§¨‡•ç‡§≤‡•â‡§¨ ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à‡•§');

            const downloadUrl = URL.createObjectURL(combinedBlob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            const safeFilename = (filename || "audio").normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9\u0900-\u097F\s._-]/gi, '_').replace(/\s+/g, '_');
            a.download = `${safeFilename}.mp3`;
            document.body.appendChild(a); a.click(); a.remove(); 
            URL.revokeObjectURL(downloadUrl);
            showToast("MP3 ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¨‡§® ‡§ó‡§Ø‡§æ ‡§î‡§∞ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§ó‡§Ø‡§æ!", "success");
        } catch (error) {
            console.error('MP3 ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
            showToast(`MP3 ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`, 'error', 7000);
        } finally {
            btn.innerHTML = originalText; btn.disabled = false;
        }
    }

    async function loadNextArticleIfIdle() {
        if (!isLoadingNext && currentLinkIndex < allStoryLinks.length) {
            await loadNextArticle();
        }
    }

    async function loadNextArticle() {
        const loadingDiv = document.getElementById('ae_loading');
        const resultDiv = document.getElementById('ae_result');

        if (isLoadingNext || currentLinkIndex >= allStoryLinks.length) {
            if (loadingDiv) {
                if (allStoryLinks.length > 0 && currentLinkIndex >= allStoryLinks.length) {
                     loadingDiv.innerText = "‡§∏‡§≠‡•Ä ‡§ú‡•ç‡§û‡§æ‡§§ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§è‡•§";
                     setTimeout(() => { if(loadingDiv) loadingDiv.style.display = 'none'; }, 2000);
                } else if (allStoryLinks.length === 0 && resultDiv && resultDiv.innerHTML.trim() === '') { 
                    loadingDiv.style.display = 'none';
                }
            }
            return;
        }
        isLoadingNext = true;

        if (loadingDiv) {
            loadingDiv.style.display = 'block';
            const currentLoadingUrl = allStoryLinks[currentLinkIndex] || "";
            loadingDiv.innerText = `‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ (${currentLinkIndex + 1}/${allStoryLinks.length}) ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à: ${currentLoadingUrl.substring(0,50)}...`;
        }
        try {
            const link = allStoryLinks[currentLinkIndex];
            if (!link) { 
                console.warn("‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§≤‡§ø‡§Ç‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§á‡§Ç‡§°‡•á‡§ï‡•ç‡§∏ ‡§™‡§∞:", currentLinkIndex);
                currentLinkIndex++; 
                isLoadingNext = false;
                await loadNextArticleIfIdle(); 
                return;
            }

            const html = await fetchWithProxy(link);
            const doc = new DOMParser().parseFromString(html, "text/html");
            doc.head.insertAdjacentHTML('beforeend', `<base href="${link}">`);
            const article = new Readability(doc).parse();

            if (article && article.content) {
                if(resultDiv) resultDiv.appendChild(createStoryElement(article, link));
                const articleSettingsPanel = document.getElementById('article-settings-panel');
                if (articleSettingsPanel) articleSettingsPanel.style.display = 'flex';
                if (allStoryLinks.length === 1 || currentLinkIndex === 0) { 
                    const offlineArticleData = {
                        title: article.title, content: article.content, textContent: article.textContent,
                        byline: article.byline, url: link, savedAt: new Date().toISOString()
                    };
                    localStorage.setItem(STORAGE_KEY_OFFLINE_ARTICLE, JSON.stringify(offlineArticleData));
                    console.log("‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∏‡§π‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ:", article.title);
                }
            } else {
                showToast(`‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ "${link}" ‡§∏‡•á ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§®‡§ø‡§ï‡§æ‡§≤ ‡§∏‡§ï‡§æ‡•§`, 'warning');
                console.warn(`‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ "${link}" ‡§∏‡•á ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§®‡§ø‡§ï‡§æ‡§≤ ‡§∏‡§ï‡§æ‡•§`, article);
            }
            currentLinkIndex++;
        } catch (e) {
            const failedLink = allStoryLinks[currentLinkIndex] || "‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§≤‡§ø‡§Ç‡§ï";
            console.error(`‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ "${failedLink}" ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:`, e);
            showToast(`‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ "${failedLink}" ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'error');
            currentLinkIndex++; 
        } finally {
            isLoadingNext = false; 
            await loadNextArticleIfIdle(); 
            
            if (currentLinkIndex >= allStoryLinks.length && allStoryLinks.length > 0 && loadingDiv && loadingDiv.style.display !== 'none') {
                const toggleCrawlBtn = document.getElementById('toggleCrawlBtn');
                if (!toggleCrawlBtn || toggleCrawlBtn.style.display === 'none' || isCrawlingPaused) { 
                    loadingDiv.innerText = "‡§∏‡§≠‡•Ä ‡§ú‡•ç‡§û‡§æ‡§§ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§è‡•§";
                    setTimeout(() => { if(loadingDiv) loadingDiv.style.display = 'none'; }, 2000);
                }
            }
        }
    }
    
    function toggleDepthSelector() { 
        const crawlCheckbox = document.getElementById('crawlSiteToggle');
        const depthContainer = document.getElementById('depthSelectorContainer');
        if (crawlCheckbox && depthContainer) {
            depthContainer.style.display = crawlCheckbox.checked ? 'inline-block' : 'none';
        }
    }
    
    function toggleCrawling() {
        const toggleBtn = document.getElementById('toggleCrawlBtn');
        if (!toggleBtn) return;

        if (isCrawlingPaused) {
            isCrawlingPaused = false;
            toggleBtn.innerHTML = '‚èπÔ∏è ‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•á‡§Ç';
            showToast("‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡§ø‡§ú‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•Ä ‡§ó‡§à‡•§", "info");
        } else {
            isCrawlingPaused = true;
            toggleBtn.innerHTML = '‚ñ∂Ô∏è ‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡§ø‡§ú‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡§∞‡•á‡§Ç';
            showToast("‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•Ä ‡§ó‡§à‡•§", "warning");
        }
    }

    async function ae_startExtraction(isNavigationAction = false) { 
        const urlInput = document.getElementById('articleUrl').value.trim();
        const loadingDiv = document.getElementById('ae_loading');
        const resultDiv = document.getElementById('ae_result');
        const crawlSiteCheckbox = document.getElementById('crawlSiteToggle');
        const crawlDepthSelector = document.getElementById('crawlDepth');
        const toggleCrawlBtn = document.getElementById('toggleCrawlBtn');
        
        if (!urlInput) { showToast('‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï URL ‡§°‡§æ‡§≤‡•á‡§Ç‡•§', 'error'); return; }
        let initialUrlObj;
        try { 
            initialUrlObj = new URL(urlInput); 
        } catch (_) { 
            showToast('‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø URL ‡§°‡§æ‡§≤‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§', 'error'); return; 
        }

        if (!isNavigatingHistory && !isNavigationAction) {
             addToHistory(initialUrlObj.href);
        }

        if (loadingDiv) loadingDiv.style.display = 'block'; 
        if (resultDiv) resultDiv.innerHTML = '';
        allStoryLinks = []; 
        currentLinkIndex = 0;
        isLoadingNext = false;
        isCrawlingPaused = false; 
        if (toggleCrawlBtn) {
            toggleCrawlBtn.style.display = 'none'; 
            toggleCrawlBtn.innerHTML = '‚èπÔ∏è ‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•á‡§Ç';
        }

        if (speechApiSupported && speechSynth.speaking) speechSynth.cancel();
        const articleSettingsPanel = document.getElementById('article-settings-panel');
        if (articleSettingsPanel) articleSettingsPanel.style.display = 'none';

        const shouldCrawl = isNavigationAction ? false : crawlSiteCheckbox.checked;
        const selectedCrawlDepth = shouldCrawl ? parseInt(crawlDepthSelector.value, 10) : 0;
        
        try {
            if (loadingDiv) loadingDiv.innerText = "‡§™‡•á‡§ú ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...";
            const initialHtml = await fetchWithProxy(initialUrlObj.href); 
            const initialDoc = new DOMParser().parseFromString(initialHtml, "text/html");
            initialDoc.head.insertAdjacentHTML('beforeend', `<base href="${initialUrlObj.href}">`); 
            
            const mainArticleFromInitialUrl = new Readability(initialDoc.cloneNode(true)).parse();

            let initialUrlIsArticle = false;
            if (mainArticleFromInitialUrl && mainArticleFromInitialUrl.content && mainArticleFromInitialUrl.textContent && mainArticleFromInitialUrl.textContent.length > 150) {
                initialUrlIsArticle = true;
                if (allStoryLinks.length < MAX_TOTAL_ARTICLES_TO_QUEUE && !allStoryLinks.includes(initialUrlObj.href)) {
                    allStoryLinks.push(initialUrlObj.href);
                }
            }
            
            if (shouldCrawl && (!initialUrlIsArticle || selectedCrawlDepth > 0 || (allStoryLinks.length === 0 && !initialUrlIsArticle))) { 
                if (loadingDiv) loadingDiv.innerText = "‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§∏‡•á ‡§Ö‡§®‡•ç‡§Ø ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ñ‡•ã‡§ú‡•á ‡§ú‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç (‡§ó‡§π‡§∞‡§æ‡§à: " + selectedCrawlDepth +")...";
                if (toggleCrawlBtn) toggleCrawlBtn.style.display = 'inline-block';
                
                const queue = [{ url: initialUrlObj.href, depth: 0 }];
                const visitedForCrawling = new Set(); 
                
                let consecutiveFetchFailures = 0;
                
                while (queue.length > 0 && allStoryLinks.length < MAX_TOTAL_ARTICLES_TO_QUEUE && consecutiveFetchFailures < MAX_FETCH_FAILURES_IN_ROW) {
                    if (isCrawlingPaused) {
                        if (loadingDiv) loadingDiv.innerText = `‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•Ä ‡§ó‡§à... (${allStoryLinks.length} ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§Æ‡§ø‡§≤‡•á)`;
                        await new Promise(resolve => {
                            const checkResume = setInterval(() => {
                                if (!isCrawlingPaused) {
                                    clearInterval(checkResume);
                                    resolve();
                                }
                            }, 500); 
                        });
                        if (loadingDiv) loadingDiv.innerText = `‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡§ø‡§ú‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•Ä ‡§ó‡§à... (${allStoryLinks.length} ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§Æ‡§ø‡§≤‡•á)`;
                    }

                    const currentItem = queue.shift();
                    const currentUrl = currentItem.url;
                    const currentDepth = currentItem.depth;

                    if (visitedForCrawling.has(currentUrl)) { 
                        continue;
                    }
                    visitedForCrawling.add(currentUrl);

                    if (loadingDiv) loadingDiv.innerText = `‡§≤‡§ø‡§Ç‡§ï ‡§ñ‡•ã‡§ú ‡§∞‡§π‡§æ ‡§π‡•à (${visitedForCrawling.size} ‡§™‡•á‡§ú ‡§¶‡•á‡§ñ‡•á, ${allStoryLinks.length} ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§Æ‡§ø‡§≤‡•á): ${currentUrl.substring(0,40)}...`;
                    
                    let pageHtml;
                    if (currentUrl === initialUrlObj.href && currentDepth === 0 && initialHtml) { 
                        pageHtml = initialHtml;
                    } else {
                        try {
                            pageHtml = await fetchWithProxy(currentUrl);
                            consecutiveFetchFailures = 0; 
                        } catch (fetchError) { 
                            console.warn(`URL ${currentUrl} ‡§ï‡•ã ‡§´‡§º‡•á‡§ö ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤ (‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó): ${fetchError.message}`);
                            consecutiveFetchFailures++;
                            if (consecutiveFetchFailures >= MAX_FETCH_FAILURES_IN_ROW) {
                                showToast("‡§ï‡§à ‡§™‡•á‡§ú‡•ã‡§Ç ‡§ï‡•ã ‡§´‡§º‡•á‡§ö ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤, ‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à‡•§", "error");
                                break;
                            }
                            continue;
                        }
                    }

                    const pageDoc = new DOMParser().parseFromString(pageHtml, "text/html");
                    pageDoc.head.insertAdjacentHTML('beforeend', `<base href="${currentUrl}">`);

                    if (!allStoryLinks.includes(currentUrl)) { 
                        const parsedArticle = new Readability(pageDoc.cloneNode(true)).parse();
                        if (parsedArticle && parsedArticle.content && parsedArticle.textContent && parsedArticle.textContent.length > 150) {
                            if (allStoryLinks.length < MAX_TOTAL_ARTICLES_TO_QUEUE) {
                                allStoryLinks.push(currentUrl); 
                            }
                        }
                    }

                    if (currentDepth < selectedCrawlDepth && allStoryLinks.length < MAX_TOTAL_ARTICLES_TO_QUEUE) {
                        const linksOnPage = new Set();
                        pageDoc.querySelectorAll('a[href]').forEach(a => {
                            try {
                                const absUrl = new URL(a.href, currentUrl).href.split('#')[0];
                                const siteOrigin = initialUrlObj.origin;

                                if (absUrl.startsWith(siteOrigin) && 
                                    !visitedForCrawling.has(absUrl) && 
                                    !queue.some(qItem => qItem.url === absUrl) && 
                                    !allStoryLinks.includes(absUrl) && 
                                    !absUrl.match(/\.(jpeg|jpg|gif|png|pdf|zip|css|js|xml|mp3|mp4|webp|svg|woff|ttf|ico|json|txt|php|asp|cgi)$/i)) {
                                    linksOnPage.add(absUrl);
                                }
                            } catch (e) { /* ignore invalid URLs */ }
                        });

                        for (const link of linksOnPage) {
                            if (queue.length + allStoryLinks.length < MAX_TOTAL_ARTICLES_TO_QUEUE + 30) { 
                                if(!visitedForCrawling.has(link) && !queue.some(qItem => qItem.url === link)){ 
                                     queue.push({ url: link, depth: currentDepth + 1 });
                                }
                            } else {
                                break; 
                            }
                        }
                    }
                } 
                if (toggleCrawlBtn) toggleCrawlBtn.style.display = 'none'; 
            } else if (!initialUrlIsArticle && !isNavigationAction && !shouldCrawl) { 
                showToast("‡§Ø‡§π URL ‡§è‡§ï ‡§∏‡§ø‡§Ç‡§ó‡§≤ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§™‡•ç‡§∞‡§§‡•Ä‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§§‡§æ‡•§ ‡§Ö‡§®‡•ç‡§Ø ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ñ‡•ã‡§ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ö‡•á‡§ï‡§¨‡•â‡§ï‡•ç‡§∏ ‡§ï‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç‡•§", "warning", 6000);
                if (loadingDiv) loadingDiv.style.display = 'none';
                return;
            }
            
            if (allStoryLinks.length > 0) {
                let toastMsg = `${allStoryLinks.length} ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§Æ‡§ø‡§≤‡•á‡•§`;
                if(isNavigationAction) toastMsg = "‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...";
                else if (allStoryLinks.length === 1 && !shouldCrawl) toastMsg = "‡§∏‡§ø‡§Ç‡§ó‡§≤ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§Æ‡§ø‡§≤‡§æ‡•§";
                else if (allStoryLinks.length === 1 && shouldCrawl) toastMsg = "1 ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§Æ‡§ø‡§≤‡§æ (‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§ï‡•á ‡§¨‡§æ‡§¶)‡•§";
                showToast(toastMsg, "info", 2000); 
                
                currentLinkIndex = 0; 
                isLoadingNext = false; 
                await loadNextArticleIfIdle(); 
                
                if (currentLinkIndex < allStoryLinks.length) { 
                     await loadNextArticleIfIdle();
                }
            } else {
                if (resultDiv) resultDiv.innerHTML = `<p class="error-message">‡§á‡§∏ URL ‡§Ø‡§æ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó ‡§∏‡•á ‡§ï‡•ã‡§à ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</p>`;
                if (loadingDiv) loadingDiv.style.display = 'none';
            }
            
            if (loadingDiv && currentLinkIndex >= allStoryLinks.length && allStoryLinks.length === 0) {
                loadingDiv.style.display = 'none'; 
            }

        } catch (error) { 
            console.error("Extraction error:", error);
            if (resultDiv) resultDiv.innerHTML = `<p class="error-message">‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}</p>`;
            showToast(`‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`, 'error', 7000);
            if (loadingDiv) loadingDiv.style.display = 'none';
            if (toggleCrawlBtn) toggleCrawlBtn.style.display = 'none';
        }
    }
    
    function clearResults() { 
        const resultDiv = document.getElementById('ae_result');
        const urlInput = document.getElementById('articleUrl');
        const articleSettingsPanel = document.getElementById('article-settings-panel');
        const toggleCrawlBtn = document.getElementById('toggleCrawlBtn');


        if (resultDiv) resultDiv.innerHTML = '';
        if (urlInput) urlInput.value = '';
        allStoryLinks = []; currentLinkIndex = 0;
        isLoadingNext = false;
        isCrawlingPaused = false;
        if (toggleCrawlBtn) {
            toggleCrawlBtn.style.display = 'none';
            toggleCrawlBtn.innerHTML = '‚èπÔ∏è ‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•á‡§Ç';
        }


        if (speechApiSupported && speechSynth.speaking) speechSynth.cancel();
        if (articleSettingsPanel) articleSettingsPanel.style.display = 'none';
        
        navigationHistory = [];
        currentHistoryIndex = -1;
        updateHistoryButtons();
        const historyContainer = document.getElementById('internalNavHistoryContainer');
        if(historyContainer) historyContainer.style.display = 'none';

        showToast("‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç‡•§");
    }

    function clearUrlInput() {
        const articleUrlInput = document.getElementById('articleUrl');
        if (articleUrlInput) {
            articleUrlInput.value = '';
            articleUrlInput.focus();
        }
    }

    function filterExtractedArticles() {
        const searchTerm = document.getElementById('extractorSearch').value.toLowerCase();
        const resultBox = document.getElementById('ae_result');
        if (!resultBox) return;

        const articles = resultBox.querySelectorAll('.single-story');
        
        articles.forEach(articleDiv => {
            const searchableText = (articleDiv.dataset.textContentForSearch || "").toLowerCase();
            const titleText = (articleDiv.querySelector('h3')?.textContent || "").toLowerCase();
            const combinedText = searchableText + titleText;


            if (combinedText.includes(searchTerm)) {
                articleDiv.style.display = 'block';
            } else {
                articleDiv.style.display = 'none';
            }
        });
    }

    function clearExtractorSearch() {
        const searchInput = document.getElementById('extractorSearch');
        if (searchInput) {
            searchInput.value = '';
            filterExtractedArticles(); 
        }
    }


    // --- Library Functions --- 
    function getLibrary() { return JSON.parse(localStorage.getItem(STORAGE_KEY_LIBRARY) || '{}'); } 
    function saveLibrary(library) { 
        localStorage.setItem(STORAGE_KEY_LIBRARY, JSON.stringify(library)); 
        updateLibraryCount(); 
        populateTagFilter(); // ‡§ü‡•à‡§ó ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        if(document.getElementById('MyLibrary').style.display === 'block') { // ‡§Ø‡§¶‡§ø ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§ü‡•à‡§¨ ‡§ñ‡•Å‡§≤‡§æ ‡§π‡•à ‡§§‡•ã ‡§â‡§∏‡•á ‡§∞‡•Ä‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
            loadLibrary();
        }
    }
    function isSaved(url) { return !!getLibrary()[btoa(encodeURIComponent(url))]; }
    
    function toggleSaveArticle(article, url, btn) { 
        const library = getLibrary(); 
        const storyId = btoa(encodeURIComponent(url));
        if (library[storyId]) {
            delete library[storyId];
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    action: 'delete-article-from-cache',
                    url: url
                });
            }
            btn.innerHTML = 'ü§ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç';
            btn.title = '‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç';
            btn.classList.remove('saved');
            showToast("‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§∏‡•á ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§");
        } else {
            const articleToStore = { 
                title: article.title || "‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§®‡§π‡•Ä‡§Ç", 
                content: article.content || "", 
                textContent: article.textContent || "", 
                byline: article.byline || "", 
                url: url,
                savedAt: new Date().toISOString(),
                tags: [] // ‡§®‡§Ø‡§æ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤, ‡§ï‡•ã‡§à ‡§ü‡•à‡§ó ‡§®‡§π‡•Ä‡§Ç
            };
            library[storyId] = articleToStore;
            
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    action: 'cache-article',
                    url: url,
                    article: articleToStore
                });
            }
            btn.innerHTML = '‚ù§Ô∏è ‡§∏‡•á‡§µ ‡§π‡•à';
            btn.title = '‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§∏‡•á ‡§π‡§ü‡§æ‡§è‡§Ç';
            btn.classList.add('saved');
            showToast("‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ!", "success");
        }
        saveLibrary(library); // ‡§Ø‡§π loadLibrary ‡§î‡§∞ populateTagFilter ‡§ï‡•ã ‡§≠‡•Ä ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§ó‡§æ ‡§Ø‡§¶‡§ø ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•ã
    }

    function loadLibrary() { 
        const library = getLibrary();
        const listDiv = document.getElementById('library-list');
        const searchTermInput = document.getElementById('librarySearch');
        const sortSelect = document.getElementById('librarySort');
        const tagFilterSelect = document.getElementById('libraryTagFilter');

        if (!listDiv || !searchTermInput || !sortSelect) return;

        const searchTerm = searchTermInput.value.toLowerCase();
        const sortOrder = sortSelect.value;
        const selectedTag = tagFilterSelect ? tagFilterSelect.value : "";


        let itemsArray = Object.entries(library).map(([id, item]) => ({id, ...item}));

        if (searchTerm) {
            itemsArray = itemsArray.filter(item => item.title && item.title.toLowerCase().includes(searchTerm));
        }
        if (selectedTag) {
            itemsArray = itemsArray.filter(item => item.tags && item.tags.includes(selectedTag));
        }


        itemsArray.sort((a, b) => {
            switch (sortOrder) {
                case 'date_asc': return new Date(a.savedAt) - new Date(b.savedAt);
                case 'title_asc': return (a.title || "").localeCompare(b.title || "", 'hi');
                case 'title_desc': return (b.title || "").localeCompare(a.title || "", 'hi');
                case 'date_desc': default: return new Date(b.savedAt) - new Date(a.savedAt);
            }
        });
        
        listDiv.innerHTML = (itemsArray.length === 0) ? '<p>‡§Ü‡§™‡§ï‡•Ä ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à ‡§Ø‡§æ ‡§ñ‡•ã‡§ú/‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</p>' : '';
        
        itemsArray.forEach(itemData => {
            const itemDiv = document.createElement('div'); 
            itemDiv.className = 'library-item';
            itemDiv.id = `lib-item-${btoa(encodeURIComponent(itemData.url))}`; 

            const titleSpan = document.createElement('span'); 
            titleSpan.className = 'item-title'; 
            titleSpan.textContent = itemData.title || "‡§Ö‡§®‡§æ‡§Æ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤";
            titleSpan.onclick = () => showSavedArticle(itemData);
            
            const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '‡§π‡§ü‡§æ‡§è‡§Å';
            deleteBtn.onclick = (e) => { 
                e.stopPropagation(); 
                const currentLib = getLibrary();
                delete currentLib[itemData.id]; 
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        action: 'delete-article-from-cache',
                        url: itemData.url
                    });
                }
                saveLibrary(currentLib); 
                // loadLibrary(); // saveLibrary ‡§á‡§∏‡•á ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§ó‡§æ
                const libArticleView = document.getElementById('library-article-view');
                if (libArticleView && libArticleView.dataset.currentArticleUrl === itemData.url) {
                    libArticleView.style.display = 'none'; 
                    libArticleView.dataset.hasContent = 'false';
                }
                showToast("‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§");
            };
            itemDiv.append(titleSpan, deleteBtn);
            listDiv.appendChild(itemDiv);
        });
    }
    function filterLibrary() { loadLibrary(); }

    async function showSavedArticle(articleDataFromLocalStorage) { 
        const libArticleView = document.getElementById('library-article-view');
        const libTitle = document.getElementById('lib-article-title');
        const libOriginalUrl = document.getElementById('lib-article-original-url');
        const libTextContent = document.getElementById('lib-article-text-content');
        const libShareBtn = document.getElementById('shareLibArticleBtn');

        if (libArticleView && libTitle && libOriginalUrl && libTextContent && libShareBtn) {
            libTitle.textContent = articleDataFromLocalStorage.title || "‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç";
            libOriginalUrl.href = articleDataFromLocalStorage.url;
            libOriginalUrl.textContent = articleDataFromLocalStorage.url.length > 60 ? articleDataFromLocalStorage.url.substring(0, 60) + "..." : articleDataFromLocalStorage.url;
            
            libTextContent.textContent = "‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...";
            let articleToShare = articleDataFromLocalStorage; // Default to localStorage data

            try {
                // ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§µ‡§∞‡•ç‡§ï‡§∞ fetch ‡§ï‡•ã ‡§á‡§Ç‡§ü‡§∞‡§∏‡•á‡§™‡•ç‡§ü ‡§ï‡§∞‡•á‡§ó‡§æ
                const response = await fetch(articleDataFromLocalStorage.url); 
                if (!response.ok) {
                    throw new Error(`‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§†‡•Ä‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§•‡•Ä (‡§∏‡•ç‡§ü‡•á‡§ü‡§∏: ${response.status}), localStorage ‡§´‡§º‡•â‡§≤‡§¨‡•à‡§ï ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ URL: ${articleDataFromLocalStorage.url}`);
                }
                const fetchedArticleData = await response.json(); // SW JSON ‡§≠‡•á‡§ú ‡§∞‡§π‡§æ ‡§π‡•à
                libTextContent.textContent = fetchedArticleData.textContent || "‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§";
                articleToShare = fetchedArticleData; // ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ‡§°‡•á‡§ü‡§æ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
                console.log("[App] Article loaded from SW/Cache:", fetchedArticleData.title);
            } catch (error) {
                console.warn('[App] ‡§ï‡•à‡§∂/‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§∏‡•á ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§´‡§º‡•á‡§ö ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤, localStorage ‡§°‡•á‡§ü‡§æ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à:', error);
                libTextContent.textContent = articleDataFromLocalStorage.textContent || "‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§";
                showToast("‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§¶‡§ø‡§ñ‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à (‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§ï‡•á ‡§ï‡§æ‡§∞‡§£)‡•§", "warning");
            }
            
            libShareBtn.onclick = () => shareLibraryArticle(articleToShare);

            applySavedLibraryFontSize(); 
            displayArticleTags(articleDataFromLocalStorage.url, articleDataFromLocalStorage.tags || []);
            
            libArticleView.style.display = 'block';
            libArticleView.dataset.hasContent = 'true';
            libArticleView.dataset.currentArticleUrl = articleDataFromLocalStorage.url;

            document.querySelectorAll('.library-item.selected').forEach(el => el.classList.remove('selected'));
            const listItemId = `lib-item-${btoa(encodeURIComponent(articleDataFromLocalStorage.url))}`;
            const selectedListItem = document.getElementById(listItemId);
            if (selectedListItem) {
                selectedListItem.classList.add('selected');
            }

        } else { 
            console.error("‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§µ‡•ç‡§Ø‡•Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§§‡§§‡•ç‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡•§");
            showToast("‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§", "error");
        }
        const articleSettingsPanel = document.getElementById('article-settings-panel');
        if (articleSettingsPanel) articleSettingsPanel.style.display = 'none';
        updateHistoryButtons(); 
    }
    
    // --- Library Tag Functions ---
    function populateTagFilter() {
        const library = getLibrary();
        const allTags = new Set();
        Object.values(library).forEach(item => {
            if (item.tags) item.tags.forEach(tag => allTags.add(tag));
        });

        const filterSelect = document.getElementById('libraryTagFilter');
        if (!filterSelect) return;
        
        const currentSelectedValue = filterSelect.value; 
        filterSelect.innerHTML = '<option value="">‡§∏‡§≠‡•Ä ‡§ü‡•à‡§ó</option>'; 

        Array.from(allTags).sort().forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            filterSelect.appendChild(option);
        });
        if (Array.from(allTags).includes(currentSelectedValue)) {
             filterSelect.value = currentSelectedValue; 
        }
    }

    function displayArticleTags(articleUrl, tagsArray) {
        const currentTagsDiv = document.getElementById('lib-article-current-tags');
        if (!currentTagsDiv) return;
        currentTagsDiv.innerHTML = '';
        if (tagsArray && tagsArray.length > 0) {
            tagsArray.forEach(tag => {
                const tagSpan = document.createElement('span');
                tagSpan.className = 'tag-item';
                tagSpan.textContent = tag;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'tag-remove-btn';
                removeBtn.textContent = '‚úó';
                removeBtn.title = `‡§ü‡•à‡§ó ‡§π‡§ü‡§æ‡§è‡§Ç: ${tag}`;
                removeBtn.onclick = () => removeTagFromCurrentLibraryArticle(tag);

                tagSpan.appendChild(removeBtn);
                currentTagsDiv.appendChild(tagSpan);
            });
        } else {
            currentTagsDiv.innerHTML = '<em>‡§ï‡•ã‡§à ‡§ü‡•à‡§ó ‡§®‡§π‡•Ä‡§Ç‡•§</em>';
        }
    }

    function addTagToCurrentLibraryArticle() {
        const newTagInput = document.getElementById('lib-new-tag-input');
        const libArticleView = document.getElementById('library-article-view');
        if (!newTagInput || !libArticleView) return;
        const currentArticleUrl = libArticleView.dataset.currentArticleUrl;
        
        if (!currentArticleUrl || !newTagInput.value.trim()) {
            showToast("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ü‡•à‡§ó ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§°‡§æ‡§≤‡•á‡§Ç ‡§Ø‡§æ ‡§è‡§ï ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§", "warning");
            return;
        }

        const tagName = newTagInput.value.trim().toLowerCase();
        const library = getLibrary();
        const storyId = btoa(encodeURIComponent(currentArticleUrl));

        if (library[storyId]) {
            if (!library[storyId].tags) library[storyId].tags = [];
            if (!library[storyId].tags.includes(tagName)) {
                library[storyId].tags.push(tagName);
                saveLibrary(library); 
                displayArticleTags(currentArticleUrl, library[storyId].tags);
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        action: 'cache-article',
                        url: currentArticleUrl,
                        article: library[storyId] 
                    });
                }
                newTagInput.value = '';
                showToast(`‡§ü‡•à‡§ó "${tagName}" ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ‡•§`, "success");
            } else {
                showToast(`‡§ü‡•à‡§ó "${tagName}" ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à‡•§`, "warning");
            }
        } else {
            showToast("‡§ü‡•à‡§ó ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§", "error");
        }
    }

    function removeTagFromCurrentLibraryArticle(tagName) {
        const libArticleView = document.getElementById('library-article-view');
        if(!libArticleView) return;
        const currentArticleUrl = libArticleView.dataset.currentArticleUrl;

        if (!currentArticleUrl || !tagName) return;

        const library = getLibrary();
        const storyId = btoa(encodeURIComponent(currentArticleUrl));

        if (library[storyId] && library[storyId].tags) {
            library[storyId].tags = library[storyId].tags.filter(t => t !== tagName);
            saveLibrary(library);
            displayArticleTags(currentArticleUrl, library[storyId].tags);
             if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    action: 'cache-article',
                    url: currentArticleUrl,
                    article: library[storyId] 
                });
            }
            showToast(`‡§ü‡•à‡§ó "${tagName}" ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§`);
        }
    }


    async function copyLibraryArticleText() {
        const textContentDiv = document.getElementById('lib-article-text-content');
        const titleElem = document.getElementById('lib-article-title');
        const urlElem = document.getElementById('lib-article-original-url');

        if (!textContentDiv || !titleElem || !urlElem) {
            showToast("‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§§‡§§‡•ç‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡•§", "error");
            return;
        }

        const title = titleElem.textContent || "";
        const url = urlElem.href || "";
        const contentToCopy = textContentDiv.textContent || "";

        if (!contentToCopy.trim()) {
            showToast('‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§', 'error');
            return;
        }

        const textToClipboard = `‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï: ${title}\n‡§Æ‡•Ç‡§≤ URL: ${url}\n\n${contentToCopy}`;
        const copyButton = document.querySelector('#library-article-view button[onclick="copyLibraryArticleText()"]'); 

        if (navigator.clipboard && window.isSecureContext) { 
            try {
                if (copyButton) copyButton.focus(); 
                else document.body.focus(); 
                
                await new Promise(resolve => setTimeout(resolve, 100)); 

                await navigator.clipboard.writeText(textToClipboard);
                showToast('‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ!', 'success');
                if (copyButton) { 
                    const originalButtonText = copyButton.textContent;
                    copyButton.textContent = '‚úÖ ‡§ï‡•â‡§™‡•Ä ‡§π‡•Å‡§Ü';
                    setTimeout(() => { copyButton.textContent = originalButtonText; }, 2000);
                }
                return; 
            } catch (err) {
                console.warn('navigator.clipboard.writeText ‡§µ‡§ø‡§´‡§≤:', err.name, err.message, ' - ‡§´‡•â‡§≤‡§¨‡•à‡§ï ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§');
            }
        }

        const textArea = document.createElement("textarea");
        textArea.value = textToClipboard;
        textArea.style.position = "fixed"; 
        textArea.style.top = "-9999px";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        
        let success = false;
        try {
            textArea.select(); 
            textArea.setSelectionRange(0, 99999); 
            success = document.execCommand('copy');
        } catch (errFallback) {
            console.error('Fallback copy execCommand failed:', errFallback);
            success = false;
        }
        
        document.body.removeChild(textArea);

        if (success) {
            showToast('‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü (‡§´‡•â‡§≤‡§¨‡•à‡§ï) ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ!', 'success');
            if (copyButton) {
                const originalButtonText = copyButton.textContent;
                copyButton.textContent = '‚úÖ ‡§ï‡•â‡§™‡•Ä ‡§π‡•Å‡§Ü';
                setTimeout(() => { copyButton.textContent = originalButtonText; }, 2000);
            }
        } else {
            showToast('‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§Ø‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§', 'error', 5000);
            try { window.prompt("‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è: Ctrl+C / Cmd+C, ‡§´‡§ø‡§∞ Enter ‡§¶‡§¨‡§æ‡§è‡§Ç", textToClipboard); } catch(e) {}
        }
    }

    async function shareLibraryArticle(articleData) { 
        if (!articleData || !articleData.title || !articleData.url || !articleData.textContent) {
            showToast("‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§", "error");
            return;
        }

        const title = articleData.title;
        const url = articleData.url; 
        const fullTextContent = articleData.textContent; 

        if (!fullTextContent.trim() && !title.trim()) {
             showToast("‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error");
            return;
        }
        
        let shareText = `‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï: ${title}\n`;
        shareText += `‡§Æ‡•Ç‡§≤ URL: ${url}\n\n`;
        shareText += `‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü:\n${fullTextContent}`;
        
        const MAX_SHARE_TEXT_LENGTH = 2000; 
        if (shareText.length > MAX_SHARE_TEXT_LENGTH) {
            shareText = shareText.substring(0, MAX_SHARE_TEXT_LENGTH) + "\n\n... (‡§î‡§∞ ‡§≠‡•Ä ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü)";
            showToast("‡§™‡•Ç‡§∞‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§π‡•Å‡§§ ‡§≤‡§Ç‡§¨‡§æ ‡§π‡•à, ‡§á‡§∏‡•á ‡§õ‡•ã‡§ü‡§æ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§", "warning", 4000);
        }

        const shareData = { title: title, text: shareText, url: url };

        if (navigator.share) { 
            try {
                await navigator.share(shareData);
                showToast('‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!', 'success');
            } catch (err) {
                console.error('‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', err);
                if (err.name !== 'AbortError') {
                    showToast(`‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${err.message}`, 'error');
                }
            }
        } else {
            displayFallbackShareOptions(shareData); 
        }
    }

    function displayFallbackShareOptions(shareData) {
        const existingModal = document.getElementById('fallbackShareModal');
        if (existingModal) existingModal.remove();

        const fallbackContainer = document.createElement('div');
        fallbackContainer.id = 'fallbackShareModal';
        fallbackContainer.className = 'fallback-share-modal';

        const closeBtn = document.createElement('button');
        closeBtn.textContent = '‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç';
        closeBtn.className = 'danger';
        closeBtn.onclick = () => fallbackContainer.remove();

        const heading = document.createElement('h4');
        heading.textContent = '‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç';
        
        const instruction = document.createElement('p');
        instruction.textContent = '‡§®‡•Ä‡§ö‡•á ‡§¶‡§ø‡§è ‡§ó‡§è ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ã ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§∂‡•á‡§Ø‡§∞‡§ø‡§Ç‡§ó ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™‡•ã‡§Ç ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç:';
        
        const textArea = document.createElement('textarea');
        textArea.readOnly = true;
        textArea.value = shareData.text || (shareData.title + "\n" + shareData.url); 
        
        const copyBtnModal = document.createElement('button'); 
        copyBtnModal.textContent = '‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç';
        copyBtnModal.className = 'primary';
        copyBtnModal.onclick = async () => {
            try {
                await navigator.clipboard.writeText(textArea.value);
                showToast("‡§∂‡•á‡§Ø‡§∞ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ!", "success");
            } catch (e) {
                showToast("‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§", "error");
            }
        };

        const whatsappLink = document.createElement('a');
        whatsappLink.href = `https://wa.me/?text=${encodeURIComponent(shareData.title + '\n' + shareData.url + '\n\n' + (shareData.text && shareData.text.length > 1500 ? shareData.text.substring(0, 1500) + "..." : (shareData.text || '')) )}`;
        whatsappLink.target = '_blank';
        whatsappLink.textContent = 'WhatsApp';
        
        const emailLink = document.createElement('a');
        const emailBody = `‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤: ${shareData.title}\nURL: ${shareData.url}\n\n${(shareData.text || '')}`;
        emailLink.href = `mailto:?subject=${encodeURIComponent(shareData.title)}&body=${encodeURIComponent(emailBody)}`;
        emailLink.textContent = '‡§à‡§Æ‡•á‡§≤';

        fallbackContainer.appendChild(closeBtn);
        fallbackContainer.appendChild(heading);
        fallbackContainer.appendChild(instruction);
        fallbackContainer.appendChild(textArea);
        const buttonContainer = document.createElement('div');
        buttonContainer.style.marginTop = '10px';
        buttonContainer.appendChild(copyBtnModal);
        buttonContainer.appendChild(whatsappLink);
        buttonContainer.appendChild(emailLink);
        fallbackContainer.appendChild(buttonContainer);

        document.body.appendChild(fallbackContainer);
    }

    function updateLibraryCount() { 
        const countSpan = document.getElementById('library-count');
        if (countSpan) countSpan.textContent = `(${Object.keys(getLibrary()).length})`;
    }

    // --- Bookmark Functions ---
    function getBookmarks() { return JSON.parse(localStorage.getItem(STORAGE_KEY_BOOKMARKS) || '[]'); }
    function saveBookmarks(bookmarks) {
        localStorage.setItem(STORAGE_KEY_BOOKMARKS, JSON.stringify(bookmarks));
        updateBookmarkCount();
        populateBookmarkFolderSelectors(); 
        if(document.getElementById('Bookmarks').style.display === 'block') { 
            loadBookmarks();
        }
    }

    function addBookmark() {
        const nameInput = document.getElementById('bookmarkName');
        const urlInput = document.getElementById('bookmarkUrl');
        const folderSelect = document.getElementById('bookmarkAssignFolder');

        const name = nameInput.value.trim();
        const url = urlInput.value.trim();
        const folder = folderSelect.value || 'Default';

        if (!url) {
            showToast("‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï URL ‡§°‡§æ‡§≤‡•á‡§Ç‡•§", "error");
            return;
        }
        try { new URL(url); } catch (_) {
            showToast("‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø URL ‡§°‡§æ‡§≤‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§", "error");
            return;
        }

        const bookmarks = getBookmarks();
        if (bookmarks.some(bm => bm.url === url)) {
            showToast("‡§Ø‡§π URL ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•Å‡§Ü ‡§π‡•à‡•§", "warning");
            return;
        }

        bookmarks.push({ name: name || url, url: url, addedAt: new Date().toISOString(), folder: folder });
        saveBookmarks(bookmarks);
        showToast("‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ!", "success");
        if(nameInput) nameInput.value = '';
        if(urlInput) urlInput.value = '';
    }

    function loadBookmarks() {
        let bookmarks = getBookmarks(); 
        const listDiv = document.getElementById('bookmark-list');
        const folderFilterSelect = document.getElementById('bookmarkFolderFilter');
        const selectedFolder = folderFilterSelect ? folderFilterSelect.value : "";

        if (!listDiv) return;
        populateBookmarkFolderSelectors(); 

        if (selectedFolder) {
            bookmarks = bookmarks.filter(bm => bm.folder === selectedFolder);
        }
        
        bookmarks.sort((a,b) => new Date(b.addedAt) - new Date(a.addedAt));
        
        listDiv.innerHTML = (bookmarks.length === 0) ? '<p>‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§Ø‡§æ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</p>' : '';

        bookmarks.forEach((bm) => { 
            const itemDiv = document.createElement('div');
            itemDiv.className = 'bookmark-item'; 

            const titleDiv = document.createElement('div');
            titleDiv.className = 'item-title'; 
            titleDiv.style.cursor = 'pointer';
            titleDiv.onclick = () => {
                const articleUrlInput = document.getElementById('articleUrl');
                if(articleUrlInput) articleUrlInput.value = bm.url;
                openTool({currentTarget: document.querySelector('.tab-link[onclick*="ArticleExtractor"]')}, 'ArticleExtractor');
                ae_startExtraction(); 
            };
            
            const nameSpan = document.createElement('span');
            nameSpan.style.fontWeight = 'bold';
            nameSpan.textContent = bm.name;
            
            const urlSpan = document.createElement('span');
            urlSpan.textContent = ` (${bm.url.length > 30 ? bm.url.substring(0, 30) + "..." : bm.url})`;
            urlSpan.style.fontSize = "0.8em";
            urlSpan.style.opacity = "0.7";
            urlSpan.style.marginLeft = "5px";

            const folderSpan = document.createElement('span'); 
            folderSpan.textContent = ` [${bm.folder || 'Default'}]`;
            folderSpan.style.fontSize = "0.7em";
            folderSpan.style.opacity = "0.6";
            folderSpan.style.marginLeft = "5px";


            titleDiv.appendChild(nameSpan);
            titleDiv.appendChild(urlSpan);
            titleDiv.appendChild(folderSpan);


            const controlsDiv = document.createElement('div');
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn'; 
            deleteBtn.textContent = '‡§π‡§ü‡§æ‡§è‡§Å';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                const updatedBookmarks = getBookmarks().filter(bookmark => bookmark.url !== bm.url);
                saveBookmarks(updatedBookmarks); 
            };
            controlsDiv.appendChild(deleteBtn);
            
            itemDiv.append(titleDiv, controlsDiv);
            listDiv.appendChild(itemDiv);
        });
        updateBookmarkCount();
    }

    function getBookmarkFolders() {
        const bookmarks = getBookmarks();
        const folders = new Set(['Default']);
        bookmarks.forEach(bm => {
            if (bm.folder) folders.add(bm.folder);
        });
        return Array.from(folders).sort((a,b) => a.localeCompare(b, 'hi'));
    }

    function populateBookmarkFolderSelectors() {
        const folders = getBookmarkFolders();
        const filterSelect = document.getElementById('bookmarkFolderFilter');
        const assignSelect = document.getElementById('bookmarkAssignFolder');

        if (filterSelect) {
            const currentFilterValue = filterSelect.value;
            filterSelect.innerHTML = '<option value="">‡§∏‡§≠‡•Ä ‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞</option>';
            folders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder; option.textContent = folder;
                filterSelect.appendChild(option);
            });
            if (folders.includes(currentFilterValue)) filterSelect.value = currentFilterValue;
        }
        if (assignSelect) {
            const currentAssignValue = assignSelect.value;
            assignSelect.innerHTML = ''; 
            folders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder; option.textContent = folder;
                assignSelect.appendChild(option);
            });
             if (folders.includes(currentAssignValue)) assignSelect.value = currentAssignValue;
             else if (folders.length > 0) assignSelect.value = folders.find(f => f === 'Default') || folders[0]; 
        }
    }
    
    function createBookmarkFolder() {
        const folderNameInput = document.getElementById('newBookmarkFolderName');
        if (!folderNameInput || !folderNameInput.value.trim()) {
            showToast("‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§°‡§æ‡§≤‡•á‡§Ç‡•§", "error");
            return;
        }
        const folderName = folderNameInput.value.trim();
        const existingFolders = getBookmarkFolders();
        if (existingFolders.map(f => f.toLowerCase()).includes(folderName.toLowerCase())) {
            showToast(`‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ "${folderName}" ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à‡•§`, "warning");
            return;
        }
        
        const assignSelect = document.getElementById('bookmarkAssignFolder');
        const filterSelect = document.getElementById('bookmarkFolderFilter');
        if(assignSelect && !Array.from(assignSelect.options).some(opt => opt.value === folderName)) {
            const option = document.createElement('option');
            option.value = folderName; option.textContent = folderName;
            assignSelect.appendChild(option);
            assignSelect.value = folderName; // ‡§®‡§è ‡§¨‡§®‡§æ‡§è ‡§ó‡§è ‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ ‡§ï‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç
        }
         if(filterSelect && !Array.from(filterSelect.options).some(opt => opt.value === folderName)) {
            const optionF = document.createElement('option');
            optionF.value = folderName; optionF.textContent = folderName;
            filterSelect.appendChild(optionF);
        }
        showToast(`‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ "${folderName}" ‡§Ö‡§¨ ‡§ö‡§Ø‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à‡•§`, "info");
        folderNameInput.value = '';
    }


    function updateBookmarkCount() {
        const countSpan = document.getElementById('bookmark-count');
        if (countSpan) {
            countSpan.textContent = `(${getBookmarks().length})`;
        }
    }


    // --- UI Enhancement Functions ---
    function changeFontSize(delta) { 
        const resultBox = document.getElementById('ae_result');
        if (!resultBox) return;
        let currentSize = parseFloat(window.getComputedStyle(resultBox).fontSize);
        currentSize += delta;
        if (currentSize < 10) currentSize = 10;
        if (currentSize > 30) currentSize = 30;
        resultBox.style.fontSize = currentSize + 'px';
        localStorage.setItem(STORAGE_KEY_FONT_SIZE, currentSize);
    }
    function applySavedFontSize() { 
        const savedSize = localStorage.getItem(STORAGE_KEY_FONT_SIZE);
        const resultBox = document.getElementById('ae_result');
        if (savedSize && resultBox) {
            resultBox.style.fontSize = savedSize + 'px';
        }
    }

    function changeLibraryFontSize(delta) {
        const libTextContent = document.getElementById('lib-article-text-content');
        if (!libTextContent) return;

        let currentSize = parseFloat(window.getComputedStyle(libTextContent).fontSize);
        currentSize += delta;
        if (currentSize < 10) currentSize = 10; 
        if (currentSize > 30) currentSize = 30; 
        libTextContent.style.fontSize = currentSize + 'px';
        localStorage.setItem(STORAGE_KEY_LIBRARY_FONT_SIZE, currentSize); 
    }

    function applySavedLibraryFontSize() {
        const savedSize = localStorage.getItem(STORAGE_KEY_LIBRARY_FONT_SIZE);
        const libTextContent = document.getElementById('lib-article-text-content');
        
        if (libTextContent) {
            if (savedSize) {
                libTextContent.style.fontSize = savedSize + 'px';
            } else {
                 libTextContent.style.fontSize = 'var(--font-size-base)'; 
            }
        }
    }


    function setSpeechRate(rate) { 
        if (speechApiSupported && utterance) {
            utterance.rate = parseFloat(rate);
            localStorage.setItem(STORAGE_KEY_SPEECH_RATE, rate);
        }
    }
    function applySavedSpeechRate() { 
        const savedRate = localStorage.getItem(STORAGE_KEY_SPEECH_RATE);
        const ttsSpeedSelect = document.getElementById('ttsSpeed');
        if (savedRate && ttsSpeedSelect) {
            ttsSpeedSelect.value = savedRate;
            if (utterance) utterance.rate = parseFloat(savedRate);
        }
    }

    function setDisplayMode(mode) {
        currentDisplayMode = mode;
        localStorage.setItem(STORAGE_KEY_DISPLAY_MODE, mode);
        
        const resultBox = document.getElementById('ae_result');
        if (resultBox) {
            const stories = resultBox.querySelectorAll('.single-story'); 
            stories.forEach(storyDiv => {
                const images = storyDiv.querySelectorAll('img, figure, picture'); 
                if (mode === 'text-only') {
                    images.forEach(imgEl => imgEl.style.display = 'none');
                } else {
                    images.forEach(imgEl => imgEl.style.display = ''); 
                }
            });
        }
        showToast(`‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§Æ‡•ã‡§° "${mode === 'text-only' ? '‡§ï‡•á‡§µ‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü' : '‡§á‡§Æ‡•á‡§ú ‡§î‡§∞ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü'}" ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§`, 'success');
    }

    function applySavedDisplayMode() {
        const savedMode = localStorage.getItem(STORAGE_KEY_DISPLAY_MODE) || 'image-text';
        const displayModeSelect = document.getElementById('displayMode');
        if (displayModeSelect) {
            displayModeSelect.value = savedMode;
        }
        currentDisplayMode = savedMode; 
        if (document.getElementById('ae_result')?.innerHTML.trim() !== '') {
            setDisplayMode(currentDisplayMode);
        }
    }


    function populateVoiceList() { 
        if (!speechApiSupported || !speechSynth) return;
        
        const setVoices = () => {
            const voices = speechSynth.getVoices();
            const voiceSelector = document.getElementById('voiceSelector');
            const voiceSelectorContainer = document.getElementById('voiceSelectorContainer');

            if (!voiceSelector || !voiceSelectorContainer ) {
                if (utterance) utterance.lang = 'hi-IN'; // Fallback
                return;
            }
             if (voices.length === 0) {
                 if (utterance) utterance.lang = 'hi-IN'; // Fallback
                 console.warn("‡§ï‡•ã‡§à ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§à‡•§");
                 return;
             }

            voiceSelector.innerHTML = ''; 
            let hasHindiVoices = false;

            voices.forEach(voice => {
                if (voice.lang.toLowerCase().startsWith('hi')) {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.setAttribute('data-lang', voice.lang);
                    option.setAttribute('data-name', voice.name);
                    voiceSelector.appendChild(option);
                    hasHindiVoices = true;
                }
            });

            if (hasHindiVoices) {
                voiceSelectorContainer.style.display = 'inline-block';
                const savedVoiceName = localStorage.getItem(STORAGE_KEY_VOICE_NAME);
                let voiceSet = false;
                if (savedVoiceName) {
                    const selectedOption = Array.from(voiceSelector.options).find(opt => opt.getAttribute('data-name') === savedVoiceName);
                    if (selectedOption) {
                        selectedOption.selected = true;
                        setSpeechVoice(savedVoiceName, false);
                        voiceSet = true;
                    }
                }
                if (!voiceSet && voiceSelector.options.length > 0) {
                     setSpeechVoice(voiceSelector.options[0].getAttribute('data-name'), false);
                }
            } else {
                voiceSelectorContainer.style.display = 'none';
                if (utterance) utterance.lang = 'hi-IN'; 
            }
        };

        // ‡§Ü‡§µ‡§æ‡§ú‡§º‡•á‡§Ç ‡§è‡§∏‡§ø‡§Ç‡§ï‡•ç‡§∞‡•ã‡§®‡§∏ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡§Ç
        if (speechSynth.getVoices().length > 0) {
            setVoices();
        } else if (speechSynth.onvoiceschanged !== undefined) {
             let voiceLoadAttempts = 0;
             const voiceInterval = setInterval(() => {
                const voices = speechSynth.getVoices();
                if (voices.length > 0 || voiceLoadAttempts > 10) { // 10 ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§Ø‡§æ 5 ‡§∏‡•á‡§ï‡§Ç‡§°
                    clearInterval(voiceInterval);
                    setVoices();
                }
                voiceLoadAttempts++;
            }, 500);
            speechSynth.onvoiceschanged = () => { // ‡§Ø‡§π ‡§ï‡•á‡§µ‡§≤ ‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§´‡§æ‡§Ø‡§∞ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è
                clearInterval(voiceInterval);
                speechSynth.onvoiceschanged = null; 
                setVoices();
            };
        } else {
            // ‡§â‡§® ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡§º‡•â‡§≤‡§¨‡•à‡§ï ‡§ú‡§π‡§æ‡§Ç onvoiceschanged ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à
            setTimeout(setVoices, 1000); 
        }
    }
    function setSpeechVoice(voiceName, showMsg = true) { 
        if (!speechApiSupported || !voiceName || !utterance) return;
        const voices = speechSynth.getVoices();
        const selectedVoice = voices.find(voice => voice.name === voiceName);
        if (selectedVoice) {
            utterance.voice = selectedVoice;
            utterance.lang = selectedVoice.lang; 
            localStorage.setItem(STORAGE_KEY_VOICE_NAME, selectedVoice.name);
            if (showMsg) showToast(`‡§Ü‡§µ‡§æ‡§ú‡§º "${selectedVoice.name}" ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡•Ä ‡§ó‡§à‡•§`, "success");
        } else if (showMsg) {
             showToast(`‡§Ü‡§µ‡§æ‡§ú‡§º "${voiceName}" ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§ ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§`, "error");
             if(utterance) utterance.lang = 'hi-IN'; 
        }
    }
    function showToast(message, type = 'info', duration = 3000) { 
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => { toast.classList.add('show'); }, 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { toast.remove(); }, 500);
        }, duration);
    }
    function scrollToTop() { window.scrollTo({top: 0, behavior: 'smooth'}); }

    // --- Internal Navigation History Functions --- 
    function addToHistory(url) {
        if (!url) return;
        if (currentHistoryIndex < navigationHistory.length - 1) {
            navigationHistory = navigationHistory.slice(0, currentHistoryIndex + 1);
        }
        if (navigationHistory.length === 0 || navigationHistory[navigationHistory.length -1] !== url) {
            navigationHistory.push(url);
            currentHistoryIndex = navigationHistory.length - 1;
        }
        updateHistoryButtons();
    }

    function updateHistoryButtons() {
        const backBtn = document.getElementById('historyBackBtn');
        const forwardBtn = document.getElementById('historyForwardBtn');
        const historyContainer = document.getElementById('internalNavHistoryContainer');

        if (!backBtn || !forwardBtn || !historyContainer) return;

        const articleExtractorVisible = document.getElementById('ArticleExtractor').style.display === 'block';
        const hasContent = document.getElementById('ae_result')?.innerHTML.trim() !== '';

        if (articleExtractorVisible && (navigationHistory.length > 1 || (hasContent && navigationHistory.length > 0) )) {
            historyContainer.style.display = 'block';
        } else {
            historyContainer.style.display = 'none';
        }
        
        backBtn.disabled = currentHistoryIndex <= 0;
        forwardBtn.disabled = currentHistoryIndex >= navigationHistory.length - 1;
    }

    function navigateHistory(direction) { 
        if (isNavigatingHistory) return; 

        isNavigatingHistory = true;
        const newIndex = currentHistoryIndex + direction;
        if (newIndex >= 0 && newIndex < navigationHistory.length) {
            currentHistoryIndex = newIndex;
            const urlToLoad = navigationHistory[currentHistoryIndex];
            
            const articleUrlInput = document.getElementById('articleUrl');
            if (articleUrlInput) articleUrlInput.value = urlToLoad;
            
            const crawlCheckbox = document.getElementById('crawlSiteToggle');
            if (crawlCheckbox) crawlCheckbox.checked = false; 

            showToast(`‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§∏‡•á ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à: ${urlToLoad.substring(0,50)}...`, 'info');
            ae_startExtraction(true).finally(() => { 
                isNavigatingHistory = false;
                updateHistoryButtons();
            });
        } else {
            isNavigatingHistory = false; 
        }
        updateHistoryButtons(); 
    }

     // --- Offline Article Function ---
    function displayOfflineArticle() {
        const offlineArticleDataString = localStorage.getItem(STORAGE_KEY_OFFLINE_ARTICLE);
        if (offlineArticleDataString) {
            try {
                const articleData = JSON.parse(offlineArticleDataString);
                const resultDiv = document.getElementById('ae_result');
                const articleUrlInput = document.getElementById('articleUrl');
                const loadingDiv = document.getElementById('ae_loading');

                if (resultDiv && articleUrlInput && loadingDiv) {
                    resultDiv.innerHTML = ''; 
                    resultDiv.appendChild(createStoryElement(articleData, articleData.url));
                    
                    articleUrlInput.value = articleData.url; 
                    
                    const articleSettingsPanel = document.getElementById('article-settings-panel');
                    if (articleSettingsPanel) articleSettingsPanel.style.display = 'flex';
                    
                    showToast(`‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§∏‡§π‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ "${articleData.title}" ‡§¶‡§ø‡§ñ‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§`, 'info', 4000);
                    if(loadingDiv) loadingDiv.style.display = 'none';

                     if (!isNavigatingHistory && (navigationHistory.length === 0 || navigationHistory[navigationHistory.length -1] !== articleData.url)) {
                         addToHistory(articleData.url);
                     }
                }
            } catch (e) {
                console.error("‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§™‡§æ‡§∞‡•ç‡§∏ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", e);
                localStorage.removeItem(STORAGE_KEY_OFFLINE_ARTICLE); 
            }
        } else {
            const resultDiv = document.getElementById('ae_result');
            if(resultDiv && resultDiv.innerHTML.trim() === '') {
                 resultDiv.innerHTML = "<p><em>URL ‡§°‡§æ‡§≤‡•á‡§Ç ‡§Ø‡§æ ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï/‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§∏‡•á ‡§ö‡•Å‡§®‡•á‡§Ç‡•§ ‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§™‡§¢‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∏‡§π‡•á‡§ú‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§</em></p>";
            }
        }
    }

    // --- Import/Export Functions ---
    function exportData(data, filename) {
        if (!data || (Array.isArray(data) && data.length === 0) || (typeof data === 'object' && Object.keys(data).length === 0) ) {
            showToast("‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error");
            return;
        }
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast(`${filename} ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!`, "success");
    }

    function exportLibrary() {
        const library = getLibrary();
        exportData(library, 'article_library_backup.json');
    }

    function exportBookmarks() {
        const bookmarks = getBookmarks();
        exportData(bookmarks, 'article_bookmarks_backup.json');
    }

    function importData(event, type, mergeFunction) {
        const file = event.target.files[0];
        if (!file) { showToast("‡§ï‡•ã‡§à ‡§´‡§º‡§æ‡§á‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§ö‡•Å‡§®‡•Ä ‡§ó‡§à‡•§", "error"); return; }
        if (file.type !== "application/json") {
            showToast("‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§´‡§º‡§æ‡§á‡§≤ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ .json ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§", "error");
            event.target.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = e => {
            try {
                const importedData = JSON.parse(e.target.result);
                mergeFunction(importedData); 
            } catch (err) {
                showToast(`‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${err.message}`, "error", 5000);
                console.error("Import error:", err);
            } finally {
                event.target.value = '';
            }
        };
        reader.onerror = () => {
            showToast("‡§´‡§º‡§æ‡§á‡§≤ ‡§™‡§¢‡§º‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§", "error");
            event.target.value = '';
        };
        reader.readAsText(file);
    }

    function importLibraryHandler(event) {
        const confirmation = confirm("‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§Ø‡§π ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§°‡•á‡§ü‡§æ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§ø‡§è ‡§ó‡§è ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§Æ‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§ó‡§æ‡•§ ‡§∏‡§Æ‡§æ‡§® ‡§Ü‡§à‡§°‡•Ä ‡§µ‡§æ‡§≤‡•á ‡§Ü‡§á‡§ü‡§Æ ‡§ì‡§µ‡§∞‡§∞‡§æ‡§á‡§ü ‡§π‡•ã ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?");
        if (confirmation) {
            importData(event, 'library', (importedLibrary) => {
                let currentLibrary = getLibrary();
                let newCount = 0;
                let updatedCount = 0;

                for (const storyId in importedLibrary) {
                    if (importedLibrary.hasOwnProperty(storyId)) {
                        if (currentLibrary.hasOwnProperty(storyId)) {
                            updatedCount++;
                        } else {
                            newCount++;
                        }
                        // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§ü‡•à‡§ó ‡§è‡§ï ‡§è‡§∞‡•á ‡§π‡•à
                        if (importedLibrary[storyId] && !Array.isArray(importedLibrary[storyId].tags)) {
                            importedLibrary[storyId].tags = [];
                        }
                        currentLibrary[storyId] = importedLibrary[storyId]; 
                        
                        if (navigator.serviceWorker && navigator.serviceWorker.controller && currentLibrary[storyId].url) {
                            navigator.serviceWorker.controller.postMessage({
                                action: 'cache-article',
                                url: currentLibrary[storyId].url,
                                article: currentLibrary[storyId]
                            });
                        }
                    }
                }
                saveLibrary(currentLibrary);
                showToast(`${newCount} ‡§®‡§è ‡§î‡§∞ ${updatedCount} ‡§Ö‡§™‡§°‡•á‡§ü‡•á‡§° ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Ü‡§á‡§ü‡§Æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§ø‡§è ‡§ó‡§è!`, "success");
            });
        } else {
            event.target.value = '';
            showToast("‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§", "info");
        }
    }

    function importBookmarksHandler(event) {
        const confirmation = confirm("‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§Ø‡§π ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§Æ‡•á‡§Ç ‡§®‡§è (‡§ó‡•à‡§∞-‡§°‡•Å‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§ü URL ‡§µ‡§æ‡§≤‡•á) ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§ó‡§æ‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?");
        if (confirmation) {
            importData(event, 'bookmarks', (importedBookmarks) => {
                let currentBookmarks = getBookmarks();
                const currentUrls = new Set(currentBookmarks.map(bm => bm.url));
                let newBookmarksAdded = 0;
                
                if (!Array.isArray(importedBookmarks)) {
                    showToast("‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•Ä ‡§ó‡§à ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™ ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§π‡•à‡•§", "error");
                    return;
                }

                importedBookmarks.forEach(bm => {
                    if (bm && bm.url && !currentUrls.has(bm.url)) {
                        bm.folder = bm.folder || 'Default';
                        currentBookmarks.push(bm);
                        newBookmarksAdded++;
                    }
                });
                saveBookmarks(currentBookmarks);
                showToast(`${newBookmarksAdded} ‡§®‡§è ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§ø‡§è ‡§ó‡§è!`, "success");
            });
        } else {
            event.target.value = '';
            showToast("‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§", "info");
        }
    }


    // --- Event Listeners ---
    window.onscroll = () => { 
        const progressBar = document.getElementById('progress-bar');
        const backToTopBtn = document.getElementById('backToTopBtn');
        const totalHeight = document.documentElement.scrollHeight - window.innerHeight;
        
        if (progressBar) {
            if(totalHeight > 0) {
                progressBar.style.width = `${(window.pageYOffset / totalHeight) * 100}%`;
            } else {
                progressBar.style.width = '0%';
            }
        }

        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 600 && 
            allStoryLinks.length > 0 && 
            currentLinkIndex < allStoryLinks.length &&
            !isLoadingNext) { 
            loadNextArticleIfIdle(); 
        }

        if (backToTopBtn) {
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                backToTopBtn.style.display = "block";
            } else {
                backToTopBtn.style.display = "none";
            }
        }
    };
    // Google Search Function
    function performGoogleSearch() {
        const queryInput = document.getElementById('googleSearchQuery');
        if (!queryInput) return;

        const query = queryInput.value.trim();
        if (!query) {
            showToast("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ñ‡•ã‡§ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•Å‡§õ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç‡•§", "info");
            queryInput.focus();
            return;
        }
        const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        window.open(searchUrl, '_blank');
    }


    document.addEventListener('DOMContentLoaded', () => {
        applySavedTheme();
        updateLibraryCount();
        updateBookmarkCount(); 
        applySavedFontSize();
        applySavedLibraryFontSize(); 
        applySavedSpeechRate();
        applySavedDisplayMode(); 
        toggleDepthSelector(); 
        populateTagFilter(); 
        populateBookmarkFolderSelectors(); 

        populateVoiceList(); // ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§∏‡•Ç‡§ö‡•Ä ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç
        
        const googleSearchInput = document.getElementById('googleSearchQuery');
        if (googleSearchInput) {
            googleSearchInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); 
                    performGoogleSearch();
                }
            });
        }

        const urlParams = new URLSearchParams(window.location.search);
        const initialUrlFromQuery = urlParams.get('url');
        const resultBox = document.getElementById('ae_result');
        const articleUrlInput = document.getElementById('articleUrl');

        if (initialUrlFromQuery) {
            if (articleUrlInput) articleUrlInput.value = initialUrlFromQuery;
            ae_startExtraction();
        } else if (resultBox && resultBox.innerHTML.trim() === '') {
             displayOfflineArticle();
        }
        
        const firstTabLink = document.querySelector('.tab-link');
        if(firstTabLink && !initialUrlFromQuery) { 
            openTool({currentTarget: firstTabLink}, 'ArticleExtractor');
        } else if (initialUrlFromQuery) {
            openTool({currentTarget: document.querySelector('.tab-link[onclick*="ArticleExtractor"]')}, 'ArticleExtractor');
        }
        updateHistoryButtons();

        // --- ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§µ‡§∞‡•ç‡§ï‡§∞ ‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ (Blob URL ‡§ï‡•á ‡§∏‡§æ‡§•) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                try {
                    const blob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);
                    
                    // ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡§∏‡§Ç‡§≠‡§µ ‡§∏‡•ç‡§ï‡•ã‡§™ ‡§∏‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§
                    // ‡§Ø‡§π '/'' ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è, ‡§≤‡•á‡§ï‡§ø‡§® Blob URL ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Ø‡§π ‡§Æ‡•Å‡§∂‡•ç‡§ï‡§ø‡§≤ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§
                    // ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∏‡•ç‡§ï‡•ã‡§™ ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü‡§∞‡•Ä ‡§π‡•ã‡§ó‡§æ (‡§â‡§¶‡§æ. '/my-app/'),
                    // ‡§ú‡•ã ‡§†‡•Ä‡§ï ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§Ø‡§¶‡§ø ‡§∏‡§≠‡•Ä ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§® ‡§â‡§∏ ‡§™‡§æ‡§• ‡§ï‡•á ‡§®‡•Ä‡§ö‡•á ‡§π‡•à‡§Ç‡•§
                    // ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§á‡§∏‡•á ‡§∞‡•Ç‡§ü ('/') ‡§™‡§∞ ‡§ö‡§≤‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§Ø‡§π ‡§è‡§ï ‡§∏‡§¨‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§Ø‡§π ‡§Æ‡•Å‡§∂‡•ç‡§ï‡§ø‡§≤ ‡§π‡•ã‡§ó‡§æ‡•§
                    // ‡§Ö‡§≠‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§π‡§Æ ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∏‡•ç‡§ï‡•ã‡§™ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á‡•§
                    navigator.serviceWorker.register(swUrl /*, { scope: '/' } */) // scope ‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï ‡§π‡•à
                        .then(registration => {
                            console.log('ServiceWorker (Blob) registration successful with scope: ', registration.scope);
                            showToast("‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ‡§è‡§Å (Blob SW) ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à‡§Ç!", "success", 4000);

                            // ‡§∏‡•Å‡§®‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ ‡§®‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§ï‡§∞ ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                if (newWorker) {
                                    newWorker.addEventListener('statechange', () => {
                                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                            // ‡§®‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§ï‡§∞ ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§™‡•á‡§ú ‡§ï‡•ã ‡§∞‡•Ä‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§∏‡•Å‡§ù‡§æ‡§µ ‡§¶‡•á‡§Ç
                                            // ‡§Ø‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•ã ‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§Ö‡§™‡§°‡•á‡§ü ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à
                                            console.log('[App] New Service Worker installed. Controller available.');
                                        }
                                    });
                                }
                            });
                        })
                        .catch(err => {
                            console.error('ServiceWorker (Blob) registration failed: ', err);
                            showToast("‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ‡§è‡§Å (Blob SW) ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: " + err.message, "error", 7000);
                        });
                } catch (e) {
                     console.error('Error creating/registering Blob ServiceWorker:', e);
                     showToast("Blob SW ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + e.message, "error", 7000);
                }
            });
             // ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ï ‡§¨‡§¶‡§≤‡§®‡•á ‡§™‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('[App] New Service Worker has taken control. Consider reloading.');
                // showToast("‡§ê‡§™ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®‡•ã‡§Ç ‡§ï‡•ã ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∞‡•Ä‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§", "info", 5000);
            });

        } else {
            showToast("‡§Ü‡§™‡§ï‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§µ‡§∞‡•ç‡§ï‡§∞ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç‡•§ ‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ‡§è‡§Å ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§Ç‡§ó‡•Ä‡•§", "warning", 5000);
        }
    });

    </script>
</body>
    </html>
