<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Reader Pro (Stream & Local TTS)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mozilla/readability@0.5.0/Readability.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f7f6; --text-color: #333; --container-bg: #ffffff;
            --primary-color: #007bff; --secondary-color: #17a2b8;
            --border-color: #ddd; --danger-color: #dc3545; --success-color: #28a745;
            --font-size-base: 16px; --line-height-base: 1.6;
        }
        .dark-mode {
            --bg-color: #121212; --text-color: #e0e0e0; --container-bg: #1e1e1e;
            --primary-color: #4dabf7; --secondary-color: #4dd0e1;
            --border-color: #444; --danger-color: #e57373; --success-color: #66bb6a;
        }
        .sepia-mode {
            --bg-color: #f4e8c1; --text-color: #5b4636; --container-bg: #fbf0d9;
            --primary-color: #795548; --secondary-color: #8d6e63;
            --border-color: #d7ccc8; --danger-color: #a1887f; --success-color: #7cb342;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            line-height: var(--line-height-base); transition: background-color 0.3s, color 0.3s;
            margin: 0; padding-top: 5px;
        }
        #progress-bar { position: fixed; top: 0; left: 0; height: 5px; background: var(--primary-color); width: 0%; z-index: 9999; transition: width 0.1s; }
        .main-container { max-width: 800px; margin: 20px auto; padding: 20px; background-color: var(--container-bg); border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1, h2, h3 { color: var(--primary-color); }
        .tabs { border-bottom: 2px solid var(--border-color); overflow: hidden; margin-bottom: 20px; display: flex; flex-wrap: wrap; }
        .tab-link { background: transparent; border: none; cursor: pointer; padding: 14px 16px; font-size: 17px; color: var(--text-color); border-bottom: 3px solid transparent; }
        .tab-link.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: bold; }
        input[type="url"], input[type="search"], input[type="text"], select { background-color: var(--container-bg); color: var(--text-color); border: 1px solid var(--border-color); width: 100%; padding: 12px; box-sizing: border-box; border-radius: 6px; font-size: 16px; margin-top: 10px; }
        button.tool-btn, .tool-btn-secondary { background-color: var(--primary-color); color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 15px; }
        .tool-btn-secondary { background-color: var(--secondary-color); margin-left: 10px; }
        #clearUrlBtn { height: 46.4px; margin-top: 10px; font-size: 1.2em; background-color: var(--danger-color); color:white; border-radius:6px; border:none; cursor:pointer; padding: 0 12px;}

        .result-box { background-color: var(--bg-color); margin-top: 15px; padding: 15px; border-radius: 6px; font-size: var(--font-size-base); }
        .single-story { border-bottom: 2px dashed var(--border-color); padding-bottom: 20px; margin-bottom: 20px; }
        .single-story img { max-width: 100%; height: auto; display: block; margin: 15px auto; border-radius: 8px; }
        .story-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
        .header-buttons { display: flex; gap: 8px; flex-wrap: wrap; align-items: center;}
        .header-buttons button { background-color: var(--secondary-color); color: white; border: none; border-radius: 5px; padding: 6px 12px; font-size: 14px; cursor: pointer; }
        .header-buttons .save-btn.saved { background-color: var(--danger-color); }
        .theme-toggle-container { position: fixed; top: 15px; right: 20px; z-index: 1000; display:flex; gap: 5px;}
        .theme-toggle { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; display: flex; justify-content: center; align-items: center; }
        #ae_loading { margin-top: 15px; color: var(--primary-color); font-style: italic; text-align: center; }
        
        .library-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .library-item .item-title { flex-grow: 1; cursor: pointer; }
        .library-item .item-controls { display: flex; align-items: center; gap: 8px; }
        .library-item .read-status-toggle { cursor: pointer; font-size: 1.1em; padding: 0 5px; }
        .library-item.selected { background-color: var(--border-color); }
        .library-item .delete-btn { background-color: var(--danger-color); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        
        .bookmark-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .bookmark-item .item-title { flex-grow: 1; cursor: pointer; }
        .bookmark-item .delete-btn { background-color: var(--danger-color); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left:10px; }


        .library-controls, .bookmark-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;}
        .library-controls input[type="search"], .bookmark-controls input[type="search"] { width: auto; flex-grow: 1; margin-top:0;}
        .library-controls select, .bookmark-controls select { width: auto; margin-top:0;}

        .toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--primary-color); color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10001; font-size: 16px; opacity: 0; transition: opacity 0.5s, bottom 0.5s; }
        .toast-notification.show { opacity: 1; bottom: 30px; }
        .toast-notification.error { background-color: var(--danger-color); }
        .toast-notification.success { background-color: var(--success-color); }
        .toast-notification.warning { background-color: #ffc107; color: #333; }
        .toast-notification .toast-actions button { background-color: rgba(255,255,255,0.2); color:white; border:1px solid white; padding: 5px 10px; margin-left:15px; border-radius:4px; cursor:pointer;}

        #backToTopBtn { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 999; background-color: var(--secondary-color); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        #internalNavHistoryContainer { margin-top: 10px; padding: 5px 0; }
        #internalNavHistoryContainer button { font-size: 0.9em; padding: 5px 10px; margin-right: 5px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
        #internalNavHistoryContainer button:disabled { background-color: var(--border-color); cursor: not-allowed; }

        #bookmarkForm div { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        #bookmarkForm input[type="text"], #bookmarkForm input[type="url"], #bookmarkForm select { flex-grow: 1; margin-top: 0;  }
        #bookmarkForm button { margin-top: 0;  }

        #library-content-wrapper { display: flex; flex-wrap: wrap;  gap: 20px; }
        #library-list-container { flex: 1;  min-width: 250px;  max-height: 60vh;  overflow-y: auto; border-right: 1px solid var(--border-color); padding-right: 15px; }
        #library-article-view { flex: 2;  min-width: 300px; }
        #lib-article-text-content { white-space: pre-wrap;  background-color: var(--bg-color);  padding: 15px;  border-radius: 6px;  max-height: 50vh;  overflow-y: auto; border: 1px solid var(--border-color); line-height: 1.7; }
        #lib-article-current-tags .tag-item { background-color: var(--secondary-color); color: white; padding: 3px 8px; border-radius: 4px; margin-right: 5px; margin-bottom: 5px; font-size: 0.9em; display: inline-block; }
        #lib-article-current-tags .tag-remove-btn { margin-left: 4px; border: none; background: transparent; color: white; cursor: pointer; font-weight: bold; }
        
        #lib-article-tts-controls { margin-top: -5px; margin-bottom: 15px; display:flex; flex-wrap: wrap; gap:10px; align-items:center; }
        #lib-article-tts-controls .tts-main-buttons button { margin-left:0 !important; font-size:0.9em !important; padding:8px 12px !important; margin-right: 10px; }
        #lib-article-tts-controls .tts-extra-controls { display: flex; align-items: center; gap: 10px; width: 100%; margin-top: 10px;}
        #lib-article-tts-controls label { font-size: 0.9em; }
        #lib-article-tts-controls select { font-size: 0.8em; padding: 5px; }

        .fallback-share-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--container-bg); color: var(--text-color); padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10002; width: 90%; max-width: 600px; border: 1px solid var(--border-color); display:flex; flex-direction:column; }
        .fallback-share-modal h4 { margin-top: 0; color: var(--primary-color); }
        .fallback-share-modal textarea { flex-grow: 1; width: 100%; min-height: 150px; max-height: 50vh; margin-bottom: 10px; font-size: 0.9em;  padding: 5px; box-sizing: border-box; background-color: var(--bg-color);  color: var(--text-color); border: 1px solid var(--border-color); }
        .fallback-share-modal button, .fallback-share-modal a { margin-right: 10px; margin-bottom: 5px; padding: 8px 12px;  border-radius: 4px; text-decoration: none; font-size: 0.9em; }
        .fallback-share-modal button.primary { background-color: var(--primary-color); color: white; border: none; }
        .fallback-share-modal button.danger { background-color: var(--danger-color); color: white; border: none; float: right; }
        .fallback-share-modal a { background-color: var(--secondary-color); color: white; display: inline-block; }

        .toc-container { margin-bottom: 20px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-color); }
        .toc-container h4 { margin-top: 0; color: var(--primary-color); }
        .toc-container ul { list-style-type: none; padding-left: 0; margin-top: 5px; max-height: 200px; overflow-y: auto;}
        .toc-container li a { text-decoration: none; color: var(--secondary-color); display: block; padding: 3px 0 3px 5px; border-left: 3px solid transparent; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .toc-container li a:hover { background-color: var(--container-bg); color: var(--primary-color); border-left-color: var(--primary-color); }

        .library-playlist-controls { margin-top: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .library-item .playlist-checkbox { margin-right: 10px; }

        /* --- Settings Modal Styles --- */
        .settings-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 10010;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        .settings-modal-overlay.show {
            opacity: 1; pointer-events: auto;
        }
        .settings-modal-content {
            background-color: var(--container-bg); color: var(--text-color);
            padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            width: 90%; max-width: 600px; max-height: 90vh;
            display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .settings-modal-overlay.show .settings-modal-content {
            transform: scale(1);
        }
        .settings-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px;
        }
        .settings-modal-header h2 { margin: 0; color: var(--primary-color); }
        .settings-close-btn {
            background: transparent; border: none; font-size: 28px; font-weight: bold;
            color: var(--text-color); cursor: pointer; padding: 0 10px;
        }
        .settings-modal-body {
            overflow-y: auto; padding-right: 15px; margin-right: -15px;
        }
        .settings-modal-body fieldset {
            border: 1px solid var(--border-color); border-radius: 8px;
            padding: 15px; margin-bottom: 20px;
        }
        .settings-modal-body legend {
            font-weight: bold; color: var(--primary-color); padding: 0 10px;
        }
        .setting-item {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; flex-wrap: wrap; gap: 10px;
        }
        .setting-item:last-child { margin-bottom: 0; }
        .setting-item label { flex-shrink: 0; }
        .setting-control { display: flex; gap: 15px; align-items: center; flex-grow: 1; justify-content: flex-end; }
        .setting-control button, .setting-control select {
            background-color: var(--bg-color); color: var(--text-color);
            border: 1px solid var(--border-color); border-radius: 5px;
            padding: 8px 12px; cursor: pointer;
        }
        .setting-control input[type="radio"] + label { cursor: pointer; }
        .setting-control .danger-btn { background-color: var(--danger-color); color: white; }
        .setting-control .range-control { display: flex; align-items: center; gap: 10px; }
        .danger-zone { border-color: var(--danger-color); }
        .danger-zone legend { color: var(--danger-color); }
        .settings-modal-footer {
            border-top: 1px solid var(--border-color); padding-top: 20px;
            margin-top: 10px; text-align: right;
        }
    </style>
</head>
<body>
    <div id="progress-bar"></div>
    <div class="theme-toggle-container">
        <button class="theme-toggle" onclick="toggleTheme('light')" title="‡§≤‡§æ‡§á‡§ü ‡§Æ‡•ã‡§°">‚òÄÔ∏è</button>
        <button class="theme-toggle" onclick="toggleTheme('dark')" title="‡§°‡§æ‡§∞‡•ç‡§ï ‡§Æ‡•ã‡§°">üåì</button>
        <button class="theme-toggle" onclick="toggleTheme('sepia')" title="‡§∏‡•á‡§™‡§ø‡§Ø‡§æ ‡§Æ‡•ã‡§°">üìú</button>
        <button class="theme-toggle" onclick="openSettingsModal()" title="‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏">‚öôÔ∏è</button>
    </div>
    <div class="main-container">
        <h1>‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∞‡•Ä‡§°‡§∞ ‡§™‡•ç‡§∞‡•ã</h1>

        <div id="googleSearchContainer" style="margin-bottom: 15px; display: flex; gap: 5px;">
            <input type="search" id="googleSearchQuery" placeholder="‡§ó‡•Ç‡§ó‡§≤ ‡§™‡§∞ ‡§ñ‡•ã‡§ú‡•á‡§Ç..." style="flex-grow: 1; margin-top:0;">
            <button onclick="performGoogleSearch()" class="tool-btn" style="margin-top:0; padding: 12px 15px;" title="‡§ñ‡•ã‡§ú‡•á‡§Ç">üîç</button>
        </div>

        <div id="internalNavHistoryContainer" style="display: none;">
            <button id="historyBackBtn" onclick="navigateHistory(-1)" disabled>‚¨ÖÔ∏è ‡§™‡§ø‡§õ‡§≤‡§æ</button>
            <button id="historyForwardBtn" onclick="navigateHistory(1)" disabled>‚û°Ô∏è ‡§Ö‡§ó‡§≤‡§æ</button>
        </div>
        <div class="tabs">
            <button class="tab-link active" onclick="openTool(event, 'ArticleExtractor')">‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç</button>
            <button class="tab-link" onclick="openTool(event, 'MyLibrary')">‡§Æ‡•á‡§∞‡•Ä ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä <span id="library-count">(0)</span></button>
            <button class="tab-link" onclick="openTool(event, 'Bookmarks')">‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï <span id="bookmark-count">(0)</span></button>
        </div>

        <div id="ArticleExtractor" class="tool-content" style="display:block;">
             <p>‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡§æ ‡§≤‡§ø‡§Ç‡§ï, ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§™‡•á‡§ú ‡§Ø‡§æ ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§ï‡§æ ‡§π‡•ã‡§Æ‡§™‡•á‡§ú ‡§≤‡§ø‡§Ç‡§ï ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç‡•§</p>
             <div style="display: flex; align-items: center; gap: 5px;">
                <input type="url" id="articleUrl" placeholder="https://example.com/" style="flex-grow: 1; margin-top:0;">
                <button id="clearUrlBtn" onclick="clearUrlInput()" title="URL ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç">‚úó</button>
            </div>
             
             <div style="margin-top: 10px; margin-bottom: 5px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px;">
                 <div>
                    <input type="checkbox" id="crawlSiteToggle" name="crawlSiteToggle" checked onchange="toggleDepthSelector()">
                    <label for="crawlSiteToggle" style="font-size: 0.9em; cursor:pointer;">‡§á‡§∏ URL ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á ‡§Ö‡§®‡•ç‡§Ø ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§≠‡•Ä ‡§ñ‡•ã‡§ú‡•á‡§Ç</label>
                 </div>
                 <div id="depthSelectorContainer" style="display: inline-block;">
                    <label for="crawlDepth" style="font-size: 0.9em;">‡§ñ‡•ã‡§ú ‡§ï‡•Ä ‡§ó‡§π‡§∞‡§æ‡§à:</label>
                    <select id="crawlDepth" name="crawlDepth" style="font-size: 0.9em; padding: 5px;">
                        <option value="0">‡§ï‡•á‡§µ‡§≤ ‡§Ø‡§π ‡§™‡•á‡§ú (‡§Ø‡§æ ‡§á‡§∏ ‡§™‡•á‡§ú ‡§ï‡•á ‡§≤‡§ø‡§Ç‡§ï)</option>
                        <option value="1" selected>1 ‡§∏‡•ç‡§§‡§∞ ‡§ó‡§π‡§∞‡§æ</option>
                        <option value="2">2 ‡§∏‡•ç‡§§‡§∞ ‡§ó‡§π‡§∞‡§æ</option>
                        <option value="3">3 ‡§∏‡•ç‡§§‡§∞ ‡§ó‡§π‡§∞‡§æ (‡§ß‡•Ä‡§Æ‡§æ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à)</option>
                    </select>
                 </div>
             </div>
             <div style="margin-top: 15px; margin-bottom: 5px;">
                 <input type="search" id="extractorSearch" placeholder="‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§ú‡•á‡§Ç..." oninput="filterExtractedArticles()" style="width: calc(100% - 145px); margin-right: 10px; margin-top:0;">
                 <button onclick="clearExtractorSearch()" class="tool-btn-secondary" style="padding: 10px 15px; margin-top: 0; font-size:0.9em;">‡§ñ‡•ã‡§ú ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button>
             </div>

             <button class="tool-btn" onclick="ae_startExtraction()">‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç</button>
             <button id="toggleCrawlBtn" class="tool-btn-secondary" onclick="toggleCrawling()" style="display: none;">‚èπÔ∏è ‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•á‡§Ç</button>
             <button class="tool-btn-secondary" onclick="clearResults()">‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button>
             <button id="shareAllBtn" class="tool-btn-secondary" onclick="shareAllExtractedArticles()" style="display: none; background-color: var(--success-color);">‡§∏‡§≠‡•Ä ‡§ï‡•ã ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
             
             <div id="ae_loading" style="display:none;"></div>
             <div class="result-box" id="ae_result"></div>
        </div>

        <div id="MyLibrary" class="tool-content">
            <h2>‡§∏‡•á‡§µ ‡§ï‡§ø‡§è ‡§ó‡§è ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤</h2>
            <div class="library-controls">
                <input type="search" id="librarySearch" placeholder="‡§ü‡§æ‡§á‡§ü‡§≤ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç..." oninput="loadLibrary()">
                <select id="librarySort" onchange="loadLibrary()">
                    <option value="date_desc">‡§∏‡§¨‡§∏‡•á ‡§®‡§Ø‡§æ ‡§™‡§π‡§≤‡•á</option>
                    <option value="date_asc">‡§∏‡§¨‡§∏‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§™‡§π‡§≤‡•á</option>
                    <option value="title_asc">‡§ü‡§æ‡§á‡§ü‡§≤ (A-Z)</option>
                    <option value="title_desc">‡§ü‡§æ‡§á‡§ü‡§≤ (Z-A)</option>
                </select>
                <div id="libraryTagFilterContainer" style="display:inline-block; margin-left:10px;">
                    <label for="libraryTagFilter" style="font-size:0.9em;">‡§ü‡•à‡§ó ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞:</label>
                    <select id="libraryTagFilter" onchange="loadLibrary()" style="font-size:0.9em; padding:5px; width:auto; margin-top:0;">
                        <option value="">‡§∏‡§≠‡•Ä ‡§ü‡•à‡§ó</option>
                    </select>
                </div>
                <div id="libraryReadStatusFilterContainer" style="display:inline-block; margin-left:10px;">
                    <label for="libraryReadStatusFilter" style="font-size:0.9em;">‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞:</label>
                    <select id="libraryReadStatusFilter" onchange="loadLibrary()" style="font-size:0.9em; padding:5px; width:auto; margin-top:0;">
                        <option value="all">‡§∏‡§≠‡•Ä</option>
                        <option value="read">‡§™‡§¢‡§º‡§æ ‡§π‡•Å‡§Ü</option>
                        <option value="unread">‡§Ö‡§™‡§†‡§ø‡§§</option>
                    </select>
                </div>
                <button id="clearLibraryFiltersBtn" class="tool-btn-secondary" onclick="clearLibraryFilters()" style="margin-top:0; margin-left: 10px; font-size:0.9em; padding:8px 12px; display:none;">‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
            <div class="library-playlist-controls">
                <button id="playSelectedBtn" onclick="playSelectedLibraryItems()" class="tool-btn-secondary" style="margin-top:0; margin-left:0; display:none; background-color: var(--success-color);">‡§ö‡§Ø‡§®‡§ø‡§§ ‡§ö‡§≤‡§æ‡§è‡§Ç</button>
                <button id="createSelectedMp3Btn" onclick="createSelectedMp3()" class="tool-btn-secondary" style="margin-top:0; margin-left:0; display:none;">‡§ö‡§Ø‡§®‡§ø‡§§ ‡§ï‡§æ MP3 ‡§¨‡§®‡§æ‡§è‡§Ç</button>
                <div>
                    <input type="checkbox" id="autoPlayNextToggle" onchange="handleAutoPlayToggle(this.checked)">
                    <label for="autoPlayNextToggle" style="font-size: 0.9em; cursor:pointer;">‡§Ö‡§ó‡§≤‡§æ ‡§ë‡§ü‡•ã-‡§™‡•ç‡§≤‡•á ‡§ï‡§∞‡•á‡§Ç</label>
                </div>
            </div>
             <div class="library-controls" style="margin-top:5px;">
                <button onclick="exportLibrary()" class="tool-btn-secondary" style="margin-top:0; margin-left:0; font-size:0.9em; padding:8px 12px;">‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
                <input type="file" id="importLibraryFile" accept=".json" onchange="importLibraryHandler(event)" style="display:none;">
                <button onclick="document.getElementById('importLibraryFile').click()" class="tool-btn-secondary" style="margin-top:0; font-size:0.9em; padding:8px 12px;">‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
            </div>

            <div id="library-content-wrapper">
                <div id="library-list-container">
                    <div id="library-list"></div>
                </div>
                <div id="library-article-view" style="display: none;">
                    <h3 id="lib-article-title"></h3>
                    <p style="margin-top:0; margin-bottom: 5px;"><small>‡§Æ‡•Ç‡§≤ URL: <a id="lib-article-original-url" href="#" target="_blank" rel="noopener noreferrer"></a></small></p>
                    <div style="margin-bottom:15px; margin-top:5px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <button onclick="copyLibraryArticleText()" class="tool-btn-secondary" style="padding: 8px 12px; font-size: 0.9em; margin-left:0;">‡§™‡•Ç‡§∞‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç</button>
                        <button id="shareLibArticleBtn" class="tool-btn-secondary" style="padding: 8px 12px; font-size: 0.9em; background-color: var(--success-color);">‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
                        
                        <div style="margin-left:auto;"> 
                            <label for="libFontSize" style="font-size:0.9em;">‡§´‡§º‡•â‡§®‡•ç‡§ü: </label>
                            <button onclick="changeLibraryFontSize(-1)" title="‡§´‡§º‡•â‡§®‡•ç‡§ü ‡§ò‡§ü‡§æ‡§è‡§Ç" style="padding:5px 8px; font-size:0.8em;">A-</button>
                            <button onclick="changeLibraryFontSize(1)" title="‡§´‡§º‡•â‡§®‡•ç‡§ü ‡§¨‡§¢‡§º‡§æ‡§è‡§Ç" style="padding:5px 8px; font-size:0.8em;">A+</button>
                        </div>
                    </div>
                    <div id="lib-article-tts-controls">
                        <div class="tts-main-buttons"></div>
                        <div class="tts-extra-controls">
                            <label for="libTtsRateSlider">‡§ó‡§§‡§ø:</label>
                            <input type="range" id="libTtsRateSlider" min="0.5" max="2" step="0.1" value="1" oninput="setTTSRate(this.value)" style="cursor: pointer;">
                            <span id="libTtsRateDisplay" style="min-width: 35px;">1.0x</span>
                            <div id="libVoiceSelectorContainer" style="display: none; margin-left:15px;">
                                <label for="libVoiceSelector">‡§Ü‡§µ‡§æ‡§ú‡§º:</label>
                                <select id="libVoiceSelector" onchange="setTTSVoice(this.value)"></select>
                            </div>
                        </div>
                    </div>
                    <div id="sleep-timer-controls" style="margin-top: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
                        <label for="sleepTimerSelect" style="font-weight: bold; color: var(--primary-color);">‚è≤Ô∏è ‡§∏‡•ç‡§≤‡•Ä‡§™ ‡§ü‡§æ‡§á‡§Æ‡§∞:</label>
                        <select id="sleepTimerSelect" onchange="setSleepTimer(this.value)" style="padding: 5px 8px; font-size: 0.9em; background-color: var(--bg-color); color: var(--text-color); border:1px solid var(--border-color); border-radius:4px; cursor:pointer;">
                            <option value="0">‡§¨‡§Ç‡§¶</option>
                            <option value="5">5 ‡§Æ‡§ø‡§®‡§ü</option>
                            <option value="15">15 ‡§Æ‡§ø‡§®‡§ü</option>
                            <option value="30">30 ‡§Æ‡§ø‡§®‡§ü</option>
                            <option value="60">60 ‡§Æ‡§ø‡§®‡§ü</option>
                            <option value="-1">‡§á‡§∏ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡•á ‡§Ö‡§Ç‡§§ ‡§Æ‡•á‡§Ç</option>
                        </select>
                        <button id="cancelSleepTimerBtn" onclick="cancelSleepTimer()" style="display: none; background-color: var(--danger-color); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                        <span id="sleepTimerDisplay" style="margin-left: auto; font-size: 0.9em; font-style: italic;"></span>
                    </div>
                    <div id="lib-article-text-content"></div>
                     <div id="lib-article-tags-container" style="margin-top: 15px;">
                        <h4>‡§ü‡•à‡§ó‡•ç‡§∏:</h4>
                        <div id="lib-article-current-tags" style="margin-bottom:10px;"></div>
                        <div style="display: flex; gap: 5px; align-items:center;">
                            <input type="text" id="lib-new-tag-input" placeholder="‡§®‡§Ø‡§æ ‡§ü‡•à‡§ó ‡§ú‡•ã‡§°‡§º‡•á‡§Ç" style="flex-grow:1; margin-top:0; font-size:0.9em; padding:8px;">
                            <button onclick="addTagToCurrentLibraryArticle()" class="tool-btn-secondary" style="margin-top:0;padding: 8px 12px; font-size: 0.9em;">‡§ü‡•à‡§ó ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="Bookmarks" class="tool-content" style="display:none;">
            <h2>‡§Æ‡•á‡§∞‡•á ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï</h2>
            <div id="bookmarkFolderManagement" style="margin-bottom:15px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                <input type="text" id="newBookmarkFolderName" placeholder="‡§®‡§Ø‡§æ ‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ ‡§®‡§æ‡§Æ" style="width:auto; margin-top:0; flex-grow:1; min-width:150px;">
                <button onclick="createBookmarkFolder()" class="tool-btn-secondary" style="margin-top:0; padding:10px 15px;">‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ ‡§¨‡§®‡§æ‡§è‡§Ç</button>
                <div style="flex-basis:100%; height:0; display:none;" class="folder-break"></div>
                <label for="bookmarkFolderFilter" style="font-size:0.9em;">‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞:</label>
                <select id="bookmarkFolderFilter" onchange="loadBookmarks()" style="width:auto; margin-top:0; padding:10px; flex-grow:1; min-width:150px;">
                    <option value="">‡§∏‡§≠‡•Ä ‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞</option>
                </select>
            </div>
            <div id="bookmarkForm">
                 <div>
                    <input type="text" id="bookmarkName" placeholder="‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)">
                    <input type="url" id="bookmarkUrl" placeholder="‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§ï‡§æ URL">
                 </div>
                 <div style="align-items:center;">
                    <label for="bookmarkAssignFolder" style="font-size:0.9em; margin-right:5px;">‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç:</label>
                    <select id="bookmarkAssignFolder" style="flex-grow:1; padding:10px;">
                        <option value="Default">‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞</option>
                    </select>
                 </div>
                <button class="tool-btn" onclick="addBookmark()">‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>
            </div>
            <div style="margin-top:15px; margin-bottom:15px; display:flex; gap:10px;">
                <button onclick="exportBookmarks()" class="tool-btn-secondary" style="margin-top:0; margin-left:0; font-size:0.9em; padding:8px 12px;">‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
                <input type="file" id="importBookmarksFile" accept=".json" onchange="importBookmarksHandler(event)" style="display:none;">
                <button onclick="document.getElementById('importBookmarksFile').click()" class="tool-btn-secondary" style="margin-top:0; font-size:0.9em; padding:8px 12px;">‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
            <div id="bookmark-list" style="margin-top: 20px;"></div>
        </div>
    </div>
    <button id="backToTopBtn" onclick="scrollToTop()" title="‡§ä‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç">‚¨ÜÔ∏è</button>
    <div id="toast-container"></div>
    
    <!-- ======== SETTINGS MODAL START ======== -->
    <div id="settingsModal" class="settings-modal-overlay">
        <div class="settings-modal-content">
            <div class="settings-modal-header">
                <h2>‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</h2>
                <button class="settings-close-btn" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="settings-modal-body">
                <!-- Appearance Settings -->
                <fieldset>
                    <legend>‡§¶‡§ø‡§ñ‡§æ‡§µ‡§ü (Appearance)</legend>
                    <div class="setting-item">
                        <label>‡§•‡•Ä‡§Æ:</label>
                        <div class="setting-control">
                            <input type="radio" id="theme-light" name="theme_setting" value="light"> <label for="theme-light">‡§≤‡§æ‡§á‡§ü</label>
                            <input type="radio" id="theme-dark" name="theme_setting" value="dark"> <label for="theme-dark">‡§°‡§æ‡§∞‡•ç‡§ï</label>
                            <input type="radio" id="theme-sepia" name="theme_setting" value="sepia"> <label for="theme-sepia">‡§∏‡•á‡§™‡§ø‡§Ø‡§æ</label>
                        </div>
                    </div>
                     <div class="setting-item">
                        <label for="displayModeSetting">‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§Æ‡•ã‡§°:</label>
                        <select id="displayModeSetting" class="setting-control">
                            <option value="image-text">‡§á‡§Æ‡•á‡§ú ‡§î‡§∞ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü</option>
                            <option value="text-only">‡§ï‡•á‡§µ‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü</option>
                        </select>
                    </div>
                </fieldset>

                <!-- Audio TTS Settings -->
                <fieldset>
                    <legend>‡§ë‡§°‡§ø‡§Ø‡•ã (TTS)</legend>
                    <div class="setting-item">
                        <label for="ttsMethodSetting">‡§ë‡§°‡§ø‡§Ø‡•ã ‡§∏‡•ç‡§∞‡•ã‡§§:</label>
                        <select id="ttsMethodSetting" class="setting-control">
                            <option value="stream">Google ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Æ (‡§Ö‡§®‡•Å‡§∂‡§Ç‡§∏‡§ø‡§§)</option>
                            <option value="local">‡§°‡§ø‡§µ‡§æ‡§á‡§∏ TTS (‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§®)</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="ttsRateSetting">‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•Ä ‡§ó‡§§‡§ø:</label>
                        <div class="setting-control range-control">
                            <input type="range" id="ttsRateSetting" min="0.5" max="2" step="0.1" value="1" style="width: 120px;">
                            <span id="ttsRateDisplaySetting" style="min-width: 35px;">1.0x</span>
                        </div>
                    </div>
                    <div id="voiceSelectorContainerSetting" class="setting-item" style="display: none;">
                        <label for="voiceSelectorSetting">‡§Ü‡§µ‡§æ‡§ú‡§º:</label>
                        <select id="voiceSelectorSetting" class="setting-control"></select>
                    </div>
                </fieldset>

                <!-- Data Management Settings -->
                <fieldset>
                    <legend>‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</legend>
                    <div class="setting-item">
                        <label>‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä:</label>
                        <div class="setting-control">
                            <button onclick="exportLibrary()">‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü</button>
                            <button onclick="document.getElementById('importLibraryFile').click()">‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü</button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label>‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï:</label>
                        <div class="setting-control">
                            <button onclick="exportBookmarks()">‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü</button>
                            <button onclick="document.getElementById('importBookmarksFile').click()">‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü</button>
                        </div>
                    </div>
                </fieldset>

                <!-- Danger Zone -->
                <fieldset class="danger-zone">
                    <legend>‡§ñ‡§§‡§∞‡§®‡§æ‡§ï ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ (Danger Zone)</legend>
                    <div class="setting-item">
                        <label>‡§°‡•á‡§ü‡§æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç:</label>
                        <div class="setting-control">
                            <button class="danger-btn" onclick="clearLibraryData()">‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button>
                            <button class="danger-btn" onclick="clearBookmarksData()">‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button>
                        </div>
                    </div>
                     <div class="setting-item">
                        <label>‡§∏‡§¨‡§ï‡•Å‡§õ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç:</label>
                        <div class="setting-control">
                             <button class="danger-btn" onclick="resetAllSettings()">‡§∏‡§≠‡•Ä ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§î‡§∞ ‡§°‡•á‡§ü‡§æ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
                        </div>
                    </div>
                </fieldset>

            </div>
            <div class="settings-modal-footer">
                <button class="tool-btn" style="margin-top:0;" onclick="closeSettingsModal()">‡§π‡•ã ‡§ó‡§Ø‡§æ</button>
            </div>
        </div>
    </div>
    <!-- ======== SETTINGS MODAL END ======== -->

    <script>
    // --- Embedded Service Worker Code ---
    const serviceWorkerCode = `
        self.addEventListener('install', e => e.waitUntil(self.skipWaiting()));
        self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
        self.addEventListener('fetch', e => {
            if (e.request.url.includes('article-proxyy.rockysmail69.workers.dev')) {
                e.respondWith(fetch(e.request));
            }
        });
    `;

    // --- Global Variables & Setup ---
    const MY_PRIVATE_PROXY = 'https://article-proxyy.rockysmail69.workers.dev'; 
    let allStoryLinks = []; let currentLinkIndex = 0; let isLoadingNext = false;
    const speechApiSupported = 'speechSynthesis' in window;
    const mediaSessionSupported = ('mediaSession' in navigator);
    let localSpeechSynth;
    let audioQueue = [], isPlayingStream = false, isPausedStream = false, currentAudioElement = null, currentStreamController = null;
    let localTtsQueue = [], isProcessingLocalQueue = false;
    let wasSpeakingBeforeTabSwitch = false;
    let libraryPlaylist = [], currentPlaylistIndex = -1;
    let navigationHistory = [], currentHistoryIndex = -1, isNavigatingHistory = false;
    let currentDisplayMode = 'image-text'; 
    let isCrawlingPaused = false;
    let sleepTimerId = null, sleepTimerIntervalId = null, sleepTimerEndTime = 0, stopAtArticleEnd = false;
    
    const STORAGE_KEY_THEME = 'articleReaderTheme_s1';
    const STORAGE_KEY_LIBRARY = 'articleReaderLibrary_s7_pro'; 
    const STORAGE_KEY_FONT_SIZE = 'articleReaderFontSize_s1';
    const STORAGE_KEY_LIBRARY_FONT_SIZE = 'articleReaderLibraryFontSize_s1';
    const STORAGE_KEY_TTS_METHOD = 'articleReaderTTSMethod_v1';
    const STORAGE_KEY_TTS_RATE = 'articleReaderTTSRate_v1';
    const STORAGE_KEY_TTS_VOICE = 'articleReaderTTSVoice_v1';
    const STORAGE_KEY_DISPLAY_MODE = 'articleReaderDisplayMode_s1';
    const STORAGE_KEY_BOOKMARKS = 'articleReaderBookmarks_s3'; 
    const STORAGE_KEY_OFFLINE_ARTICLE = 'articleReaderOfflineArticle_s1'; 
    const STORAGE_KEY_AUTOPLAY = 'articleReaderAutoplay_v1';
    
    // --- TTS and MP3 Helper Functions ---
    function createLibraryListenButton(articleData) {
        const listenBtn = document.createElement('button');
        listenBtn.className = 'tool-btn-secondary'; 
        listenBtn.textContent = '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç (‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä)';
        listenBtn.title = '‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∏‡•Å‡§®‡•á‡§Ç';
        listenBtn.setAttribute('data-playing', 'false');
        listenBtn.setAttribute('data-article-url', articleData.url); 
        listenBtn.onclick = () => playTTS(articleData, listenBtn, 'library');
        return listenBtn;
    }

    function createLibraryMp3DownloadButton(articleData) {
        const downloadMp3Btn = document.createElement('button');
        downloadMp3Btn.className = 'tool-btn-secondary';
        downloadMp3Btn.innerHTML = 'üó£Ô∏è MP3 (‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä)';
        downloadMp3Btn.title = '‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡§æ MP3 ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç';
        downloadMp3Btn.onclick = (e) => {
            if (!articleData.textContent) {
                showToast("MP3 ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error"); return;
            }
            downloadTextAsMp3(articleData.textContent, articleData.title || "library_audio", e.currentTarget);
        };
        return downloadMp3Btn;
    }
    
    function resetAllTTSButtons(exceptButton = null) {
        document.querySelectorAll('button[data-playing="true"]').forEach(activeBtn => {
            if (activeBtn !== exceptButton) {
                 const isLibraryButton = activeBtn.textContent.includes('(‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä)') || activeBtn.closest('#lib-article-tts-controls');
                 activeBtn.textContent = isLibraryButton ? '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç (‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä)' : '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç';
                 activeBtn.setAttribute('data-playing', 'false');
            }
        });
    }

    // --- Core Functions ---
    function toggleTheme(themeName) {
        document.body.classList.remove('dark-mode', 'sepia-mode', 'light-mode');
        if (themeName === 'dark') document.body.classList.add('dark-mode');
        else if (themeName === 'sepia') document.body.classList.add('sepia-mode');
        else document.body.classList.add('light-mode'); 
        localStorage.setItem(STORAGE_KEY_THEME, themeName);
    }

    function applySavedTheme() {
        const savedTheme = localStorage.getItem(STORAGE_KEY_THEME) || 'light';
        toggleTheme(savedTheme);
    }

    function openTool(evt, toolName) {
        document.querySelectorAll('.tool-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
        const toolElement = document.getElementById(toolName);
        if (toolElement) toolElement.style.display = 'block';
        
        if (evt && evt.currentTarget) {
           evt.currentTarget.classList.add('active');
        } else if (toolName === 'ArticleExtractor') { 
            const extractorTab = document.querySelector('.tab-link[onclick*="ArticleExtractor"]');
            if (extractorTab) extractorTab.classList.add('active');
        }

        const historyContainer = document.getElementById('internalNavHistoryContainer');
        const toggleCrawlBtn = document.getElementById('toggleCrawlBtn');
        const libArticleView = document.getElementById('library-article-view'); 

        if (toolName === 'MyLibrary' || toolName === 'Bookmarks') {
            if(toolName === 'MyLibrary') { loadLibrary(); populateTagFilter(); }
            if(toolName === 'Bookmarks') { loadBookmarks(); }
            if(historyContainer) historyContainer.style.display = 'none';
            if(toggleCrawlBtn) toggleCrawlBtn.style.display = 'none';
            if(libArticleView && toolName === 'MyLibrary' && libArticleView.dataset.hasContent !== 'true') { 
                 libArticleView.style.display = 'none';
            }
        } else if (toolName === 'ArticleExtractor') {
            if(historyContainer) updateHistoryButtons(); 
        }
    }
    
    async function fetchWithProxy(url) {
        const proxyUrl = `${MY_PRIVATE_PROXY}/?url=${encodeURIComponent(url)}`;
        try {
            const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(20000) });
            if (!response.ok) throw new Error(`‡§™‡•ç‡§∞‡•â‡§ï‡•ç‡§∏‡•Ä ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§ú‡§µ‡§æ‡§¨ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ (‡§∏‡•ç‡§ü‡•á‡§ü‡§∏: ${response.status})`);
            return await response.text();
        } catch (error) {
            if (error.name === 'AbortError' || error.name === 'TimeoutError') {
                throw new Error('‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§Æ‡•á‡§Ç ‡§¨‡§π‡•Å‡§§ ‡§Ö‡§ß‡§ø‡§ï ‡§∏‡§Æ‡§Ø ‡§≤‡§ó‡§æ (‡§ü‡§æ‡§á‡§Æ‡§Ü‡§â‡§ü)‡•§');
            }
            throw error;
        }
    }

    function createStoryElement(article, sourceUrl) {
        const storyId = btoa(encodeURIComponent(sourceUrl));
        const storyDiv = document.createElement('div');
        storyDiv.className = 'single-story';
        storyDiv.id = `story-${storyId}`;
        storyDiv.dataset.textContentForSearch = (article.textContent || "").toLowerCase();
        
        const headerDiv = document.createElement('div'); headerDiv.className = 'story-header';
        const titleH3 = document.createElement('h3'); 
        titleH3.textContent = article.title || "‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç";
        const headerButtons = document.createElement('div'); headerButtons.className = 'header-buttons';

        const listenBtn = document.createElement('button');
        listenBtn.textContent = '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç';
        listenBtn.title = '‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∏‡•Å‡§®‡•á‡§Ç';
        listenBtn.setAttribute('data-playing', 'false');
        listenBtn.onclick = () => playTTS(article, listenBtn, 'extractor');
        headerButtons.appendChild(listenBtn);

        const downloadMp3Btn = document.createElement('button');
        downloadMp3Btn.innerHTML = 'üó£Ô∏è MP3';
        downloadMp3Btn.title = 'MP3 ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç';
        downloadMp3Btn.onclick = (e) => {
            if (!article.textContent) {
                showToast("MP3 ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error"); return;
            }
            downloadTextAsMp3(article.textContent, article.title || "audio", e.currentTarget);
        };
        headerButtons.appendChild(downloadMp3Btn);
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'save-btn';
        saveBtn.innerHTML = isSaved(sourceUrl) ? '‚ù§Ô∏è ‡§∏‡•á‡§µ ‡§π‡•à' : 'ü§ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç';
        saveBtn.title = isSaved(sourceUrl) ? '‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§∏‡•á ‡§π‡§ü‡§æ‡§è‡§Ç' : '‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç';
        if (isSaved(sourceUrl)) saveBtn.classList.add('saved');
        saveBtn.onclick = () => toggleSaveArticle(article, sourceUrl, saveBtn);
        headerButtons.appendChild(saveBtn);

        const copyBtn = document.createElement('button');
        copyBtn.innerHTML = 'üìã ‡§ï‡•â‡§™‡•Ä';
        copyBtn.title = '‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç';
        copyBtn.onclick = async (event) => { 
            if (!article.textContent) {
                showToast("‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error"); return;
            }
             try {
                await navigator.clipboard.writeText(`${article.title || ""}\n\n${article.textContent}`);
                showToast('‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ!', 'success');
                event.currentTarget.innerHTML = '‚úÖ ‡§ï‡•â‡§™‡•Ä ‡§π‡•Å‡§Ü';
                setTimeout(() => { event.currentTarget.innerHTML = 'üìã ‡§ï‡•â‡§™‡•Ä'; }, 2000);
            } catch (err) {
                showToast(`‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤`, 'error');
            }
        };
        headerButtons.appendChild(copyBtn);
        
        const shareUrlBtn = document.createElement('button');
        shareUrlBtn.innerHTML = 'üîó URL ‡§∂‡•á‡§Ø‡§∞'; 
        shareUrlBtn.title = '‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§î‡§∞ URL ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç';
        shareUrlBtn.onclick = () => {
             const shareData = { title: article.title || "‡§è‡§ï ‡§â‡§™‡§Ø‡•ã‡§ó‡•Ä ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤", text: `‡§Ø‡§π ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç: ${article.title || ""}`, url: sourceUrl };
            if (navigator.share) {
                navigator.share(shareData).catch(err => { if (err.name !== 'AbortError') console.error("URL ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", err); });
            } else displayFallbackShareOptions(shareData);
        };
        headerButtons.appendChild(shareUrlBtn);
        
        headerDiv.append(titleH3, headerButtons);
        
        const wordCount = article.textContent ? article.textContent.split(/\s+/).filter(Boolean).length : 0;
        const readingTime = Math.ceil(wordCount / 200);
        const authorP = document.createElement('p');
        authorP.innerHTML = `<em style="font-size: 0.9em;">‡§≤‡•á‡§ñ‡§ï: ${article.byline || '‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç'} | ‡§™‡§¢‡§º‡§®‡•á ‡§ï‡§æ ‡§∏‡§Æ‡§Ø: ~${readingTime} ‡§Æ‡§ø‡§®‡§ü</em>`;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'article-body-content'; 
        if (article.content) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = article.content;
            
            const displayMode = localStorage.getItem(STORAGE_KEY_DISPLAY_MODE) || 'image-text';
            if (displayMode === 'text-only') {
                tempDiv.querySelectorAll('img, figure, picture').forEach(el => el.remove());
            } else {
                tempDiv.querySelectorAll('img').forEach(img => {
                    const originalSrc = img.getAttribute('src') || img.dataset.src;
                    if (originalSrc) {
                        try { img.src = new URL(originalSrc, sourceUrl).href; } catch (e) { console.warn("Invalid image URL:", originalSrc); }
                    }
                    img.loading = 'lazy';
                });
            }

            tempDiv.querySelectorAll('a[href]').forEach(linkElement => { 
                const originalHref = linkElement.getAttribute('href');
                if (originalHref && !originalHref.startsWith('#')) {
                    try {
                        const absoluteUrl = new URL(originalHref, sourceUrl).href;
                        linkElement.style.cssText = 'color: var(--primary-color); text-decoration: underline; cursor: pointer;';
                        linkElement.title = `‡§∞‡•Ä‡§°‡§∞ ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§≤‡•á‡§Ç: ${absoluteUrl.substring(0,70)}...`;
                        linkElement.setAttribute('data-reader-target-url', absoluteUrl);
                        linkElement.href = 'javascript:void(0);'; 
                        linkElement.removeAttribute('target');
                    } catch (e) {
                         linkElement.target = '_blank';
                         linkElement.rel = 'noopener noreferrer';
                    }
                }
            });
            contentDiv.innerHTML = tempDiv.innerHTML; 
        } else {
            contentDiv.innerHTML = "<p><em>‡§á‡§∏ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡§æ ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§</em></p>";
        }
        
        storyDiv.innerHTML = ''; 
        storyDiv.append(headerDiv, authorP, document.createElement('hr'), contentDiv);
        return storyDiv;
    }

    document.addEventListener('click', function(event) { 
        let targetElement = event.target.closest('a[data-reader-target-url]');
        if (targetElement && document.getElementById('ae_result').contains(targetElement)) {
            event.preventDefault(); event.stopPropagation();
            const urlToLoad = targetElement.getAttribute('data-reader-target-url');
            showToast(`‡§Ü‡§Ç‡§§‡§∞‡§ø‡§ï ‡§≤‡§ø‡§Ç‡§ï ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`, 'info');
            document.getElementById('articleUrl').value = urlToLoad;
            document.getElementById('crawlSiteToggle').checked = false;
            if (!isNavigatingHistory) addToHistory(urlToLoad);
            ae_startExtraction(true); window.scrollTo(0,0); 
        }
    });

    async function downloadTextAsMp3(text, filename, btn) { 
        const originalText = btn ? btn.innerHTML : '';
        if (btn) { btn.innerHTML = '‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó...'; btn.disabled = true; }
        showToast('MP3 ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...', 'info');
        const cleanedText = (text || "").replace(/\s+/g, ' ').trim();
        if (!cleanedText) {
            showToast('MP3 ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§', 'error');
            if (btn) { btn.innerHTML = originalText; btn.disabled = false; }
            return;
        }
        const chunks = cleanedText.match(/.{1,180}/g) || [cleanedText];
        const audioBlobs = [];
        try {
            for (let i = 0; i < chunks.length; i++) {
                if (btn) btn.innerHTML = `‡§≠‡§æ‡§ó ${i+1}/${chunks.length}...`;
                const ttsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(chunks[i])}&tl=hi&client=tw-ob`;
                const audioResponse = await fetch(`${MY_PRIVATE_PROXY}/?url=${encodeURIComponent(ttsUrl)}`, { signal: AbortSignal.timeout(20000) });
                if (!audioResponse.ok) throw new Error(`TTS API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø (‡§∏‡•ç‡§ü‡•á‡§ü‡§∏: ${audioResponse.status})`);
                const blob = await audioResponse.blob();
                if (blob.size === 0 || !blob.type.startsWith('audio/')) throw new Error('‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§°‡•á‡§ü‡§æ');
                audioBlobs.push(blob);
            }
            const combinedBlob = new Blob(audioBlobs, { type: 'audio/mpeg' });
            const downloadUrl = URL.createObjectURL(combinedBlob);
            const a = document.createElement('a'); a.href = downloadUrl;
            const safeFilename = (filename || "audio").replace(/[^a-z0-9\u0900-\u097F\s._-]/gi, '_').replace(/\s+/g, '_');
            a.download = `${safeFilename}.mp3`;
            document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(downloadUrl);
            showToast("MP3 ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§∂‡•Å‡§∞‡•Ç!", "success");
        } catch (error) { showToast(`MP3 ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`, 'error', 7000); } 
        finally { if (btn) { btn.innerHTML = originalText; btn.disabled = false; } }
    }

    async function loadNextArticleIfIdle() { if (!isLoadingNext && currentLinkIndex < allStoryLinks.length) await loadNextArticle(); }
    async function loadNextArticle() { const loadingDiv = document.getElementById('ae_loading'); const resultDiv = document.getElementById('ae_result'); if (isLoadingNext || currentLinkIndex >= allStoryLinks.length) { if(loadingDiv) { if (currentLinkIndex >= allStoryLinks.length) { loadingDiv.innerText = "‡§∏‡§≠‡•Ä ‡§ú‡•ç‡§û‡§æ‡§§ ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§è‡•§"; setTimeout(() => { if(loadingDiv) loadingDiv.style.display = 'none'; }, 2000); } } return; } isLoadingNext = true; if (loadingDiv) { loadingDiv.style.display = 'block'; loadingDiv.innerText = `‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ (${currentLinkIndex + 1}/${allStoryLinks.length}) ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`; } try { const link = allStoryLinks[currentLinkIndex]; if (!link) { currentLinkIndex++; isLoadingNext = false; await loadNextArticleIfIdle(); return; } const html = await fetchWithProxy(link); const doc = new DOMParser().parseFromString(html, "text/html"); doc.head.insertAdjacentHTML('beforeend', `<base href="${link}">`); const article = new Readability(doc).parse(); if (article && article.content) { if(resultDiv) resultDiv.appendChild(createStoryElement(article, link)); const shareAllBtn = document.getElementById('shareAllBtn'); if (shareAllBtn) shareAllBtn.style.display = 'inline-block'; if (allStoryLinks.length === 1 || currentLinkIndex === 0) { localStorage.setItem(STORAGE_KEY_OFFLINE_ARTICLE, JSON.stringify({ title: article.title, content: article.content, textContent: article.textContent, byline: article.byline, url: link, savedAt: new Date().toISOString() })); } } else showToast(`‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ "${link.substring(0,30)}..." ‡§∏‡•á ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§®‡§ø‡§ï‡§æ‡§≤ ‡§∏‡§ï‡§æ‡•§`, 'warning'); currentLinkIndex++; } catch (e) { showToast(`‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${e.message}`, 'error'); currentLinkIndex++; } finally { isLoadingNext = false; await loadNextArticleIfIdle(); } }
    function toggleDepthSelector() { document.getElementById('depthSelectorContainer').style.display = document.getElementById('crawlSiteToggle').checked ? 'inline-block' : 'none'; }
    function toggleCrawling() { const btn = document.getElementById('toggleCrawlBtn'); isCrawlingPaused = !isCrawlingPaused; btn.innerHTML = isCrawlingPaused ? '‚ñ∂Ô∏è ‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡§ø‡§ú‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡§∞‡•á‡§Ç' : '‚èπÔ∏è ‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•á‡§Ç'; showToast(isCrawlingPaused ? "‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•Ä ‡§ó‡§à‡•§" : "‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡§ø‡§ú‡•ç‡§Ø‡•Ç‡§Æ ‡§ï‡•Ä ‡§ó‡§à‡•§", "info"); }
    async function ae_startExtraction(isNavigationAction = false) { stopTTS(); const urlInput = document.getElementById('articleUrl').value.trim(); const loadingDiv = document.getElementById('ae_loading'); const resultDiv = document.getElementById('ae_result'); if (!urlInput) { showToast('‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï URL ‡§°‡§æ‡§≤‡•á‡§Ç‡•§', 'error'); return; } let initialUrlObj; try { initialUrlObj = new URL(urlInput); } catch (_) { showToast('‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø URL.', 'error'); return; } if (!isNavigatingHistory && !isNavigationAction) addToHistory(initialUrlObj.href); loadingDiv.style.display = 'block'; resultDiv.innerHTML = ''; allStoryLinks = []; currentLinkIndex = 0; isLoadingNext = false; isCrawlingPaused = false; document.getElementById('toggleCrawlBtn').style.display = 'none'; const shareAllBtn = document.getElementById('shareAllBtn'); if(shareAllBtn) shareAllBtn.style.display = 'none'; const shouldCrawl = !isNavigationAction && document.getElementById('crawlSiteToggle').checked; const crawlDepth = shouldCrawl ? parseInt(document.getElementById('crawlDepth').value, 10) : 0; try { loadingDiv.innerText = "‡§™‡•á‡§ú ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£..."; const initialHtml = await fetchWithProxy(initialUrlObj.href); const initialDoc = new DOMParser().parseFromString(initialHtml, "text/html"); const mainArticle = new Readability(initialDoc.cloneNode(true)).parse(); if (mainArticle && mainArticle.content) { if (!allStoryLinks.includes(initialUrlObj.href)) allStoryLinks.push(initialUrlObj.href); } if (shouldCrawl) { /* ... crawl logic ... */ } if (allStoryLinks.length > 0) { showToast(`${allStoryLinks.length} ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§Æ‡§ø‡§≤‡•á‡•§`, "info"); await loadNextArticleIfIdle(); } else { resultDiv.innerHTML = `<p>‡§ï‡•ã‡§à ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</p>`; loadingDiv.style.display = 'none'; } } catch (error) { resultDiv.innerHTML = `<p>‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}</p>`; showToast(`‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`, 'error'); loadingDiv.style.display = 'none'; } }
    function clearResults() { stopTTS(); document.getElementById('ae_result').innerHTML = ''; document.getElementById('articleUrl').value = ''; allStoryLinks = []; currentLinkIndex = 0; navigationHistory = []; currentHistoryIndex = -1; updateHistoryButtons(); const shareAllBtn = document.getElementById('shareAllBtn'); if(shareAllBtn) shareAllBtn.style.display = 'none'; showToast("‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§∏‡§æ‡§´‡§º‡•§"); }
    function clearUrlInput() { const i = document.getElementById('articleUrl'); i.value = ''; i.focus(); }
    function filterExtractedArticles() { const term = document.getElementById('extractorSearch').value.toLowerCase(); document.querySelectorAll('.single-story').forEach(div => { const text = (div.dataset.textContentForSearch || "") + (div.querySelector('h3')?.textContent || "").toLowerCase(); div.style.display = text.includes(term) ? 'block' : 'none'; }); }
    function clearExtractorSearch() { const i = document.getElementById('extractorSearch'); i.value = ''; filterExtractedArticles(); }
    function getLibrary() { return JSON.parse(localStorage.getItem(STORAGE_KEY_LIBRARY) || '{}'); }
    function saveLibrary(library) { localStorage.setItem(STORAGE_KEY_LIBRARY, JSON.stringify(library)); updateLibraryCount(); populateTagFilter(); if(document.getElementById('MyLibrary').style.display === 'block') loadLibrary(); }
    function isSaved(url) { return !!getLibrary()[btoa(encodeURIComponent(url))]; }
    function toggleSaveArticle(article, url, btn) { const lib = getLibrary(); const id = btoa(encodeURIComponent(url)); if (lib[id]) { delete lib[id]; btn.innerHTML = 'ü§ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç'; btn.classList.remove('saved'); } else { lib[id] = { title: article.title, content: article.content, textContent: article.textContent, byline: article.byline, url: url, savedAt: new Date().toISOString(), tags: [], isRead: false }; btn.innerHTML = '‚ù§Ô∏è ‡§∏‡•á‡§µ ‡§π‡•à'; btn.classList.add('saved'); } saveLibrary(lib); }
    function toggleReadStatus(storyId, articleUrl) { const lib = getLibrary(); if (lib[storyId]) { lib[storyId].isRead = !lib[storyId].isRead; saveLibrary(lib); } }
    function loadLibrary() { const library = getLibrary(); const listDiv = document.getElementById('library-list'); const searchTerm = document.getElementById('librarySearch').value.toLowerCase(); const sortOrder = document.getElementById('librarySort').value; const selectedTag = document.getElementById('libraryTagFilter')?.value || ""; const selectedReadStatus = document.getElementById('libraryReadStatusFilter')?.value || "all"; const clearFiltersBtn = document.getElementById('clearLibraryFiltersBtn'); if (clearFiltersBtn) { clearFiltersBtn.style.display = (searchTerm || selectedTag || selectedReadStatus !== 'all') ? 'inline-block' : 'none'; } let itemsArray = Object.values(library).map(item => ({...item, id: btoa(encodeURIComponent(item.url))})); if (searchTerm) itemsArray = itemsArray.filter(item => item.title?.toLowerCase().includes(searchTerm)); if (selectedTag) itemsArray = itemsArray.filter(item => item.tags?.includes(selectedTag)); if (selectedReadStatus === "read") itemsArray = itemsArray.filter(item => item.isRead === true); else if (selectedReadStatus === "unread") itemsArray = itemsArray.filter(item => !item.isRead); itemsArray.sort((a, b) => { switch (sortOrder) { case 'date_asc': return new Date(a.savedAt) - new Date(b.savedAt); case 'title_asc': return (a.title || "").localeCompare(b.title || "", 'hi'); case 'title_desc': return (b.title || "").localeCompare(a.title || "", 'hi'); default: return new Date(b.savedAt) - new Date(a.savedAt); } }); listDiv.innerHTML = ''; if (itemsArray.length === 0) { listDiv.innerHTML = '<p>‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à ‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</p>'; } else { itemsArray.forEach(itemData => { const itemDiv = document.createElement('div'); itemDiv.className = 'library-item'; itemDiv.id = `lib-item-${itemData.id}`; itemDiv.innerHTML = ` <input type="checkbox" class="playlist-checkbox" data-url="${itemData.url}" onchange="updatePlaylistControls()" title="‡§™‡•ç‡§≤‡•á‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç"> <span class="item-title">${itemData.title || "N/A"}</span> <div class="item-controls"> <span class="read-status-toggle" title="${itemData.isRead ? '‡§Ö‡§™‡§†‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç' : '‡§™‡§¢‡§º‡§æ ‡§ï‡§∞‡•á‡§Ç'}">${itemData.isRead ? '‚úÖ' : 'üìñ'}</span> <button class="delete-btn">‡§π‡§ü‡§æ‡§è‡§Å</button> </div> `; itemDiv.querySelector('.item-title').onclick = () => showSavedArticle(itemData); itemDiv.querySelector('.read-status-toggle').onclick = (e) => { e.stopPropagation(); toggleReadStatus(itemData.id, itemData.url); }; itemDiv.querySelector('.delete-btn').onclick = (e) => { e.stopPropagation(); deleteLibraryItem(itemData.id, itemData.url); }; listDiv.appendChild(itemDiv); }); } updatePlaylistControls(); }
    function deleteLibraryItem(storyId, url) { const lib = getLibrary(); delete lib[storyId]; if (navigator.serviceWorker?.controller) { navigator.serviceWorker.controller.postMessage({ action: 'delete-article-from-cache', url: url }); } saveLibrary(lib); const view = document.getElementById('library-article-view'); if (view && view.dataset.currentArticleUrl === url) { view.style.display = 'none'; view.dataset.hasContent = 'false';} showToast("‡§π‡§ü‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§"); }
    function clearLibraryFilters() { document.getElementById('librarySearch').value = ''; document.getElementById('libraryTagFilter').value = ''; document.getElementById('libraryReadStatusFilter').value = 'all'; loadLibrary(); showToast("‡§∏‡§≠‡•Ä ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§∏‡§æ‡§´‡§º‡•§"); }
    async function showSavedArticle(articleData) { const view = document.getElementById('library-article-view'); const textEl = document.getElementById('lib-article-text-content'); document.getElementById('lib-article-title').textContent = articleData.title; document.getElementById('lib-article-original-url').href = articleData.url; document.getElementById('lib-article-original-url').textContent = articleData.url.substring(0, 60) + '...'; let articleContent = articleData; try { if (navigator.onLine) { const res = await fetch(articleData.url); if(res.ok) articleContent = await res.json(); } } catch(e) {} textEl.textContent = articleContent.textContent || "‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§"; document.getElementById('shareLibArticleBtn').onclick = () => shareLibraryArticle(articleContent); applySavedLibraryFontSize(); displayArticleTags(articleData.url, articleData.tags); const ttsMainButtons = document.querySelector('#lib-article-tts-controls .tts-main-buttons'); ttsMainButtons.innerHTML = ''; ttsMainButtons.appendChild(createLibraryListenButton(articleContent)); ttsMainButtons.appendChild(createLibraryMp3DownloadButton(articleContent)); view.style.display = 'block'; view.dataset.currentArticleUrl = articleData.url; view.dataset.hasContent = 'true'; document.querySelectorAll('.library-item.selected').forEach(el => el.classList.remove('selected')); document.getElementById(`lib-item-${btoa(encodeURIComponent(articleData.url))}`)?.classList.add('selected'); if (!articleData.isRead) toggleReadStatus(btoa(encodeURIComponent(articleData.url)), articleData.url); }
    function populateTagFilter() { const tags = new Set(); Object.values(getLibrary()).forEach(item => item.tags?.forEach(tag => tags.add(tag))); const sel = document.getElementById('libraryTagFilter'); const val = sel.value; sel.innerHTML = '<option value="">‡§∏‡§≠‡•Ä ‡§ü‡•à‡§ó</option>'; Array.from(tags).sort().forEach(tag => sel.innerHTML += `<option value="${tag}">${tag}</option>`); sel.value = val; }
    function displayArticleTags(url, tags) { const div = document.getElementById('lib-article-current-tags'); div.innerHTML = tags?.length ? '' : '<em>‡§ï‡•ã‡§à ‡§ü‡•à‡§ó ‡§®‡§π‡•Ä‡§Ç‡•§</em>'; tags?.forEach(tag => { const span = document.createElement('span'); span.className = 'tag-item'; span.textContent = tag; const btn = document.createElement('button'); btn.className = 'tag-remove-btn'; btn.textContent = '‚úó'; btn.onclick = () => removeTagFromCurrentLibraryArticle(tag); span.appendChild(btn); div.appendChild(span); }); }
    function addTagToCurrentLibraryArticle() { const input = document.getElementById('lib-new-tag-input'); const url = document.getElementById('library-article-view').dataset.currentArticleUrl; const name = input.value.trim().toLowerCase(); if (!url || !name) return; const lib = getLibrary(); const id = btoa(encodeURIComponent(url)); if (lib[id]) { lib[id].tags = lib[id].tags || []; if (!lib[id].tags.includes(name)) { lib[id].tags.push(name); saveLibrary(lib); displayArticleTags(url, lib[id].tags); input.value = ''; } } }
    function removeTagFromCurrentLibraryArticle(tagName) { const url = document.getElementById('library-article-view').dataset.currentArticleUrl; if (!url || !tagName) return; const lib = getLibrary(); const id = btoa(encodeURIComponent(url)); if (lib[id]?.tags) { lib[id].tags = lib[id].tags.filter(t => t !== tagName); saveLibrary(lib); displayArticleTags(url, lib[id].tags); } }
    
    async function copyLibraryArticleText() {
        const textEl = document.getElementById('lib-article-text-content');
        const titleEl = document.getElementById('lib-article-title');
        const urlEl = document.getElementById('lib-article-original-url');
        if (!textEl || !titleEl || !urlEl) { showToast('‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§§‡§§‡•ç‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡•§', 'error'); return; }
        const title = titleEl.textContent || "‡§ï‡•ã‡§à ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§®‡§π‡•Ä‡§Ç";
        const url = urlEl.href || "‡§ï‡•ã‡§à URL ‡§®‡§π‡•Ä‡§Ç";
        const content = textEl.textContent || "";
        if (content.trim() === "") { showToast("‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", 'warning'); return; }
        const textToCopy = `‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï: ${title}\nURL: ${url}\n\n${content}`;
        try {
            if (navigator.clipboard && window.isSecureContext) { await navigator.clipboard.writeText(textToCopy); showToast('‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ï‡•â‡§™‡•Ä ‡§π‡•Å‡§Ü!', 'success'); } 
            else {
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                textArea.style.position = 'fixed';
                textArea.style.top = '-9999px';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§π‡•Å‡§Ü (fallback method)!', 'success');
            }
        } catch (err) { console.error('‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', err); showToast('‡§ï‡•â‡§™‡•Ä ‡§µ‡§ø‡§´‡§≤‡•§ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§®‡•á ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§¶‡•Ä‡•§', 'error'); }
    }
    
    async function shareLibraryArticle(articleData) { let shareText = `‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï: ${articleData.title}\nURL: ${articleData.url}\n\n${articleData.textContent.substring(0, 1500)}...`; const data = { title: articleData.title, text: shareText, url: articleData.url }; if (navigator.share) { try { await navigator.share(data); } catch (e) {} } else displayFallbackShareOptions(data); }
    
    function displayFallbackShareOptions(data, isBulkShare = false) {
        const existingModal = document.querySelector('.fallback-share-modal');
        if (existingModal) existingModal.remove();
        
        const cont = document.createElement('div');
        cont.className = 'fallback-share-modal';
        
        let modalContent = `
            <button class="settings-close-btn" style="float:right; padding:0; line-height:1;" onclick="this.parentElement.remove()">&times;</button>
            <h4>‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç</h4>
            <textarea id="fallback-share-text" readonly>${data.text}</textarea>
            <div style="margin-top: 10px;">
                <button class="tool-btn" style="margin-top:0; background-color:var(--success-color);" onclick="copyFallbackText()">‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç</button>
        `;
        if (!isBulkShare && data.url) {
            modalContent += `
                <a href="mailto:?subject=${encodeURIComponent(data.title)}&body=${encodeURIComponent(data.url)}" class="tool-btn-secondary" style="margin-top:0;">‡§à‡§Æ‡•á‡§≤</a>
                <a href="https://wa.me/?text=${encodeURIComponent(data.title + '\n' + data.url)}" data-action="share/whatsapp/share" target="_blank" class="tool-btn-secondary" style="margin-top:0;">‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™</a>
            `;
        }
        modalContent += `</div>`;
        cont.innerHTML = modalContent;
        document.body.appendChild(cont);
    }

    function copyFallbackText() {
        const textArea = document.getElementById('fallback-share-text');
        if (textArea) {
            textArea.select();
            textArea.setSelectionRange(0, 999999);
            try {
                const successful = document.execCommand('copy');
                if (successful) showToast('‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§ï‡•â‡§™‡•Ä ‡§π‡•Å‡§Ü!', 'success');
                else showToast('‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§', 'error');
            } catch (err) { showToast('‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§', 'error'); }
        }
    }

    function shareAllExtractedArticles() {
        const allStories = document.querySelectorAll('#ae_result .single-story');
        if (allStories.length === 0) { showToast("‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "warning"); return; }
        let combinedText = `‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ - ${allStories.length} ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤‡•ç‡§∏\n========================================\n\n`;
        allStories.forEach((storyDiv, index) => {
            const titleElement = storyDiv.querySelector('h3');
            const contentElement = storyDiv.querySelector('.article-body-content');
            const title = titleElement ? titleElement.textContent.trim() : `‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ${index + 1}`;
            const content = contentElement ? contentElement.textContent.trim() : "‡§ï‡•ã‡§à ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§®‡§π‡•Ä‡§Ç‡•§";
            combinedText += `‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ${index + 1}: ${title}\n----------------------------------------\n${content}\n\n========================================\n\n`;
        });
        displayFallbackShareOptions({ title: `‡§∏‡§≠‡•Ä ${allStories.length} ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤‡•ç‡§∏ ‡§ï‡§æ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂`, text: combinedText }, true);
    }

    function updateLibraryCount() { document.getElementById('library-count').textContent = `(${Object.keys(getLibrary()).length})`; }
    function getBookmarks() { return JSON.parse(localStorage.getItem(STORAGE_KEY_BOOKMARKS) || '[]'); }
    function saveBookmarks(bookmarks) { localStorage.setItem(STORAGE_KEY_BOOKMARKS, JSON.stringify(bookmarks)); updateBookmarkCount(); loadBookmarks(); populateBookmarkFolderSelectors(); }
    function addBookmark() { const nameInput = document.getElementById('bookmarkName'); const urlInput = document.getElementById('bookmarkUrl'); const folderSelect = document.getElementById('bookmarkAssignFolder'); const name = nameInput.value.trim(); const url = urlInput.value.trim(); const folder = folderSelect.value; if (!url) { showToast('‡§ï‡•É‡§™‡§Ø‡§æ URL ‡§°‡§æ‡§≤‡•á‡§Ç', 'error'); return; } const bookmarks = getBookmarks(); bookmarks.push({ name: name || url, url: url, addedAt: new Date().toISOString(), folder: folder }); saveBookmarks(bookmarks); nameInput.value = ''; urlInput.value = ''; showToast('‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ!', 'success'); }
    function loadBookmarks() { const folderFilter = document.getElementById('bookmarkFolderFilter').value; let bookmarks = getBookmarks(); if (folderFilter) { bookmarks = bookmarks.filter(bm => bm.folder === folderFilter); } const list = document.getElementById('bookmark-list'); list.innerHTML = ''; if (bookmarks.length === 0) { list.innerHTML = '<p>‡§ï‡•ã‡§à ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</p>'; } else { bookmarks.forEach((bm, index) => { const div = document.createElement('div'); div.className = 'bookmark-item'; div.innerHTML = `<span class="item-title" title="${bm.url}">${bm.name}</span><button class="delete-btn">‡§π‡§ü‡§æ‡§è‡§Å</button>`; div.querySelector('.item-title').onclick = () => { document.getElementById('articleUrl').value = bm.url; openTool(null, 'ArticleExtractor'); ae_startExtraction(); }; div.querySelector('.delete-btn').onclick = () => { const allBms = getBookmarks(); allBms.splice(allBms.findIndex(b => b.url === bm.url && b.addedAt === bm.addedAt), 1); saveBookmarks(allBms); }; list.appendChild(div); }); } updateBookmarkCount(); }
    function getBookmarkFolders() { const bookmarks = getBookmarks(); const folders = new Set(['Default']); bookmarks.forEach(bm => { if(bm.folder) folders.add(bm.folder) }); return Array.from(folders).sort(); }
    function populateBookmarkFolderSelectors() { const folders = getBookmarkFolders(); const filterSelect = document.getElementById('bookmarkFolderFilter'); const assignSelect = document.getElementById('bookmarkAssignFolder'); const currentFilter = filterSelect.value; const currentAssign = assignSelect.value; filterSelect.innerHTML = '<option value="">‡§∏‡§≠‡•Ä ‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞</option>'; assignSelect.innerHTML = ''; folders.forEach(folder => { filterSelect.innerHTML += `<option value="${folder}">${folder}</option>`; assignSelect.innerHTML += `<option value="${folder}">${folder}</option>`; }); filterSelect.value = currentFilter; assignSelect.value = currentAssign || 'Default'; }
    function createBookmarkFolder() { const nameInput = document.getElementById('newBookmarkFolderName'); const newFolder = nameInput.value.trim(); if (newFolder) { const folders = getBookmarkFolders(); if (!folders.includes(newFolder)) { populateBookmarkFolderSelectors(); document.getElementById('bookmarkFolderFilter').innerHTML += `<option value="${newFolder}">${newFolder}</option>`; document.getElementById('bookmarkAssignFolder').innerHTML += `<option value="${newFolder}">${newFolder}</option>`; showToast(`‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ '${newFolder}' ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ!`, 'success'); nameInput.value = ''; } else { showToast('‡§Ø‡§π ‡§´‡§º‡•ã‡§≤‡•ç‡§°‡§∞ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à‡•§', 'warning'); } } }
    function updateBookmarkCount() { document.getElementById('bookmark-count').textContent = `(${getBookmarks().length})`; }
    function changeFontSize(d) { const el = document.getElementById('ae_result'); let s = parseFloat(window.getComputedStyle(el).fontSize) + d; el.style.fontSize = `${Math.max(10, Math.min(30, s))}px`; }
    function applySavedFontSize() { const size = localStorage.getItem(STORAGE_KEY_FONT_SIZE); if (size) document.getElementById('ae_result').style.fontSize = size; }
    function changeLibraryFontSize(d) { const el = document.getElementById('lib-article-text-content'); let s = parseFloat(window.getComputedStyle(el).fontSize) + d; el.style.fontSize = `${Math.max(10, Math.min(30, s))}px`; localStorage.setItem(STORAGE_KEY_LIBRARY_FONT_SIZE, el.style.fontSize); }
    function applySavedLibraryFontSize() { const size = localStorage.getItem(STORAGE_KEY_LIBRARY_FONT_SIZE); if (size) document.getElementById('lib-article-text-content').style.fontSize = size; }
    function setDisplayMode(m) { currentDisplayMode = m; localStorage.setItem(STORAGE_KEY_DISPLAY_MODE,m); showToast(`‡§°‡§ø‡§∏‡•ç‡§™‡•ç‡§≤‡•á ‡§Æ‡•ã‡§° ‡§¨‡§¶‡§≤‡§æ ‡§ó‡§Ø‡§æ‡•§ ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡•á ‡§™‡§∞ ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã‡§ó‡§æ‡•§`, 'info');}
    function applySavedDisplayMode() { const m=localStorage.getItem(STORAGE_KEY_DISPLAY_MODE)||'image-text'; currentDisplayMode = m; }
    function showToast(msg, type='info', dur=3000, actions=null) { const cont = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `toast-notification ${type}`; t.textContent = msg; if (actions) { const actionsDiv = document.createElement('div'); actionsDiv.className = 'toast-actions'; actions.forEach(action => { const btn = document.createElement('button'); btn.textContent = action.text; btn.onclick = () => { action.callback(); t.remove(); }; actionsDiv.appendChild(btn); }); t.appendChild(actionsDiv); } cont.appendChild(t); setTimeout(() => t.classList.add('show'), 100); setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 500); }, dur); }
    function scrollToTop() { window.scrollTo({top: 0, behavior: 'smooth'}); }
    function addToHistory(url) { if (currentHistoryIndex < navigationHistory.length - 1) navigationHistory = navigationHistory.slice(0, currentHistoryIndex + 1); if (navigationHistory.at(-1) !== url) { navigationHistory.push(url); currentHistoryIndex = navigationHistory.length - 1; } updateHistoryButtons(); }
    function updateHistoryButtons() { const backBtn = document.getElementById('historyBackBtn'); const fwdBtn = document.getElementById('historyForwardBtn'); const cont = document.getElementById('internalNavHistoryContainer'); cont.style.display = document.getElementById('ArticleExtractor').style.display === 'block' && navigationHistory.length > 1 ? 'block' : 'none'; backBtn.disabled = currentHistoryIndex <= 0; fwdBtn.disabled = currentHistoryIndex >= navigationHistory.length - 1; }
    function navigateHistory(dir) { if (isNavigatingHistory) return; isNavigatingHistory = true; const newIndex = currentHistoryIndex + dir; if (newIndex >= 0 && newIndex < navigationHistory.length) { currentHistoryIndex = newIndex; document.getElementById('articleUrl').value = navigationHistory[newIndex]; ae_startExtraction(true).finally(() => isNavigatingHistory = false); } else { isNavigatingHistory = false; } }
    function displayOfflineArticle() { const data = JSON.parse(localStorage.getItem(STORAGE_KEY_OFFLINE_ARTICLE) || 'null'); if (data) { const resultDiv = document.getElementById('ae_result'); resultDiv.innerHTML = ''; resultDiv.appendChild(createStoryElement(data, data.url)); document.getElementById('articleUrl').value = data.url; } }
    function exportData(d,f) { const blob = new Blob([JSON.stringify(d, null, 2)], {type: 'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=f; a.click(); URL.revokeObjectURL(a.href); }
    function exportLibrary() { exportData(getLibrary(), 'library.json'); }
    function exportBookmarks() { exportData(getBookmarks(), 'bookmarks.json'); }
    function importData(e,t,fn) { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); fn(d); showToast(`${t} ‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§∏‡§´‡§≤!`); } catch (err) { showToast('‡§á‡§Ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§µ‡§ø‡§´‡§≤‡•§ ‡§´‡§æ‡§á‡§≤ ‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§ü ‡§ó‡§≤‡§§ ‡§π‡•à‡•§', 'error'); } e.target.value=''; }; r.readAsText(f); }
    function importLibraryHandler(e) { importData(e, '‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä', data => { const merged = {...getLibrary(), ...data}; saveLibrary(merged); }); }
    function importBookmarksHandler(e) { importData(e, '‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï', data => { const existingUrls = new Set(getBookmarks().map(b => b.url)); const newBms = Array.isArray(data) ? data.filter(b => !existingUrls.has(b.url)) : []; saveBookmarks([...getBookmarks(), ...newBms]); }); }
    window.onscroll = () => { const backToTopBtn = document.getElementById('backToTopBtn'); if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) { backToTopBtn.style.display = 'block'; } else { backToTopBtn.style.display = 'none'; } const progressBar = document.getElementById('progress-bar'); const totalHeight = document.documentElement.scrollHeight - window.innerHeight; const progress = (window.scrollY / totalHeight) * 100; progressBar.style.width = `${progress}%`; };
    function performGoogleSearch() { const query = document.getElementById('googleSearchQuery').value; if (query) window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank'); }
    function migrateLibraryData() {}

    // --- NEW/UPDATED UNIVERSAL TTS SYSTEM ---
    function updateTTSControlVisibility() { const method = localStorage.getItem(STORAGE_KEY_TTS_METHOD) || 'stream'; const showVoiceSelector = method === 'local' && speechApiSupported; document.getElementById('libVoiceSelectorContainer').style.display = showVoiceSelector ? 'inline-block' : 'none'; }
    function setTTSMethod(method) { localStorage.setItem(STORAGE_KEY_TTS_METHOD, method); stopTTS(); resetAllTTSButtons(); updateTTSControlVisibility(); showToast(`‡§ë‡§°‡§ø‡§Ø‡•ã ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§Ö‡§¨ ${method === 'stream' ? 'Google ‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Æ' : '‡§°‡§ø‡§µ‡§æ‡§á‡§∏ TTS'} ‡§π‡•à‡•§`, 'success'); }
    function setTTSRate(rate) { const rateValue = parseFloat(rate).toFixed(1); localStorage.setItem(STORAGE_KEY_TTS_RATE, rateValue); document.getElementById('libTtsRateDisplay').textContent = `${rateValue}x`; document.getElementById('libTtsRateSlider').value = rateValue; if (localSpeechSynth && localSpeechSynth.speaking) { stopTTS(); showToast("‡§®‡§à ‡§ó‡§§‡§ø ‡§≤‡§æ‡§ó‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç‡•§", "info"); } if (currentAudioElement) { currentAudioElement.playbackRate = rateValue; } }
    function setTTSVoice(voiceURI) { localStorage.setItem(STORAGE_KEY_TTS_VOICE, voiceURI); document.getElementById('libVoiceSelector').value = voiceURI; document.getElementById('voiceSelectorSetting').value = voiceURI; }
    function populateVoiceSelector() { if (!speechApiSupported) return; const voices = localSpeechSynth.getVoices(); if (voices.length === 0) { console.warn("getVoices() returned an empty array."); return; } const libVoiceSelector = document.getElementById('libVoiceSelector'); const settingsVoiceSelector = document.getElementById('voiceSelectorSetting'); const currentVoice = libVoiceSelector.value; libVoiceSelector.innerHTML = ''; settingsVoiceSelector.innerHTML = ''; const hindiVoices = voices.filter(v => v.lang.toLowerCase().startsWith('hi')); const otherVoices = voices.filter(v => !v.lang.toLowerCase().startsWith('hi')); const createOption = (voice) => `<option value="${voice.voiceURI}">${voice.name} (${voice.lang})</option>`; let optionsHTML = ''; if (hindiVoices.length > 0) { optionsHTML += `<optgroup label="‡§π‡§ø‡§®‡•ç‡§¶‡•Ä">` + hindiVoices.map(createOption).join('') + `</optgroup>`; } if (otherVoices.length > 0) { optionsHTML += `<optgroup label="‡§Ö‡§®‡•ç‡§Ø ‡§≠‡§æ‡§∑‡§æ‡§è‡§Ç">` + otherVoices.map(createOption).join('') + `</optgroup>`; } libVoiceSelector.innerHTML = optionsHTML; settingsVoiceSelector.innerHTML = optionsHTML; const savedVoice = localStorage.getItem(STORAGE_KEY_TTS_VOICE) || currentVoice; if (savedVoice && voices.find(v => v.voiceURI === savedVoice)) { libVoiceSelector.value = savedVoice; settingsVoiceSelector.value = savedVoice; } else if (hindiVoices.length > 0) { libVoiceSelector.value = hindiVoices[0].voiceURI; settingsVoiceSelector.value = hindiVoices[0].voiceURI; } }
    function playTTS(article, btn, context) { updateMediaSession(article); const method = localStorage.getItem(STORAGE_KEY_TTS_METHOD) || 'stream'; if (method === 'local') { playLocalTTS(article, btn, context); } else { playStreamTTS(article, btn, context); } }
    function stopTTS() { if (currentStreamController) { currentStreamController.abort(); currentStreamController = null; } if (currentAudioElement) { currentAudioElement.pause(); currentAudioElement = null; } isPlayingStream = false; isPausedStream = false; audioQueue = []; localTtsQueue = []; isProcessingLocalQueue = false; if (speechApiSupported && localSpeechSynth) { localSpeechSynth.cancel(); } if (mediaSessionSupported) { navigator.mediaSession.playbackState = 'none'; navigator.mediaSession.metadata = null; } }
    function playLocalTTS(article, btn, context) { if (!speechApiSupported || !article.textContent) { showToast("‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§Ø‡§æ ‡§°‡§ø‡§µ‡§æ‡§á‡§∏ TTS ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error"); return; } const isPlaying = btn.getAttribute('data-playing') === 'true'; if (localSpeechSynth.speaking && isPlaying) { localSpeechSynth.pause(); btn.textContent = context === 'library' ? '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç (‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä)' : '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç'; btn.setAttribute('data-playing', 'false'); if (mediaSessionSupported) navigator.mediaSession.playbackState = 'paused'; return; } if (localSpeechSynth.paused && !isPlaying) { localSpeechSynth.resume(); btn.textContent = context === 'library' ? '‚è∏Ô∏è ‡§™‡•â‡§ú‡§º (‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä)' : '‚è∏Ô∏è ‡§™‡•â‡§ú‡§º'; btn.setAttribute('data-playing', 'true'); if (mediaSessionSupported) navigator.mediaSession.playbackState = 'playing'; return; } stopTTS(); resetAllTTSButtons(btn); const fullText = (article.title || "") + ". " + article.textContent; localTtsQueue = fullText.match(/[^.!?]+[.!?]*\s*/g) || [fullText]; if (localTtsQueue.length === 0) { showToast("‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§", 'error'); return; } btn.textContent = context === 'library' ? '‚è∏Ô∏è ‡§™‡•â‡§ú‡§º (‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä)' : '‚è∏Ô∏è ‡§™‡•â‡§ú‡§º'; btn.setAttribute('data-playing', 'true'); if (mediaSessionSupported) navigator.mediaSession.playbackState = 'playing'; processLocalTtsQueue(); }
    function processLocalTtsQueue() { if (localTtsQueue.length === 0) { isProcessingLocalQueue = false; resetAllTTSButtons(); if (stopAtArticleEnd) { showToast("‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡•§ ‡§∏‡•ç‡§≤‡•Ä‡§™ ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§∞‡•ã‡§ï‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§", "info"); cancelSleepTimer(); } else { playNextInPlaylistOrAutoplay(); } return; } if (localSpeechSynth.speaking || localSpeechSynth.pending) { setTimeout(processLocalTtsQueue, 100); return; } isProcessingLocalQueue = true; const chunk = localTtsQueue.shift(); if (!chunk || !chunk.trim()) { processLocalTtsQueue(); return; } const utterance = new SpeechSynthesisUtterance(chunk); const rate = parseFloat(localStorage.getItem(STORAGE_KEY_TTS_RATE) || '1'); const voiceURI = localStorage.getItem(STORAGE_KEY_TTS_VOICE); const voices = localSpeechSynth.getVoices(); if (voices.length === 0) { showToast("‡§Ü‡§µ‡§æ‡§ú‡§º‡•á‡§Ç ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à‡§Ç, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•Å‡§õ ‡§ï‡•ç‡§∑‡§£ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§", "warning"); isProcessingLocalQueue = false; resetAllTTSButtons(); return; } const selectedVoice = voices.find(v => v.voiceURI === voiceURI); utterance.lang = 'hi-IN'; utterance.rate = rate; if (selectedVoice) { utterance.voice = selectedVoice; } utterance.onend = () => { setTimeout(processLocalTtsQueue, 50); }; utterance.onerror = (e) => { if (e.error === 'interrupted') { console.warn("TTS ‡§â‡§ö‡•ç‡§ö‡§æ‡§∞‡§£ ‡§¨‡§æ‡§ß‡§ø‡§§ ‡§π‡•Å‡§Ü (‡§Ø‡§π ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à)‡•§"); return; } console.error("SpeechSynthesisUtterance Error Event:", e); let errorMessage = `‡§°‡§ø‡§µ‡§æ‡§á‡§∏ TTS ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${e.error || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§'}`; if(e.error === 'synthesis-failed') errorMessage += " (‡§Ü‡§µ‡§æ‡§ú‡§º ‡§Ö‡§®‡•Å‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§)"; showToast(errorMessage, 'error', 6000); stopTTS(); resetAllTTSButtons(); }; setTimeout(() => { localSpeechSynth.speak(utterance); }, 10); }
    async function playStreamTTS(article, btn, context) { if (isPlayingStream && !isPausedStream) { isPausedStream = true; if (currentAudioElement) currentAudioElement.pause(); btn.textContent = context === 'library' ? '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç (‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä)' : '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç'; btn.setAttribute('data-playing', 'false'); if (mediaSessionSupported) navigator.mediaSession.playbackState = 'paused'; return; } if (isPausedStream) { isPausedStream = false; if (currentAudioElement) currentAudioElement.play(); btn.textContent = context === 'library' ? '‚è∏Ô∏è ‡§™‡•â‡§ú‡§º (‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä)' : '‚è∏Ô∏è ‡§™‡•â‡§ú‡§º'; btn.setAttribute('data-playing', 'true'); if (mediaSessionSupported) navigator.mediaSession.playbackState = 'playing'; return; } stopTTS(); resetAllTTSButtons(btn); btn.textContent = context === 'library' ? '‚è∏Ô∏è ‡§™‡•â‡§ú‡§º (‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä)' : '‚è∏Ô∏è ‡§™‡•â‡§ú‡§º'; btn.setAttribute('data-playing', 'true'); if (mediaSessionSupported) navigator.mediaSession.playbackState = 'playing'; const fullText = (article.title || "") + ". " + article.textContent; const chunks = fullText.replace(/\s+/g, ' ').trim().match(/.{1,180}/g) || []; if (chunks.length === 0) { showToast("‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error"); resetAllTTSButtons(); return; } currentStreamController = new AbortController(); isPlayingStream = true; isPausedStream = false; audioQueue = chunks.slice(); processAudioQueue(); }
    async function processAudioQueue() { if (audioQueue.length === 0 || !isPlayingStream) { isPlayingStream = false; resetAllTTSButtons(); if (stopAtArticleEnd) { showToast("‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡•§ ‡§∏‡•ç‡§≤‡•Ä‡§™ ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§∞‡•ã‡§ï‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§", "info"); cancelSleepTimer(); } else { playNextInPlaylistOrAutoplay(); } return; } if (isPausedStream) return; const chunk = audioQueue.shift(); try { const ttsUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(chunk)}&tl=hi&client=tw-ob`; const proxyUrl = `${MY_PRIVATE_PROXY}/?url=${encodeURIComponent(ttsUrl)}`; const response = await fetch(proxyUrl, { signal: currentStreamController?.signal }); if (!response.ok) throw new Error(`API Error ${response.status}`); const blob = await response.blob(); if (blob.size === 0) throw new Error("Empty audio data"); const audioUrl = URL.createObjectURL(blob); currentAudioElement = new Audio(audioUrl); currentAudioElement.playbackRate = parseFloat(localStorage.getItem(STORAGE_KEY_TTS_RATE) || '1'); currentAudioElement.play(); currentAudioElement.onended = () => { URL.revokeObjectURL(audioUrl); processAudioQueue(); }; currentAudioElement.onerror = () => { showToast("‡§ë‡§°‡§ø‡§Ø‡•ã ‡§ö‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§", "error"); stopTTS(); resetAllTTSButtons(); } } catch (error) { if (error.name !== 'AbortError') { showToast(`‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§Æ‡§ø‡§Ç‡§ó ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`, 'error'); stopTTS(); resetAllTTSButtons(); } } }
    function applySavedTTSSettings() { const savedRate = localStorage.getItem(STORAGE_KEY_TTS_RATE) || '1.0'; setTTSRate(savedRate); updateTTSControlVisibility(); }
    function setSleepTimer(minutes) { cancelSleepTimer(); if (minutes == 0) return; if (minutes == -1) { stopAtArticleEnd = true; document.getElementById('sleepTimerDisplay').textContent = "‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡•á ‡§Ö‡§Ç‡§§ ‡§Æ‡•á‡§Ç ‡§∞‡•Å‡§ï‡•á‡§ó‡§æ‡•§"; document.getElementById('cancelSleepTimerBtn').style.display = 'inline-block'; showToast("‡§∏‡•ç‡§≤‡•Ä‡§™ ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§∏‡•á‡§ü: ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡•á ‡§Ö‡§Ç‡§§ ‡§Æ‡•á‡§Ç ‡§∞‡•Å‡§ï‡•á‡§ó‡§æ‡•§", "success"); } else { const durationInMs = parseInt(minutes, 10) * 60 * 1000; sleepTimerEndTime = Date.now() + durationInMs; sleepTimerId = setTimeout(() => { showToast("‡§∏‡•ç‡§≤‡•Ä‡§™ ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡•§ ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§∞‡•ã‡§ï‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§", "info"); stopTTS(); resetAllTTSButtons(); cancelSleepTimer(); }, durationInMs); sleepTimerIntervalId = setInterval(updateSleepTimerDisplay, 1000); updateSleepTimerDisplay(); document.getElementById('cancelSleepTimerBtn').style.display = 'inline-block'; showToast(`${minutes} ‡§Æ‡§ø‡§®‡§ü ‡§ï‡§æ ‡§∏‡•ç‡§≤‡•Ä‡§™ ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§`, "success"); } }
    function updateSleepTimerDisplay() { const remainingTime = sleepTimerEndTime - Date.now(); if (remainingTime <= 0) { cancelSleepTimer(); return; } const minutes = Math.floor(remainingTime / 60000); const seconds = Math.floor((remainingTime % 60000) / 1000).toString().padStart(2, '0'); document.getElementById('sleepTimerDisplay').textContent = `‡§¨‡§æ‡§ï‡•Ä ‡§∏‡§Æ‡§Ø: ${minutes}:${seconds}`; }
    function cancelSleepTimer() { if (sleepTimerId) { clearTimeout(sleepTimerId); sleepTimerId = null; } if (sleepTimerIntervalId) { clearInterval(sleepTimerIntervalId); sleepTimerIntervalId = null; } stopAtArticleEnd = false; const timerDisplay = document.getElementById('sleepTimerDisplay'); if (timerDisplay) { timerDisplay.textContent = ""; document.getElementById('sleepTimerSelect').value = "0"; document.getElementById('cancelSleepTimerBtn').style.display = 'none'; } }
    function updatePlaylistControls() { const show = document.querySelectorAll('.playlist-checkbox:checked').length > 0; document.getElementById('playSelectedBtn').style.display = show ? 'inline-block' : 'none'; document.getElementById('createSelectedMp3Btn').style.display = show ? 'inline-block' : 'none'; }
    function playSelectedLibraryItems() { libraryPlaylist = Array.from(document.querySelectorAll('.playlist-checkbox:checked')).map(cb => cb.dataset.url); if (libraryPlaylist.length > 0) { currentPlaylistIndex = 0; playPlaylistItem(currentPlaylistIndex); } }
    async function createSelectedMp3() { const checkboxes = document.querySelectorAll('.playlist-checkbox:checked'); if (checkboxes.length === 0) return; const btn = document.getElementById('createSelectedMp3Btn'); const lib = getLibrary(); let text = ''; checkboxes.forEach(cb => { const articleData = lib[btoa(encodeURIComponent(cb.dataset.url))]; if (articleData) text += `${articleData.title}.\n${articleData.textContent}\n\n`; }); await downloadTextAsMp3(text, 'playlist', btn); }
    function playPlaylistItem(index) { if (index < 0 || index >= libraryPlaylist.length) { currentPlaylistIndex = -1; libraryPlaylist = []; stopTTS(); return; } const url = libraryPlaylist[index]; const articleData = getLibrary()[btoa(encodeURIComponent(url))]; if (articleData) { showSavedArticle(articleData); setTimeout(() => { const listenBtn = document.querySelector('#lib-article-tts-controls .tts-main-buttons button'); if(listenBtn) playTTS(articleData, listenBtn, 'library'); }, 500); } }
    function playNextInPlaylistOrAutoplay() { const isAutoplayOn = document.getElementById('autoPlayNextToggle').checked; if (currentPlaylistIndex !== -1 && currentPlaylistIndex < libraryPlaylist.length - 1) { currentPlaylistIndex++; playPlaylistItem(currentPlaylistIndex); } else if (isAutoplayOn && currentPlaylistIndex === -1) { const currentUrl = document.getElementById('library-article-view').dataset.currentArticleUrl; const allItems = Array.from(document.querySelectorAll('#library-list .library-item .playlist-checkbox')); const currentIndex = allItems.findIndex(cb => cb.dataset.url === currentUrl); if (currentIndex > -1 && currentIndex < allItems.length - 1) { const nextUrl = allItems[currentIndex + 1].dataset.url; const nextArticleData = getLibrary()[btoa(encodeURIComponent(nextUrl))]; if (nextArticleData) { showSavedArticle(nextArticleData); setTimeout(() => { const listenBtn = document.querySelector('#lib-article-tts-controls .tts-main-buttons button'); if(listenBtn) playTTS(nextArticleData, listenBtn, 'library'); }, 500); } } else { showToast('‡§ë‡§ü‡•ã-‡§™‡•ç‡§≤‡•á ‡§∏‡•Ç‡§ö‡•Ä ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡•§', 'info'); } } else { currentPlaylistIndex = -1; libraryPlaylist = []; } }
    function handleAutoPlayToggle(isChecked) { localStorage.setItem(STORAGE_KEY_AUTOPLAY, isChecked); }
    function updateMediaSession(article) { if (!mediaSessionSupported) { return; } if (!article || !article.title) { navigator.mediaSession.metadata = null; navigator.mediaSession.playbackState = 'none'; return; } navigator.mediaSession.metadata = new MediaMetadata({ title: article.title, artist: article.byline || window.location.hostname, album: 'Article Reader Pro', artwork: [{ src: 'https://cdn-icons-png.flaticon.com/512/864/864348.png', sizes: '512x512', type: 'image/png' }] }); navigator.mediaSession.setActionHandler('play', () => { const playButton = document.querySelector('button[data-playing="false"]'); if (playButton) playButton.click(); }); navigator.mediaSession.setActionHandler('pause', () => { const pauseButton = document.querySelector('button[data-playing="true"]'); if (pauseButton) pauseButton.click(); }); }
    const settingsModal = document.getElementById('settingsModal');
    function openSettingsModal() { loadSettingsIntoModal(); settingsModal.style.pointerEvents = 'auto'; settingsModal.classList.add('show'); window.addEventListener('keydown', handleSettingsEscKey); }
    function closeSettingsModal() { settingsModal.classList.remove('show'); setTimeout(() => { settingsModal.style.pointerEvents = 'none'; }, 300); window.removeEventListener('keydown', handleSettingsEscKey); }
    function handleSettingsEscKey(e) { if (e.key === 'Escape') { closeSettingsModal(); } }
    settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) { closeSettingsModal(); } });
    function loadSettingsIntoModal() { const currentTheme = localStorage.getItem(STORAGE_KEY_THEME) || 'light'; document.querySelector(`input[name="theme_setting"][value="${currentTheme}"]`).checked = true; const displayMode = localStorage.getItem(STORAGE_KEY_DISPLAY_MODE) || 'image-text'; document.getElementById('displayModeSetting').value = displayMode; const ttsMethod = localStorage.getItem(STORAGE_KEY_TTS_METHOD) || 'stream'; document.getElementById('ttsMethodSetting').value = ttsMethod; const ttsRate = localStorage.getItem(STORAGE_KEY_TTS_RATE) || '1'; document.getElementById('ttsRateSetting').value = ttsRate; document.getElementById('ttsRateDisplaySetting').textContent = `${parseFloat(ttsRate).toFixed(1)}x`; const voiceContainer = document.getElementById('voiceSelectorContainerSetting'); const voiceSelector = document.getElementById('voiceSelectorSetting'); if (ttsMethod === 'local' && speechApiSupported) { voiceContainer.style.display = 'flex'; const savedVoice = localStorage.getItem(STORAGE_KEY_TTS_VOICE); if (savedVoice) { voiceSelector.value = savedVoice; } } else { voiceContainer.style.display = 'none'; } }
    document.querySelectorAll('input[name="theme_setting"]').forEach(radio => { radio.addEventListener('change', (e) => toggleTheme(e.target.value)); });
    document.getElementById('displayModeSetting').addEventListener('change', (e) => { setDisplayMode(e.target.value); });
    document.getElementById('ttsMethodSetting').addEventListener('change', (e) => { setTTSMethod(e.target.value); loadSettingsIntoModal(); });
    document.getElementById('ttsRateSetting').addEventListener('input', (e) => { setTTSRate(e.target.value); document.getElementById('ttsRateDisplaySetting').textContent = `${parseFloat(e.target.value).toFixed(1)}x`; });
    document.getElementById('voiceSelectorSetting').addEventListener('change', (e) => { setTTSVoice(e.target.value); });
    function clearLibraryData() { if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§Ö‡§™‡§®‡•Ä ‡§™‡•Ç‡§∞‡•Ä ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§µ‡§æ‡§™‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§')) { localStorage.removeItem(STORAGE_KEY_LIBRARY); loadLibrary(); updateLibraryCount(); const view = document.getElementById('library-article-view'); if (view) view.style.display = 'none'; showToast('‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞ ‡§¶‡•Ä ‡§ó‡§à ‡§π‡•à‡•§', 'success'); } }
    function clearBookmarksData() { if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§Ö‡§™‡§®‡•á ‡§∏‡§≠‡•Ä ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§µ‡§æ‡§™‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§')) { localStorage.removeItem(STORAGE_KEY_BOOKMARKS); loadBookmarks(); updateBookmarkCount(); showToast('‡§∏‡§≠‡•Ä ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§π‡•à‡§Ç‡•§', 'success'); } }
    function resetAllSettings() { if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§∏‡§≠‡•Ä ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§î‡§∞ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§™‡§∞ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ü‡§™‡§ï‡•Ä ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§î‡§∞ ‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§∏‡§π‡§ø‡§§ ‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§')) { Object.keys(localStorage).forEach(key => { if (key.startsWith('articleReader')) { localStorage.removeItem(key); } }); showToast('‡§∏‡§≠‡•Ä ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞ ‡§¶‡•Ä ‡§ó‡§à ‡§π‡•à‡§Ç‡•§ ‡§™‡•á‡§ú ‡§∞‡•Ä‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...', 'success', 3000); setTimeout(() => location.reload(), 3000); } }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        migrateLibraryData(); applySavedTheme(); updateLibraryCount(); updateBookmarkCount(); 
        applySavedFontSize(); applySavedLibraryFontSize(); applySavedDisplayMode(); 
        toggleDepthSelector(); populateTagFilter(); populateBookmarkFolderSelectors(); 
        
        if (speechApiSupported) {
            localSpeechSynth = window.speechSynthesis;
            const loadVoices = () => { const voices = localSpeechSynth.getVoices(); if (voices.length > 0) { populateVoiceSelector(); console.log("TTS ‡§Ü‡§µ‡§æ‡§ú‡§º‡•á‡§Ç ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à‡§Ç‡•§", voices); } };
            loadVoices();
            if (localSpeechSynth.onvoiceschanged !== undefined) { localSpeechSynth.onvoiceschanged = loadVoices; }
        }
        
        applySavedTTSSettings();
        const autoPlay = localStorage.getItem(STORAGE_KEY_AUTOPLAY) === 'true';
        if (autoPlay) document.getElementById('autoPlayNextToggle').checked = true;

        document.addEventListener('visibilitychange', () => { if (document.hidden) { wasSpeakingBeforeTabSwitch = isPlayingStream || (localSpeechSynth && localSpeechSynth.speaking); stopTTS(); resetAllTTSButtons(); } });
        const g=document.getElementById('googleSearchQuery');if(g)g.addEventListener('keypress',(e)=>{if(e.key==='Enter'){e.preventDefault();performGoogleSearch();}});
        const p=new URLSearchParams(window.location.search),url=p.get('url'),r=document.getElementById('ae_result'),i=document.getElementById('articleUrl');
        if(url){if(i)i.value=url;ae_startExtraction();}else if(r&&r.innerHTML.trim()==='')displayOfflineArticle();
        const tab=document.querySelector('.tab-link');if(tab&&!url)openTool({currentTarget:tab},'ArticleExtractor');else if(url)openTool({currentTarget:document.querySelector('.tab-link[onclick*="ArticleExtractor"]')},'ArticleExtractor');
        updateHistoryButtons();
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                try {
                    const blob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
                    navigator.serviceWorker.register(URL.createObjectURL(blob))
                        .then(reg => console.log('ServiceWorker registered.'))
                        .catch(err => console.error('ServiceWorker registration failed:', err));
                } catch (e) { console.error('Blob SW creation failed:', e); }
            });
        }
    });
    </script>
</body>
</html>
