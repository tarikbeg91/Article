<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Reader with All Features</title>
    <script src="https://cdn.jsdelivr.net/npm/@mozilla/readability@0.5.0/Readability.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f7f6; --text-color: #333; --container-bg: #ffffff;
            --primary-color: #007bff; --secondary-color: #17a2b8;
            --border-color: #ddd; --danger-color: #dc3545; --success-color: #28a745;
            --font-size-base: 16px; --line-height-base: 1.6;
        }
        .dark-mode {
            --bg-color: #121212; --text-color: #e0e0e0; --container-bg: #1e1e1e;
            --primary-color: #4dabf7; --secondary-color: #4dd0e1;
            --border-color: #444; --danger-color: #e57373; --success-color: #66bb6a;
        }
        .sepia-mode {
            --bg-color: #f4e8c1; --text-color: #5b4636; --container-bg: #fbf0d9;
            --primary-color: #795548; --secondary-color: #8d6e63;
            --border-color: #d7ccc8; --danger-color: #a1887f; --success-color: #7cb342;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            line-height: var(--line-height-base); transition: background-color 0.3s, color 0.3s;
            margin: 0; padding-top: 5px;
        }
        #progress-bar { position: fixed; top: 0; left: 0; height: 5px; background: var(--primary-color); width: 0%; z-index: 9999; transition: width 0.1s; }
        .main-container { max-width: 800px; margin: 20px auto; padding: 20px; background-color: var(--container-bg); border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1, h2, h3 { color: var(--primary-color); }
        .tabs { border-bottom: 2px solid var(--border-color); overflow: hidden; margin-bottom: 20px; display: flex; flex-wrap: wrap; }
        .tab-link { background: transparent; border: none; cursor: pointer; padding: 14px 16px; font-size: 17px; color: var(--text-color); border-bottom: 3px solid transparent; }
        .tab-link.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: bold; }
        input[type="url"], input[type="search"], select { background-color: var(--container-bg); color: var(--text-color); border: 1px solid var(--border-color); width: 100%; padding: 12px; box-sizing: border-box; border-radius: 6px; font-size: 16px; margin-top: 10px; }
        button.tool-btn, .tool-btn-secondary { background-color: var(--primary-color); color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 15px; }
        .tool-btn-secondary { background-color: var(--secondary-color); margin-left: 10px; }
        .result-box { background-color: var(--bg-color); margin-top: 15px; padding: 15px; border-radius: 6px; font-size: var(--font-size-base); }
        .single-story { border-bottom: 2px dashed var(--border-color); padding-bottom: 20px; margin-bottom: 20px; }
        .single-story img { max-width: 100%; height: auto; display: block; margin: 15px auto; border-radius: 8px; }
        .story-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
        .header-buttons { display: flex; gap: 8px; flex-wrap: wrap; align-items: center;}
        .header-buttons button { background-color: var(--secondary-color); color: white; border: none; border-radius: 5px; padding: 6px 12px; font-size: 14px; cursor: pointer; }
        .header-buttons .save-btn.saved { background-color: var(--danger-color); }
        .theme-toggle-container { position: fixed; top: 15px; right: 20px; z-index: 1000; display:flex; gap: 5px;}
        .theme-toggle { background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; display: flex; justify-content: center; align-items: center; }
        #ae_loading { margin-top: 15px; color: var(--primary-color); font-style: italic; text-align: center; }
        .library-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .library-item .delete-btn { background-color: var(--danger-color); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .library-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;}
        .library-controls input[type="search"] { width: auto; flex-grow: 1; margin-top:0;}
        .library-controls select { width: auto; margin-top:0;}

        /* Toast Notification */
        .toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--primary-color); color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10001; font-size: 16px; opacity: 0; transition: opacity 0.5s, bottom 0.5s; }
        .toast-notification.show { opacity: 1; bottom: 30px; }
        .toast-notification.error { background-color: var(--danger-color); }
        .toast-notification.success { background-color: var(--success-color); }

        /* Back to Top Button */
        #backToTopBtn { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 999; background-color: var(--secondary-color); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* Article Settings Panel */
        .article-settings { background-color: var(--container-bg); padding: 10px; margin-bottom: 15px; border-radius: 6px; border: 1px solid var(--border-color); display: flex; flex-wrap: wrap; align-items: center; gap: 15px;}
        .article-settings label { font-size: 0.9em; }
        .article-settings button, .article-settings select { padding: 6px 10px; font-size: 0.9em; background-color: var(--bg-color); color: var(--text-color); border:1px solid var(--border-color); border-radius:4px; cursor:pointer; }
        .article-settings .tts-speed-control { display: flex; align-items: center; gap: 5px; }
        #voiceSelectorContainer { margin-left: 10px; }
    </style>
</head>
<body>
    <div id="progress-bar"></div>
    <div class="theme-toggle-container">
        <button class="theme-toggle" onclick="toggleTheme('light')" title="‡§≤‡§æ‡§á‡§ü ‡§Æ‡•ã‡§°">‚òÄÔ∏è</button>
        <button class="theme-toggle" onclick="toggleTheme('dark')" title="‡§°‡§æ‡§∞‡•ç‡§ï ‡§Æ‡•ã‡§°">üåì</button>
        <button class="theme-toggle" onclick="toggleTheme('sepia')" title="‡§∏‡•á‡§™‡§ø‡§Ø‡§æ ‡§Æ‡•ã‡§°">üìú</button>
    </div>
    <div class="main-container">
        <h1>‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∞‡•Ä‡§°‡§∞</h1>
        <div class="tabs">
            <button class="tab-link active" onclick="openTool(event, 'ArticleExtractor')">‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç</button>
            <button class="tab-link" onclick="openTool(event, 'MyLibrary')">‡§Æ‡•á‡§∞‡•Ä ‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä <span id="library-count">(0)</span></button>
        </div>

        <div id="ArticleExtractor" class="tool-content" style="display:block;">
             <p>‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡§æ ‡§≤‡§ø‡§Ç‡§ï ‡§Ø‡§æ ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§™‡•á‡§ú ‡§ï‡§æ ‡§≤‡§ø‡§Ç‡§ï ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç‡•§</p>
             <input type="url" id="articleUrl" placeholder="https://example.com/some-article">
             <button class="tool-btn" onclick="ae_startExtraction()">‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç</button>
             <button class="tool-btn-secondary" onclick="clearResults()">‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button>
             
             <div id="article-settings-panel" style="display:none; margin-top: 20px;">
                <div class="article-settings">
                    <div>
                        <label for="fontSize">‡§´‡§º‡•â‡§®‡•ç‡§ü ‡§Ü‡§ï‡§æ‡§∞: </label>
                        <button onclick="changeFontSize(-1)" title="‡§´‡§º‡•â‡§®‡•ç‡§ü ‡§ò‡§ü‡§æ‡§è‡§Ç">A-</button>
                        <button onclick="changeFontSize(1)" title="‡§´‡§º‡•â‡§®‡•ç‡§ü ‡§¨‡§¢‡§º‡§æ‡§è‡§Ç">A+</button>
                    </div>
                    <div class="tts-speed-control">
                        <label for="ttsSpeed">‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•Ä ‡§ó‡§§‡§ø: </label>
                        <select id="ttsSpeed" onchange="setSpeechRate(this.value)" title="‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•Ä ‡§ó‡§§‡§ø ‡§¨‡§¶‡§≤‡•á‡§Ç">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1x (‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø)</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                        </select>
                    </div>
                    <div id="voiceSelectorContainer" style="display:none;">
                        <label for="voiceSelector">‡§Ü‡§µ‡§æ‡§ú‡§º ‡§ö‡•Å‡§®‡•á‡§Ç: </label>
                        <select id="voiceSelector" onchange="setSpeechVoice(this.options[this.selectedIndex].getAttribute('data-name'))" title="‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§¨‡§¶‡§≤‡•á‡§Ç"></select>
                    </div>
                </div>
             </div>

             <div id="ae_loading" style="display:none;"></div>
             <div class="result-box" id="ae_result"></div>
        </div>

        <div id="MyLibrary" class="tool-content">
            <h2>‡§∏‡•á‡§µ ‡§ï‡§ø‡§è ‡§ó‡§è ‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤</h2>
            <div class="library-controls">
                <input type="search" id="librarySearch" placeholder="‡§ü‡§æ‡§á‡§ü‡§≤ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç..." oninput="filterLibrary()">
                <select id="librarySort" onchange="loadLibrary()">
                    <option value="date_desc">‡§∏‡§¨‡§∏‡•á ‡§®‡§Ø‡§æ ‡§™‡§π‡§≤‡•á</option>
                    <option value="date_asc">‡§∏‡§¨‡§∏‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§™‡§π‡§≤‡•á</option>
                    <option value="title_asc">‡§ü‡§æ‡§á‡§ü‡§≤ (A-Z)</option>
                    <option value="title_desc">‡§ü‡§æ‡§á‡§ü‡§≤ (Z-A)</option>
                </select>
            </div>
            <div id="library-list"></div>
        </div>
    </div>
    <button id="backToTopBtn" onclick="scrollToTop()" title="‡§ä‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç">‚¨ÜÔ∏è</button>
    <div id="toast-container"></div>
    
    <script>
    // --- Global Variables & Setup ---
    const MY_PRIVATE_PROXY = 'https://article-proxyy.rockysmail69.workers.dev'; // ‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡•â‡§ï‡•ç‡§∏‡•Ä URL ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç
    let allStoryLinks = []; let currentLinkIndex = 0; let isLoadingNext = false;
    const speechApiSupported = 'speechSynthesis' in window;
    let speechSynth, utterance;
    
    if (speechApiSupported) {
        speechSynth = window.speechSynthesis;
        utterance = new SpeechSynthesisUtterance();
        // lang ‡§î‡§∞ voice ‡§ï‡•ã populateVoiceList ‡§Ø‡§æ setSpeechVoice ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ
        utterance.rate = 1; // Default speed
    }

    // --- Core Functions ---
    function toggleTheme(themeName) {
        document.body.classList.remove('dark-mode', 'sepia-mode', 'light-mode');
        if (themeName === 'dark') document.body.classList.add('dark-mode');
        else if (themeName === 'sepia') document.body.classList.add('sepia-mode');
        else document.body.classList.add('light-mode');
        localStorage.setItem('articleReaderTheme', themeName);
    }

    function applySavedTheme() {
        const savedTheme = localStorage.getItem('articleReaderTheme') || 'light';
        toggleTheme(savedTheme);
    }

    function openTool(evt, toolName) {
        document.querySelectorAll('.tool-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
        document.getElementById(toolName).style.display = 'block';
        if (evt && evt.currentTarget) { // Ensure evt.currentTarget exists
           evt.currentTarget.classList.add('active');
        } else if (toolName === 'ArticleExtractor') { // Fallback for programmatic open
            const extractorTab = document.querySelector('.tab-link[onclick*="ArticleExtractor"]');
            if (extractorTab) extractorTab.classList.add('active');
        }


        if (toolName === 'MyLibrary') loadLibrary();
        const articleSettingsPanel = document.getElementById('article-settings-panel');
        if (articleSettingsPanel) {
            articleSettingsPanel.style.display = (toolName === 'ArticleExtractor' && document.getElementById('ae_result').innerHTML.trim() !== '') ? 'flex' : 'none';
        }
    }
    
    async function fetchWithProxy(url) {
        const proxyUrl = `${MY_PRIVATE_PROXY}/?url=${encodeURIComponent(url)}`;
        try {
            const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(25000) });
            if (!response.ok) throw new Error(`‡§™‡•ç‡§∞‡•â‡§ï‡•ç‡§∏‡•Ä ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§ú‡§µ‡§æ‡§¨ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ (‡§∏‡•ç‡§ü‡•á‡§ü‡§∏: ${response.status})`);
            return await response.text();
        } catch (error) {
            if (error.name === 'AbortError') { // AbortSignal.timeout() throws AbortError
                throw new Error('‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§Æ‡•á‡§Ç ‡§¨‡§π‡•Å‡§§ ‡§Ö‡§ß‡§ø‡§ï ‡§∏‡§Æ‡§Ø ‡§≤‡§ó‡§æ (‡§ü‡§æ‡§á‡§Æ‡§Ü‡§â‡§ü)‡•§');
            }
            throw error;
        }
    }

    function createStoryElement(article, sourceUrl) {
        const storyId = btoa(encodeURIComponent(sourceUrl));
        const storyDiv = document.createElement('div');
        storyDiv.className = 'single-story';
        storyDiv.id = `story-${storyId}`;
        
        const headerDiv = document.createElement('div'); headerDiv.className = 'story-header';
        const titleH3 = document.createElement('h3'); titleH3.textContent = article.title;
        const headerButtons = document.createElement('div'); headerButtons.className = 'header-buttons';

        if (speechApiSupported) {
            const listenBtn = document.createElement('button');
            listenBtn.textContent = '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç';
            listenBtn.title = '‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§∏‡•Å‡§®‡•á‡§Ç';
            listenBtn.setAttribute('data-playing', 'false');
            listenBtn.onclick = () => {
                if (!utterance) {
                    showToast("‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•Ä ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§Ö‡§≠‡•Ä ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error");
                    return;
                }
                const isPlaying = listenBtn.getAttribute('data-playing') === 'true';
                if (speechSynth.speaking && isPlaying) {
                    speechSynth.pause();
                    listenBtn.textContent = '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç';
                    listenBtn.setAttribute('data-playing', 'false');
                } else if (speechSynth.paused && !isPlaying) {
                    speechSynth.resume();
                    listenBtn.textContent = '‚è∏Ô∏è ‡§™‡•â‡§ú‡§º ‡§ï‡§∞‡•á‡§Ç';
                    listenBtn.setAttribute('data-playing', 'true');
                } else {
                    speechSynth.cancel();
                    utterance.text = article.title + ". " + article.textContent;
                    // lang ‡§î‡§∞ voice ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§∏‡•á‡§ü ‡§π‡•ã‡§®‡•á ‡§ö‡§æ‡§π‡§ø‡§è
                    speechSynth.speak(utterance);
                    listenBtn.textContent = '‚è∏Ô∏è ‡§™‡•â‡§ú‡§º ‡§ï‡§∞‡•á‡§Ç';
                    listenBtn.setAttribute('data-playing', 'true');
                }
            };
            utterance.onend = () => { 
                listenBtn.textContent = '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç'; 
                listenBtn.setAttribute('data-playing', 'false');
            };
            utterance.onerror = (event) => {
                console.error("SpeechSynthesisUtterance.onerror - Error Type:", event.error);
                let errorMsg = `‡§¨‡•ã‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${event.error}`;
                if (event.error === 'synthesis-failed') {
                    errorMsg = `‡§¨‡•ã‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø (Synthesis Failed): ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§Ü‡§™‡§ï‡•á ‡§°‡§ø‡§µ‡§æ‡§á‡§∏ ‡§™‡§∞ ‡§π‡§ø‡§Ç‡§¶‡•Ä TTS ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§î‡§∞ ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§π‡•à‡•§ ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§`;
                } else if (event.error === 'voice-unavailable') {
                     errorMsg = `‡§ö‡•Å‡§®‡•Ä ‡§ó‡§à ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¶‡•Ç‡§∏‡§∞‡•Ä ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§ö‡•Å‡§®‡•á‡§Ç ‡§Ø‡§æ ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§`;
                }
                showToast(errorMsg, 'error', 7000);
                listenBtn.textContent = '‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•á‡§Ç'; 
                listenBtn.setAttribute('data-playing', 'false');
            };
            headerButtons.appendChild(listenBtn);
        }

        const downloadMp3Btn = document.createElement('button');
        downloadMp3Btn.innerHTML = 'üó£Ô∏è MP3';
        downloadMp3Btn.title = 'MP3 ‡§ë‡§°‡§ø‡§Ø‡•ã ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç';
        downloadMp3Btn.onclick = (e) => downloadTextAsMp3(article.textContent, article.title, e.currentTarget);
        headerButtons.appendChild(downloadMp3Btn);
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'save-btn';
        saveBtn.innerHTML = isSaved(sourceUrl) ? '‚ù§Ô∏è ‡§∏‡•á‡§µ ‡§π‡•à' : 'ü§ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç';
        saveBtn.title = isSaved(sourceUrl) ? '‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§∏‡•á ‡§π‡§ü‡§æ‡§è‡§Ç' : '‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç';
        if (isSaved(sourceUrl)) saveBtn.classList.add('saved');
        saveBtn.onclick = () => toggleSaveArticle(article, sourceUrl, saveBtn);
        headerButtons.appendChild(saveBtn);

        const copyBtn = document.createElement('button');
        copyBtn.innerHTML = 'üìã ‡§ï‡•â‡§™‡•Ä';
        copyBtn.title = '‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ï‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç';
        copyBtn.onclick = async () => {
            try {
                const textToCopy = `${article.title}\n\n${article.textContent}`;
                await navigator.clipboard.writeText(textToCopy);
                showToast('‡§Ü‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ!', 'success');
                copyBtn.innerHTML = '‚úÖ ‡§ï‡•â‡§™‡•Ä ‡§π‡•Å‡§Ü';
                setTimeout(() => { copyBtn.innerHTML = 'üìã ‡§ï‡•â‡§™‡•Ä'; }, 2000);
            } catch (err) {
                console.error('‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', err);
                showToast('‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§', 'error');
            }
        };
        headerButtons.appendChild(copyBtn);
        
        const shareWhatsapp = document.createElement('button');
        shareWhatsapp.innerHTML = 'WhatsApp';
        shareWhatsapp.title = 'WhatsApp ‡§™‡§∞ ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç';
        shareWhatsapp.onclick = () => window.open(`https://wa.me/?text=${encodeURIComponent(article.title + '\n' + sourceUrl)}`, '_blank');
        headerButtons.appendChild(shareWhatsapp);

        headerDiv.append(titleH3, headerButtons);
        
        const wordCount = article.textContent.split(/\s+/).filter(Boolean).length;
        const readingTime = Math.ceil(wordCount / 200);
        const authorP = document.createElement('p');
        authorP.innerHTML = `<em style="font-size: 0.9em;">‡§≤‡•á‡§ñ‡§ï: ${article.byline || '‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç'} | ‡§™‡§¢‡§º‡§®‡•á ‡§ï‡§æ ‡§∏‡§Æ‡§Ø: ~${readingTime} ‡§Æ‡§ø‡§®‡§ü</em>`;
        
        const contentDiv = document.createElement('div');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = article.content;
        const images = tempDiv.querySelectorAll('img');
        images.forEach(img => {
            const originalSrc = img.getAttribute('src') || img.dataset.src; // data-src ‡§≠‡•Ä ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç
            if (originalSrc) {
                try {
                    const absoluteSrc = new URL(originalSrc, sourceUrl).href;
                    img.setAttribute('src', absoluteSrc);
                } catch (e) {
                    console.warn("‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§á‡§Æ‡•á‡§ú URL:", originalSrc, "‡§™‡•á‡§ú ‡§™‡§∞:", sourceUrl);
                }
            }
            img.removeAttribute('loading'); // ‡§≤‡•á‡§ú‡§º‡•Ä ‡§≤‡•ã‡§°‡§ø‡§Ç‡§ó ‡§π‡§ü‡§æ‡§è‡§Å
        });
        contentDiv.innerHTML = tempDiv.innerHTML;
        
        storyDiv.append(headerDiv, authorP, document.createElement('hr'), contentDiv);
        return storyDiv;
    }

    async function downloadTextAsMp3(text, filename, btn) {
        const originalText = btn.innerHTML;
        btn.innerHTML = '‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó...'; btn.disabled = true;
        showToast('MP3 ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...', 'info');

        const cleanedText = text.replace(/\s+/g, ' ').trim();
        if (!cleanedText) {
            showToast('MP3 ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§', 'error');
            btn.innerHTML = originalText; btn.disabled = false;
            return;
        }

        const chunks = cleanedText.match(/.{1,150}/g) || [];
        const audioBlobs = [];
        try {
            if (chunks.length === 0 && cleanedText.length > 0) { // ‡§Ø‡§¶‡§ø ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§õ‡•ã‡§ü‡§æ ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§®
